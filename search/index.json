[{"content":"æ•°æ®å‡†å¤‡ è‚¡ä»·æ•°æ® 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 # stock price conn = duckdb.connect(DB_FILE, read_only=True) stock_price_table_name = \u0026#34;stock_zh_a_hist_m\u0026#34; if MODE == \u0026#34;monthly\u0026#34; else \u0026#34;stock_zh_a_hist_d\u0026#34; stock_price = conn.sql(f\u0026#34;\u0026#34;\u0026#34; select DISTINCT t1.stock_code, t1.date, t1.close price, t2.stock_name, t2.mktcap from {stock_price_table_name} t1 left join stock_individual_info_em t2 on t1.stock_code = t2.stock_code \u0026#34;\u0026#34;\u0026#34;) stock_price_df = calculate_excess_returns(stock_price.to_df()).dropna() è­¦å‘Šï¼šè¿™é‡Œçš„æ•°æ®å…¶å®å­˜åœ¨ä¸€ä¸ªéå¸¸æ˜æ˜¾çš„é—®é¢˜ï¼Œå¸‚å€¼è§„æ¨¡æ•°æ®mktcapæ­£å¸¸æƒ…å†µä¸‹åº”è¯¥ä½¿ç”¨å†å²æ•°æ®ï¼Œ è¿™é‡Œç”¨çš„æ˜¯å½“å‰æ•°æ®ï¼Œ æ‰€ä»¥è¯„ä¼°ç»“æœæœ¬èº«ä¸å…·å¤‡å‚è€ƒä»·å€¼\nå»é™¤å°ç›˜è‚¡æ•°æ® 1 2 3 4 5 6 DROP_RATE = 0.30 small_caps = stock_price_df.sort_values(by=[\u0026#34;stock_code\u0026#34;, \u0026#34;date\u0026#34;]).drop_duplicates(subset=[\u0026#34;stock_code\u0026#34;], keep=\u0026#34;last\u0026#34;).sort_values(by=\u0026#34;mktcap\u0026#34;, ascending=True) small_cap_stocks = small_caps.head(int(len(small_caps) * DROP_RATE)).stock_code stock_price_df = stock_price_df.sort_values(by=[\u0026#34;stock_code\u0026#34;, \u0026#34;date\u0026#34;]).query(\u0026#34;stock_code not in @small_cap_stocks\u0026#34;) be æ•°æ® beä¹Ÿå°±æ˜¯book-equity\n1 2 3 4 5 6 7 8 9 10 11 be = conn.sql(f\u0026#34;\u0026#34;\u0026#34; SELECT DISTINCT stock_code, be, date FROM stock_zcfz_em \u0026#34;\u0026#34;\u0026#34; ) book_equity = be.to_df().query(\u0026#34;stock_code in @stock_price_df[\u0026#39;stock_code\u0026#39;].unique()\u0026#34;) å¸‚å€¼ å°†å¸‚å€¼æ•°æ®æ»åä¸€å‘¨,é˜²æ­¢ look-ahead bias(æˆ‘ä»¬åªèƒ½ç”¨è¾ƒæ—©çš„è´¢åŠ¡æ•°æ® è€Œä¸èƒ½ç”¨æœ€æ–°çš„ å› ä¸ºæœ€æ–°çš„å¾€å¾€åœ¨å½“æ—¶è¿˜æœªå–å¾—)\n1 2 3 4 5 size = (stock_price_df .assign(sorting_date=lambda x: x[\u0026#34;date\u0026#34;]+pd.DateOffset(months=1)) .rename(columns={\u0026#34;mktcap\u0026#34;: \u0026#34;size\u0026#34;}) .get([\u0026#34;stock_code\u0026#34;, \u0026#34;sorting_date\u0026#34;, \u0026#34;size\u0026#34;]) ) ç„¶åè®¡ç®— bm\nbm = book_equity / market_cap ,ç†è®ºä¸Šè¶Šå¤§å…¬å¸å°±è¶Šæœ‰ä»·å€¼\n1 2 3 4 5 6 7 bm = (book_equity .merge(stock_price_df, how=\u0026#34;inner\u0026#34;, on=[\u0026#34;stock_code\u0026#34;, \u0026#34;date\u0026#34;]) .assign(bm=lambda x: x[\u0026#34;be\u0026#34;]/x[\u0026#34;mktcap\u0026#34;], sorting_date=lambda x: x[\u0026#34;date\u0026#34;]+pd.DateOffset(months=6)) .assign(accounting_date=lambda x: x[\u0026#34;sorting_date\u0026#34;]) .get([\u0026#34;stock_code\u0026#34;, \u0026#34;sorting_date\u0026#34;, \u0026#34;accounting_date\u0026#34;, \u0026#34;bm\u0026#34;]) ) åŒæ ·ï¼Œ æˆ‘ä»¬å¯¹æ•°æ®è¿›è¡Œæ»åå¤„ç†ï¼ˆè¿™é‡Œç”¨äº†åŠå¹´å‰çš„æ•°æ®ï¼Œ åŒæ—¶é™å®šè´¢åŠ¡æ•°æ®å¿…é¡»åœ¨ä¸€å¹´ä»¥å†…, ä¸ç„¶æ²¡æœ‰å‚è€ƒä»·å€¼ï¼‰\næ„å»ºå®Œæ•´æ•°æ® 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 data_for_sorts = (stock_price_df .merge(bm, how=\u0026#34;left\u0026#34;, left_on=[\u0026#34;stock_code\u0026#34;, \u0026#34;date\u0026#34;], right_on=[\u0026#34;stock_code\u0026#34;, \u0026#34;sorting_date\u0026#34;]) .merge(size, how=\u0026#34;left\u0026#34;, left_on=[\u0026#34;stock_code\u0026#34;, \u0026#34;date\u0026#34;], right_on=[\u0026#34;stock_code\u0026#34;, \u0026#34;sorting_date\u0026#34;]) .get([\u0026#34;stock_code\u0026#34;, \u0026#34;date\u0026#34;, \u0026#34;ret_excess\u0026#34;, \u0026#34;mktcap\u0026#34;, \u0026#34;size\u0026#34;, \u0026#34;bm\u0026#34;, \u0026#34;accounting_date\u0026#34;]) ) data_for_sorts = (data_for_sorts .sort_values(by=[\u0026#34;stock_code\u0026#34;,\u0026#34;date\u0026#34;]) .groupby([\u0026#34;stock_code\u0026#34;, ]) .apply(lambda x: x.assign( bm=x[\u0026#34;bm\u0026#34;].fillna(method=\u0026#34;ffill\u0026#34;), accounting_date=x[\u0026#34;accounting_date\u0026#34;].fillna(method=\u0026#34;ffill\u0026#34;) ) ) .reset_index(drop=True) .assign(threshold_date = lambda x: (x[\u0026#34;date\u0026#34;]-pd.DateOffset(months=12))) .query(\u0026#34;accounting_date \u0026gt; threshold_date\u0026#34;) # ä¿è¯è´¢åŠ¡æ•°æ®æ˜¯ä¸€å¹´å†…çš„ .drop(columns=[\u0026#34;accounting_date\u0026#34;, \u0026#34;threshold_date\u0026#34;]) .dropna() ) è®¡ç®— SMB å› å­å’Œ HML å› å­ SMB = small - big, è¡¨ç¤ºå°å¸‚å€¼å…¬å¸å’Œå¤§å…¬å¸å¸‚å€¼çš„æ”¶ç›Šå·®å€¼ HML = high - low, è¡¨ç¤ºé«˜ä»·å€¼(é«˜ bm)å’Œä½ bm çš„æ”¶ç›Šå·®å€¼\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 portfolios[\u0026#39;portfolio_size\u0026#39;] = portfolios[\u0026#39;portfolio_size\u0026#39;].astype(int) portfolios[\u0026#39;portfolio_bm\u0026#39;] = portfolios[\u0026#39;portfolio_bm\u0026#39;].astype(int) n_size = portfolios[\u0026#39;portfolio_size\u0026#39;].max() n_bm = portfolios[\u0026#39;portfolio_bm\u0026#39;].max() # SMBï¼ˆå°ç›˜ - å¤§ç›˜ï¼‰ï¼Œé€æ—¥è®¡ç®—ï¼Œå¹¶å¤„ç†ç¼ºå¤±ï¼ˆè‹¥æŸæ—¥æŸä¸€ä¾§ç¼ºå¤±åˆ™ç»“æœä¸º NaNï¼‰ small_ret = portfolios.loc[portfolios[\u0026#39;portfolio_size\u0026#39;] == 1].groupby(\u0026#39;date\u0026#39;)[\u0026#39;ret\u0026#39;].mean() big_ret = portfolios.loc[portfolios[\u0026#39;portfolio_size\u0026#39;] == n_size].groupby(\u0026#39;date\u0026#39;)[\u0026#39;ret\u0026#39;].mean() smb = (small_ret - big_ret).rename(\u0026#39;SMB\u0026#39;).reset_index() # HMLï¼ˆé«˜ BE/ME - ä½ BE/MEï¼‰ high_ret = portfolios.loc[portfolios[\u0026#39;portfolio_bm\u0026#39;] == n_bm].groupby(\u0026#39;date\u0026#39;)[\u0026#39;ret\u0026#39;].mean() low_ret = portfolios.loc[portfolios[\u0026#39;portfolio_bm\u0026#39;] == 1].groupby(\u0026#39;date\u0026#39;)[\u0026#39;ret\u0026#39;].mean() hml = (high_ret - low_ret).rename(\u0026#39;HML\u0026#39;).reset_index() # è‹¥å¸Œæœ›å°† SMB/HML åˆå¹¶æˆä¸€ä¸ª DataFrame factors = smb.merge(hml, on=\u0026#39;date\u0026#39;, how=\u0026#39;outer\u0026#39;) è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨ç‹¬ç«‹æ’åº(æ³¨æ„fama-french 3å› å­æ¨¡å‹ä½¿ç”¨çš„æ˜¯ double sort!)ï¼Œ åˆ†åˆ«è®¡ç®—äº† SMB å’Œ HML\nä¸‹é¢æ˜¯è¿™ä¸¤ä¸ªå› å­å‡å€¼çš„æ±‡æ€»: SMBï¼š -0.004243 HMLï¼š -0.017698\nç„¶ååˆ†åˆ«ä½¿ç”¨æˆªè·é¡¹å›å½’éªŒè¯è¿™ä¸¤ä¸ªå› å­çš„ä½œç”¨\n1 2 3 4 5 6 7 8 9 10 11 import statsmodels.api as sm from regtabletotext import prettify_result model_fit_smb = (sm.OLS.from_formula( formula=\u0026#34;SMB ~ 1\u0026#34;, data=factors ) .fit(cov_type=\u0026#34;HAC\u0026#34;, cov_kwds={\u0026#34;maxlags\u0026#34;: 6}) ) prettify_result(model_fit_smb) 1 2 3 4 5 6 7 model_fit_hml = (sm.OLS.from_formula( formula=\u0026#34;HML ~ 1\u0026#34;, data=factors ) .fit(cov_type=\u0026#34;HAC\u0026#34;, cov_kwds={\u0026#34;maxlags\u0026#34;: 6}) ) prettify_result(model_fit_hml) ä¹Ÿå°±æ˜¯è¯´ï¼Œ è‡³å°‘åœ¨ A è‚¡, SMB ä»¥åŠ HML å¹¶ä¸æ˜¯æ˜¾è‘—æœ‰æ•ˆçš„å› å­\nè®¨è®º åœ¨çŸ³å·çš„\u0026laquo;å› å­æŠ•èµ„\u0026raquo;ä¸­è®ºè¯è¿‡ SMB å’Œ HML è¿™ä¸¤ä¸ªé‡è¦å› å­ï¼Œåœ¨ä¹¦ä¸­è¿™ä¸¤ä¸ªå› å­çš„æ•ˆç”¨è¿˜æ˜¯å¾—åˆ°äº†éªŒè¯;\nä»¥è§„æ¨¡æ•ˆåº”ï¼ˆSMBï¼‰ä¸ºä¾‹ï¼Œ åœ¨çŸ³å·çš„ä¹¦ä¸­ï¼Œå¯¹å°ç›˜è‚¡è¿›è¡Œäº†ç­›é€‰ï¼ˆç”±äº A è‚¡ç‰¹æœ‰çš„å€Ÿå£³ä¸Šå¸‚æœºåˆ¶, å°ç›˜è‚¡ï¼‰å‰”é™¤äº†å¸‚å€¼æœ€å°çš„ 30%çš„è‚¡ç¥¨ï¼Œ å¦å¤–ä»–çš„æ—¶é—´è·¨åº¦æ˜¯ 2000-2020 å¹´. ä¹¦ä¸­ä¹Ÿæåˆ°äº†å† 2015 å¹´ä¹‹å‰è§„æ¨¡å› å­æ˜¯æœ‰æ•ˆçš„ï¼Œ ä½†æ˜¯ä¹‹åSMBæ•ˆæœå°±ä¸å†æ˜æ˜¾ï¼›\nè¿˜æœ‰ä¸€ç‚¹ï¼Œ å‰é¢æˆ‘ä¹Ÿæåˆ°ï¼Œ ç”±äºå†å²å¸‚å€¼è§„æ¨¡çš„ç¼ºå¤±ï¼Œå¯¼è‡´æˆ‘çš„è¯„ä¼°ç»“æœæ²¡æœ‰åŠæ³•çœŸå®åæ˜ å› å­çš„ä½œç”¨ã€‚\nå‚è€ƒ value-and-bivariate-sorts\nå› å­æŠ•èµ„, çŸ³å·\n","date":"2025-11-14T02:16:24Z","permalink":"https://superjcd.github.io/p/%E5%8F%8C%E5%9B%A0%E5%AD%90%E6%8E%92%E5%BA%8F%E5%8F%8A%E5%9B%A0%E5%AD%90%E6%9E%84%E5%BB%BA/","title":"åŒå› å­æ’åºåŠå› å­æ„å»º"},{"content":"æ¦‚è¦ æ‰€æœ‰æ•°æ®æ¥æºäºakshare,å­—æ®µååšäº†ä¿®æ”¹å¹¶è¢«ä¿å­˜åœ¨æ•°æ®åº“ä¸­(duckdb)\nè¿™é‡Œä»‹ç»å¦‚ä½•è®¡ç®— CAPM æ¨¡å‹ä¸­çš„ beta\nå…³äº beta çš„ä»‹ç»ï¼Œ å‚è€ƒ WikipediaBeta (finance)\nbeta æè¿°çš„æ˜¯ä¸€ä¸ªè‚¡ç¥¨çš„æ³¢åŠ¨ç‡ç›¸å¯¹äºå¸‚åœºçš„æ³¢åŠ¨ç‡çš„ä¸€ç§åº¦é‡, æ‰€ä»¥éœ€è¦åŒæ—¶ç”¨åˆ°ä¸ªè‚¡çš„å†å²æ”¶ç›Šæ•°æ®ä»¥åŠå¸‚åœºæ”¶ç›Šæ•°æ®\nè¿™é‡Œçš„æ”¶ç›Šéƒ½æ˜¯ç™¾åˆ†æ¯”å˜åŒ–; å¦å¤–ï¼Œ æˆ‘ä»¬ä½¿ç”¨ä¸Šè¯æŒ‡æ•°çš„ç™¾åˆ†æ¯”å˜åŒ–ä½œä¸ºå¸‚åœºæ”¶ç›Šæ•°æ®\nè®¡ç®— beta çš„æ ¸å¿ƒæ˜¯è®¡ç®—ä¸ªè‚¡è¶…é¢æ”¶ç›Š ~ å¸‚åœºè¶…é¢æ”¶ç›Šçš„è¿™ä¸ª OLS çš„å›å½’ç³»æ•°\næ•°æ®å‡†å¤‡ ä¸ªè‚¡æ”¶ç›Šæ•°æ® 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 stock_price = conn.sql(f\u0026#34;\u0026#34;\u0026#34; select DISTINCT t1.stock_code, t1.date, t1.close price, t2.stock_name, t2.industry fromstock_zh_a_hist_m t1 left join stock_individual_info_em t2 on t1.stock_code = t2.stock_code \u0026#34;\u0026#34;\u0026#34;) def calculate_excess_returns(df, risk_free_rate=0): df = df.sort_values([\u0026#34;stock_code\u0026#34;, \u0026#34;date\u0026#34;]) df[\u0026#34;ret\u0026#34;] = df.groupby(\u0026#34;stock_code\u0026#34;)[\u0026#39;price\u0026#39;].pct_change() df[\u0026#39;ret\u0026#39;] = df.groupby(\u0026#39;stock_code\u0026#39;)[\u0026#39;price\u0026#39;].pct_change() df[\u0026#39;ret_excess\u0026#39;] = df[\u0026#39;ret\u0026#39;] - risk_free_rate return df # Apply the function to add ret_excess column stock_price_df = calculate_excess_returns(stock_price.to_df()) å¸‚åœºæ”¶ç›Šæ•°æ® ä¸Šè¯æŒ‡æ•°\n1 2 3 4 5 6 7 8 market_index_df = conn.sql( f\u0026#34;\u0026#34;\u0026#34; SELECT DISTINCT date, close market_index FROM index_zh_sz_d ORDER BY date \u0026#34;\u0026#34;\u0026#34; ).to_df() market_index_df[\u0026#34;mkt_excess\u0026#34;] = market_index_df[\u0026#34;market_index\u0026#34;].pct_change() æ•´åˆä¸ªè‚¡æ”¶ç›Šæ•°æ®å’Œå¸‚åœºæ”¶ç›Šæ•°æ®\n1 stock_price_with_mkt_excess = stock_price_df.merge(market_index_df, left_on=\u0026#39;date\u0026#39;, right_on=\u0026#39;date\u0026#39;, how=\u0026#39;left\u0026#39;).dropna() å›å½’æ¨¡å‹ å¯¹å•ä¸€è‚¡ç¥¨è®¡ç®— beta(ä»¥ä¸‡ç§‘000002ä¸ºä¾‹)\n1 2 3 4 5 6 7 import statsmodels.formula.api as smf model_fit = smf.ols( formula=\u0026#34;ret_excess ~ mkt_excess\u0026#34;, data=stock_price_with_mkt_excess .query(\u0026#34;stock_code == \u0026#39;000002\u0026#39;\u0026#34;) ).fit() coefficients = model_fit.summary2().tables[1] coefficients è¾“å‡ºç»“æœå¦‚ä¸‹ï¼š\nCoef. Std.Err. t P\u0026gt;|t| [0.025 0.975] Intercept -0.003801 0.006818 -0.557436 5.779298e-01 -0.017255 0.009654 mkt_excess 1.062607 0.127523 8.332703 2.068179e-14 0.810957 1.314258 å¯ä»¥çœ‹åˆ°ä¸‡ç§‘çš„æ”¶ç›Šå’Œå¸‚åœºæ”¶ç›Šï¼ˆ2010 å¹´åˆ° 2025 å¹´é—´çš„æ•°æ®ï¼‰æ˜¯å­˜åœ¨æ˜æ˜¾çš„ç›¸å…³æ€§çš„,ä¸” beta\u0026gt;1\nè¿™é‡Œçš„ Intercept æ˜¯æˆªè·ï¼Œå°±æ˜¯æˆ‘ä»¬é€šå¸¸è¯´çš„ alphaï¼Œ ä¸è¿‡è¿™é‡Œå®ƒå¹¶ä¸æ˜¾è‘—\næ»šåŠ¨çª—å£ ä¸Šé¢æˆ‘ä»¬ä½¿ç”¨äº†æ‰€æœ‰å†å²æ•°æ®è®¡ç®— betaï¼Œä½†æ˜¯æ›´åŠ é€‚åˆçš„æ–¹å¼æ˜¯ä½¿ç”¨æ»šåŠ¨çª—å£ï¼Œæ¯”å¦‚æˆ‘åªç”¨æœ€è¿‘ä¸¤å¹´çš„æ•°æ®æ¥è®¡ç®— betaï¼ˆè¿™æ ·èƒ½æ›´å¥½åœ°åæ˜ å’Œæ•æ‰è‚¡ç¥¨æœ¬èº«å¯¹å¸‚åœºååº”çš„å˜åŒ–ï¼‰\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 def estimate_capm(data, min_obs=1): if data.shape[0] \u0026lt; min_obs: capm = pd.DataFrame() else: fit = smf.ols(formula=\u0026#34;ret_excess ~ mkt_excess\u0026#34;, data=data).fit() coefficients = fit.summary2().tables[1] capm = pd.DataFrame( { \u0026#34;coefficient\u0026#34;: coefficients.index, \u0026#34;estimate\u0026#34;: coefficients[\u0026#34;Coef.\u0026#34;], \u0026#34;t_statistic\u0026#34;: coefficients[\u0026#34;t\u0026#34;], } ).assign( coefficient=lambda x: np.where( x[\u0026#34;coefficient\u0026#34;] == \u0026#34;Intercept\u0026#34;, \u0026#34;alpha\u0026#34;, x[\u0026#34;coefficient\u0026#34;] ) ) return capm def roll_capm_estimation(data, look_back=60, min_obs=48): results = [] dates = data[\u0026#34;date\u0026#34;].sort_values().drop_duplicates() for i in range(look_back - 1, len(dates)): start_date = dates.iloc[i - look_back + 1] end_date = dates.iloc[i] window_data = data.query(\u0026#34;date \u0026gt;= @start_date \u0026amp; date \u0026lt;= @end_date\u0026#34;) result = estimate_capm(window_data) result[\u0026#34;date\u0026#34;] = np.max(window_data[\u0026#34;date\u0026#34;]) results.append(result) if results: rolling_capm_estimation = pd.concat(results, ignore_index=True) else: rolling_capm_estimation = pd.DataFrame() return rolling_capm_estimation estimate_capmä¼šä¸ºæ¯ä¸€ä¸ªæ—¶é—´çª—å£è®¡ç®— CAPM çš„ä¼°è®¡å€¼, roll_capm_estimationåˆ™ä¼šæ‰¹é‡è®¡ç®—å¤šä¸ªæ—¶é—´çª—å£çš„ CAPM ä¼°è®¡å€¼\n1 2 3 4 5 6 7 WINDOW_SIZE = 60 capm = ( stock_price_with_mkt_excess.groupby(\u0026#34;stock_code\u0026#34;ï¼‰ .apply(lambda x: roll_capm_estimation(x, WINDOW_SIZE), include_groups=False) .reset_index() .get([\u0026#34;stock_code\u0026#34;, \u0026#34;date\u0026#34;, \u0026#34;coefficient\u0026#34;, \u0026#34;estimate\u0026#34;, \u0026#34;t_statistic\u0026#34;]) ) å¹¶è¡Œè®¡ç®— ä¸Šé¢çš„æ–¹æ¡ˆçš„é—®é¢˜åœ¨äºé€Ÿåº¦å¤ªæ…¢ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨å¹¶è¡Œè®¡ç®—æ¥æé«˜é€Ÿåº¦ã€‚\næ–¹æ¡ˆ1ï¼šä½¿ç”¨joblib 1 2 3 4 5 6 7 8 9 10 11 12 13 from joblib import Parallel, delayed, cpu_count # å…¨é‡è‚¡ç¥¨æ•°æ® nested_data = stock_price_with_mkt_excess.groupby(\u0026#34;stock_code\u0026#34;, group_keys=True) n_cores = cpu_count() - 1 capm = pd.concat( Parallel(n_jobs=n_cores)( delayed(lambda name, group: roll_capm_estimation(group).assign(stock_code=name))( name, group ) for name, group in nested_data ) ).get([\u0026#34;stock_code\u0026#34;, \u0026#34;date\u0026#34;, \u0026#34;coefficient\u0026#34;, \u0026#34;estimate\u0026#34;, \u0026#34;t_statistic\u0026#34;]) æ–¹æ¡ˆ2ï¼š ä½¿ç”¨ProcessPoolExecutor é™¤äº†ä½¿ç”¨joblibï¼Œè¿˜å¯ä»¥ä½¿ç”¨pythonè‡ªå¸¦çš„ProcessPoolExecutorï¼ˆæ¨èï¼Œæ›´åŠ pythonicï¼‰\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 from concurrent.futures import ProcessPoolExecutor import pandas as pd def process_group(name, group): result = roll_capm_estimation(group) result[\u0026#39;stock_code\u0026#39;] = name return result # ä½¿ç”¨ ProcessPoolExecutor å®ç°å¹¶è¡Œè®¡ç®— with ProcessPoolExecutor(max_workers=n_cores) as executor: futures = [executor.submit(process_group, name, group) for name, group in nested_data] results = [future.result() for future in futures] capm = pd.concat(results).get([\u0026#34;stock_code\u0026#34;, \u0026#34;date\u0026#34;, \u0026#34;coefficient\u0026#34;, \u0026#34;estimate\u0026#34;, \u0026#34;t_statistic\u0026#34;]) æ–¹æ¡ˆ3ï¼šä½¿ç”¨duckdb ç•¥\nä¿å­˜ beta æ•°æ® 1 capm.query(\u0026#34;coefficient == \u0026#39;mkt_excess\u0026#39;\u0026#34;).rename(columns={\u0026#34;estimate\u0026#34;: \u0026#34;beta\u0026#34;}).get([\u0026#34;stock_code\u0026#34;, \u0026#34;date\u0026#34;, \u0026#34;beta\u0026#34;]).to_csv(f\u0026#34;capm_{WINDOW_SIZE}.csv\u0026#34;, index=False) å¯è§†åŒ–åˆ†æ[å¯é€‰] 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 from lets_plot import * plot = ggplot(capm, aes(x=\u0026#34;date\u0026#34;, y=\u0026#34;estimate\u0026#34;, color=\u0026#34;stock_name\u0026#34;)) +\\ geom_line(size=1.5) +\\ labs( x=\u0026#34;\u0026#34;, y=\u0026#34;\u0026#34;, color=\u0026#34;\u0026#34;, linetype=\u0026#34;\u0026#34;, title=\u0026#34;è‚¡ç¥¨æœˆåº¦è´å¡”ç³»æ•°ä¼°è®¡å€¼(5å¹´æ»šåŠ¨çª—å£æ•°æ®)\u0026#34;, ) +\\ ggsize(800, 600) +\\ theme( legend_position=\u0026#34;right\u0026#34;, plot_margin=[10, 30, 0, 0] # Add right margin: [top, right, bottom, left] ) plot å‚è€ƒ beta-estimation\n","date":"2025-11-12T10:07:41Z","permalink":"https://superjcd.github.io/p/%E8%AE%A1%E7%AE%97-a-%E8%82%A1-beta/","title":"è®¡ç®— A è‚¡ beta"},{"content":"Introduction é¦–å…ˆï¼Œä»€ä¹ˆæ˜¯å› å­ï¼Ÿå¯ä»¥ç®€å•åœ°è®¤ä¸ºæ˜¯å½±å“è‚¡ç¥¨æ”¶ç›Šçš„ã€å¯åˆ†æ•£åŒ–é£é™©ä¹‹å¤–çš„ç³»ç»Ÿæ€§é£é™©æ¥æºï¼ˆæˆ–èƒ½è§£é‡Šè‚¡ç¥¨é£é™©æº¢ä»·/å›æŠ¥ç‡çš„å˜é‡)ï¼›\nå½“ç„¶æœ€ç›´è§‚çš„å› å­å°±æ˜¯å¸‚åœºå› å­ï¼Œé€šå¸¸è®¤ä¸ºä¸ªè‚¡çš„é£é™©æº¢ä»·å’Œå¸‚åœºçš„é£é™©æº¢ä»·æ˜¯ç›¸å…³çš„ï¼ˆä¹Ÿå°±æ˜¯è¯´å½“å¤§ç›˜å¥½çš„æ—¶å€™ï¼Œ ä¸ªè‚¡ç†åº”æ˜¯ä¸Šå‡çš„ï¼Œ åªæ˜¯æ¯ä¸ªè‚¡ç¥¨å—å¤§ç›˜å½±å“çš„ç¨‹åº¦å„ä¸ç›¸åŒï¼‰ã€‚\nå½“æˆ‘ä»¬ç¡®å®šäº†æŸä¸ªå› å­çš„å½±å“åŠ›ä¹‹åï¼ˆå› å­çš„å½±å“æ˜¯æ•´ä½“çš„ï¼‰ï¼Œç»“åˆä¸ªè‚¡çš„å› å­æš´éœ²ï¼Œæˆ‘ä»¬å¯ä»¥å›´ç»•å› å­å’Œä¸ªè‚¡çš„å› å­æš´éœ²æ„å»ºæŠ•èµ„ç»„åˆï¼ˆportfolioï¼‰ï¼›\næ¯ä¸ªè‚¡ç¥¨å¯¹å› å­çš„æš´éœ²è‚¯å®šæ˜¯ä¸åŒçš„ï¼Œè¿˜æ˜¯ä»¥å¸‚åœºå› å­ä¸ºä¾‹ï¼Œè™½ç„¶å¤§ç›˜æ¶¨äº†ï¼Œä¸ªè‚¡åº”è¯¥ä¼šæ¶¨ï¼Œ ä½†æ˜¯ä¸åŒç±»å‹çš„è‚¡ç¥¨å—å½±å“ç¨‹åº¦æ˜¯ä¸åŒçš„ï¼Œ æ¯”å¦‚é“¶è¡Œè‚¡ï¼Œ å®ƒå¯¹å¤§ç›˜çš„åæ˜ æ²¡æœ‰é‚£ä¹ˆæ•æ„Ÿï¼Œ ä¹Ÿå°±æ˜¯betaä¼šå°ä¸€äº›\nä½œä¸ºç›´è§‚çš„æ¼”ç¤ºï¼Œä¸Šé¢çš„å›å½’çš„æ–œç‡å°±æ˜¯å› å­çš„å½±å“ï¼ˆå› å­é£é™©æº¢ä»· Î»ï¼‰ï¼Œæ¨ªè½´ä¸Šçš„ beta æ˜¯å› å­æš´éœ²ï¼Œbeta å’Œ lambda å…±åŒå†³å®šäº†é£é™©æº¢ä»·ï¼ˆy è½´ï¼‰çš„å¤§å°ã€‚\né‚£ä¹ˆé™¤äº†å¸‚åœºå› å­ä¹‹å¤–ï¼Œè¿˜æœ‰å“ªäº›å½±å“å› å­å‘¢ï¼Œæˆ–è€…è¯´å¦‚ä½•è§£é‡Šè¿™äº›å› å­çš„å½±å“å‘¢ï¼Œè¿™ä¸ªå°±æ˜¯å› å­æŠ•èµ„æ‰€å…³æ³¨çš„ä¸»é¢˜ã€‚\nå¦‚ä½•æ„å»ºå› å­ é¦–å…ˆæˆ‘ä»¬éœ€è¦è§£å†³ Î» æ˜¯å¤šå°‘çš„é—®é¢˜ï¼Œå¸‚åœºå› å­çš„é£é™©æº¢ä»·ç›¸å¯¹æ¯”è¾ƒå®¹æ˜“å¾—åˆ°ï¼Œå°±æ˜¯æ•´ä¸ªå¸‚åœºçš„æ•´ä½“æ”¶ç›Šï¼Œå½“ç„¶æˆ‘ä»¬å¯ä»¥è°ƒæ•´è¿™ä¸ªæ•´ä½“æ”¶ç›Šçš„èŒƒå›´ï¼Œæ¯”å¦‚å¯ä»¥å»æ‰å¸‚å€¼éå¸¸ä½çš„å°ç›˜è‚¡ç­‰ç­‰ï¼Œç”šè‡³åœ¨å®è·µä¸­ä¹Ÿå¯ä»¥ä½¿ç”¨ç±»ä¼¼æ²ªæ·± 300 ç­‰æŒ‡æ•°çš„è¶…é¢æ”¶ç›Šç‡æ¥ä»£æ›¿ã€‚\nä½†æ˜¯å…¶ä»–å› å­çš„å½±å“å‘¢ï¼Ÿæ¯”å¦‚å…¬å¸çš„è§„æ¨¡ï¼Œæˆ‘ä»¬å¯ä»¥ç›´è§‚åœ°è§‚å¯Ÿåˆ°å°è§„æ¨¡çš„å…¬å¸é£é™©æº¢ä»·ä¼šæ¯”å¤§å‹å…¬å¸é«˜ï¼Œå› ä¸ºå› å­çš„å½±å“æ˜¯ä¸ä¸ªè‚¡æ— å…³çš„ï¼Œæ‰€ä»¥å¯ä»¥å¾ˆç›´è§‰åœ°ä½¿ç”¨æ‰€æœ‰çš„å°è§„æ¨¡å…¬å¸çš„å¹³å‡é£é™©æº¢ä»·å‡å»å¤§è§„æ¨¡å…¬å¸çš„å¹³å‡é£é™©æº¢ä»·æ¥ä½œä¸ºå› å­æ”¶ç›Šï¼ˆå½±å“åŠ›ï¼Œä¹Ÿå°±æ˜¯ä¸Šé¢çš„ Î»ï¼‰çš„ä»£ç†å˜é‡ã€‚ å•ä¸€å› å­çš„æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬åªéœ€è¦æ ¹æ®å…¬å¸çš„è§„æ¨¡è¿›è¡Œå•å˜é‡æ’åºç¡®å®šï¼Œæ ¹æ®æ’åºçš„åˆ†ä½æ•°ï¼Œè§„æ¨¡æœ€å°çš„ 30%ä¸ºå°å‹å…¬å¸ï¼ˆSmallï¼‰ï¼Œè§„æ¨¡æœ€å¤§çš„ 30%ä¸ºå¤§å‹å…¬å¸ï¼ˆBigï¼‰ï¼Œç„¶ååˆ†åˆ«æ„å»ºä¸¤ä¸ª portfolioï¼Œå¹¶è®¡ç®—å®ƒä»¬ä¹‹é—´çš„å¹³å‡æ”¶ç›Šå·®å€¼ä½œä¸ºå› å­æ”¶ç›Šï¼ˆÎ»ï¼‰ã€‚\nå¦‚ä½•éªŒè¯å› å­ å½“æˆ‘ä»¬åŸºäºå› å­æ„å»ºæŠ•èµ„ç»„åˆæ¨¡æ‹Ÿäº†å› å­çš„æ”¶ç›Šç‡ä¹‹åï¼Œè¯¥å¦‚ä½•éªŒè¯å› å­çš„æœ‰æ•ˆæ€§å‘¢ï¼Ÿ æœ‰ä¸¤ç§ä¸»è¦çš„æ–¹æ³•ï¼š\næ£€éªŒå› å­é£é™©æº¢ä»·ï¼šå¯¹å› å­æ”¶ç›Šç‡ï¼ˆT æœŸï¼‰è¿›è¡Œ t å€¼ç»Ÿè®¡ï¼Œçœ‹è¿™ä¸ªå› å­çš„å¹³å‡æ”¶ç›Šç‡æ˜¯ä¸æ˜¯æ˜¾è‘—ä¸ç­‰äº 0ï¼ˆå³æ˜¯å¦å­˜åœ¨é£é™©æº¢ä»·ï¼‰ã€‚ æ£€éªŒå› å­ Î±ï¼šè¿›è¡Œæ—¶é—´åºåˆ—å›å½’ï¼Œçœ‹å› å­ç»„åˆçš„è¶…é¢æ”¶ç›Šæ˜¯å¦èƒ½è¢«ç°æœ‰å·²éªŒè¯çš„å› å­æ¨¡å‹ï¼ˆå¦‚ CAPM æˆ– Fama-French ä¸‰å› å­æ¨¡å‹ï¼‰æ‰€è§£é‡Šã€‚å…·ä½“æ¥è¯´ï¼Œæ˜¯å°†å› å­ç»„åˆçš„è¶…é¢æ”¶ç›Šå¯¹åŸºå‡†æ¨¡å‹ä¸­çš„å› å­è¿›è¡Œå›å½’ï¼Œæ£€éªŒå›å½’çš„æˆªè·é¡¹ Î±æ˜¯å¦æ˜¾è‘—ä¸ç­‰äº 0ã€‚å¦‚æœ Î± æ˜¾è‘—ä¸º 0ï¼Œåˆ™è¡¨æ˜è¯¥å› å­å·²è¢«åŸºå‡†æ¨¡å‹æ‰€è§£é‡Šï¼Œç‹¬ç«‹æœ‰æ•ˆæ€§è¾ƒå¼±ã€‚ è€ƒè™‘åˆ°æ—¶é—´åºåˆ—çš„è‡ªç›¸å…³æ€§ï¼Œt å€¼é€šå¸¸éœ€è¦è¿›è¡Œ Newey-West è°ƒæ•´ã€‚\nFama-MacBeth æ–¹æ³• ä¸šç•Œè¿˜æœ‰ä¸€ç§è¯„ä¼°å› å­æœ‰æ•ˆæ€§çš„æ–¹æ³•ï¼Œå°±æ˜¯ Fama-MacBeth æ–¹æ³•ï¼ˆä¸‹é¢ç®€ç§° FM æ–¹æ³•ï¼‰ã€‚FM æ–¹æ³•æ˜¯ä¸€ç§ä¸¤æ­¥å›å½’çš„æ–¹æ³•ï¼š\né¦–å…ˆè¿›è¡Œæ¨ªæˆªé¢å›å½’ï¼ˆcross-section regression, CSRï¼‰ Yï¼ˆT æœŸçš„ä¸ªè‚¡è¶…é¢æ”¶ç›Šï¼‰~ Xï¼ˆæœŸåˆçš„ä¸ªè‚¡ç‰¹å¾æš´éœ²ï¼Œæ¯”å¦‚ Î²ã€å¸‚å€¼ã€B/Mï¼‰+ æˆªè·é¡¹\nFMå¹¶ä¸éœ€è¦æ„å»º portfolio æ¥è®¡ç®—å› å­çš„æ”¶ç›Šï¼Œè€Œæ˜¯ç›´æ¥ä½¿ç”¨æ¯ä¸ªè‚¡ç¥¨çš„å±æ€§ï¼Œæ¯”å¦‚ B/M, å¸‚å€¼ç­‰ä½œä¸ºå› å­çš„Betaï¼ˆå› å­æš´éœ²ï¼‰ï¼›ç„¶åè®¡ç®—Betaçš„æ–œç‡(è¿™ä¸ªæ–œç‡å¯ä»¥æ¨¡æ‹Ÿå› å­çš„æ•ˆæœ) 2. æ—¶åºèšåˆ æ¯ä¸€æœŸé€šè¿‡æ¨ªæˆªé¢å›å½’å¾—åˆ°äº†Tä¸ªBetaçš„æ–œç‡ï¼ˆcoefficientï¼‰, ç„¶åå°±å¯ä»¥å¯¹æ¯ä¸ªBetaçš„æ–œç‡è¿›è¡Œæ—¶åºèšåˆï¼Œè®¡ç®— t å€¼å’Œ N-W è°ƒæ•´åçš„ t å€¼æ¥éªŒè¯è¿™äº›æ–œç‡çš„æœ‰æ•ˆæ€§ã€‚å¦‚æœè¿™äº›æ–œç‡åœ¨ç»Ÿè®¡ä¸Šæ˜¯æ˜¾è‘—çš„ï¼Œ é‚£ä¹ˆæˆ‘ä»¬å¯ä»¥è®¤ä¸ºBetaå¯¹åº”çš„å› å­æ˜¯æœ‰æ•ˆçš„\n","date":"2025-11-03T06:20:37Z","permalink":"https://superjcd.github.io/p/%E5%9B%A0%E5%AD%90%E6%8A%95%E8%B5%84%E6%A6%82%E8%AE%BA/","title":"å› å­æŠ•èµ„æ¦‚è®º"},{"content":"Compound pattern è¿™ä¸ªæ¨¡å¼çš„å®ƒèƒ½è§£å†³æ€æ ·çš„é—®é¢˜? å…¶å®æ²¡æœ‰è§£å†³ä»€ä¹ˆé—®é¢˜ï¼Œåªæ˜¯æŠŠéœ€è¦å…±ç”¨ç›¸åŒstateçš„ç»„ä»¶ç”¨ä¸€ç§åˆç†çš„æ–¹å¼ç»„åˆåœ¨ä¸€èµ·ç½¢äº†ã€‚\næˆ‘ä»¬å…ˆçœ‹ä¸€ä¸‹ä½¿ç”¨äº†Compoundæ¨¡å¼çš„ç»„ä»¶ä»£ç ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 import React from \u0026#34;react\u0026#34;; import { FlyOut } from \u0026#34;./FlyOut\u0026#34;; export default function FlyoutMenu() { return ( \u0026lt;FlyOut\u0026gt; \u0026lt;FlyOut.Toggle /\u0026gt; \u0026lt;FlyOut.List\u0026gt; \u0026lt;FlyOut.Item\u0026gt;Edit\u0026lt;/FlyOut.Item\u0026gt; \u0026lt;FlyOut.Item\u0026gt;Delete\u0026lt;/FlyOut.Item\u0026gt; \u0026lt;/FlyOut.List\u0026gt; \u0026lt;/FlyOut\u0026gt; ); } è¿™ä¸ªæ¨¡å¼å‡ºç°åœ¨å¾ˆå¤šåœ°æ–¹ï¼Œæ¯”å¦‚Shadcnä¸­çš„ç»„ä»¶ï¼Œä¹Ÿå¤§å¤šæ˜¯åŸºäºå¤šä¸ªæ›´å°çš„ç»„ä»¶ç»„åˆèµ·æ¥çš„ã€‚ ä¸ä¸€å®šéå¾—ä½¿ç”¨Flyout.xxxxæ¥è¡¨ç¤ºå­ç»„ä»¶, ä½†æ˜¯è¿™ç§å‘½åæ–¹å¼æ›´åŠ æ¸…æ™°\nToggleï¼ŒListï¼Œ Itemç»„ä»¶éƒ½å¤ç”¨äº†Flyoutçš„çŠ¶æ€valueã€‚\nFlyoutçš„å®šä¹‰ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 const FlyOutContext = createContext(); function Flyout({children}) { const [value, setValue] = useState(false) \u0026lt;FlyOutContext.Provider value={{value, setValue}}\u0026gt; {chirdren} \u0026lt;/FlyOutContext.Provider\u0026gt; } ç„¶åä»¥Toggleç»„ä»¶ä¸ºä¾‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 Flyout.Toggle = ({chidren}) =\u0026gt; { const {value, setValue} = useContext(FlyOutContext) return ( \u0026lt;div onClick={() =\u0026gt; setVale(!value)}\u0026gt; \u0026lt;Icon /\u0026gt; \u0026lt;/div\u0026gt; ) } å…¶ä»–çš„ç»„ä»¶ä¹Ÿæ˜¯ç”¨ä¸€åŒæ ·çš„æ–¹å¼è·å–åˆ°valueï¼Œ è¿™ä¸ªä¸èµ˜è¿°äº†ï¼›è¿™é‡Œéœ€è¦è¿½åŠ çš„ä¸€ç‚¹çš„æ˜¯ï¼Œ ç»™å¤šä¸ªå­å…ƒç´ ä¼ é€’çŠ¶æ€çš„æ–¹å¼é™¤äº†ä¸Šé¢è¿™ç§ä½¿ç”¨Contextï¼Œ ä¹Ÿå¯ä»¥ç›´æ¥é€šè¿‡éå†React.Childrenç»“åˆReact.cloneElementå‡½æ•°æ¥å®ç°, æ¯”å¦‚ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 export function FlyOut(chilren) { const [value, setValue] = React.useState(false); return ( \u0026lt;div\u0026gt; {React.Children.map(children, child =\u0026gt; React.cloneElement(child, { value, setValue }) )} \u0026lt;/div\u0026gt; ); } HOC ï¼ˆHigh-order componentï¼‰ åŸºç¡€ç¤ºä¾‹ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 import React from \u0026#39;react\u0026#39;; const withAsync = (WrappedComponent, LoadingComponent = () =\u0026gt; \u0026lt;div\u0026gt;Loading...\u0026lt;/div\u0026gt;) =\u0026gt; { return (props) =\u0026gt; { if (props.loading) { return \u0026lt;LoadingComponent {...props} /\u0026gt;; } return \u0026lt;WrappedComponent {...props} /\u0026gt;; }; }; export default withAsync; ä¸Šé¢å±•ç¤ºäº†ä¸€ä¸ªåŸºç¡€çš„HOCç¤ºä¾‹ï¼ŒwithAsnyå‡½æ•°ä¼šæ ¹æ®propsçš„loadingå±æ€§æ¥å†³å®šæ˜¯ä¸æ˜¯è¦æ·»åŠ ä¸€ä¸ªç­‰å¾…çš„è¿‡æ¸¡æ•ˆæœ, å¥½å¤„åœ¨äºé€»è¾‘å¤ç”¨(ç±»ä¼¼äºè£…é¥°å™¨å‡½æ•°)\nå¸¦é€‰é¡¹options 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 import React from \u0026#39;react\u0026#39;; const withAsync = (WrappedComponent, options = {}) =\u0026gt; { const { LoadingComponent = () =\u0026gt; \u0026lt;div\u0026gt;Loading...\u0026lt;/div\u0026gt;, ErrorComponent = ({ error }) =\u0026gt; \u0026lt;div\u0026gt;Error: {error}\u0026lt;/div\u0026gt;, loadingPropName = \u0026#39;loading\u0026#39;, errorPropName = \u0026#39;error\u0026#39; } = options; return (props) =\u0026gt; { if (props[errorPropName]) { return \u0026lt;ErrorComponent error={props[errorPropName]} {...props} /\u0026gt;; } if (props[loadingPropName]) { return \u0026lt;LoadingComponent {...props} /\u0026gt;; } return \u0026lt;WrappedComponent {...props} /\u0026gt;; }; }; export default withAsync; å¸¦optionsçš„HOCï¼Œ å¯ä»¥ç±»æ¯”ä¸ºå¸¦å‚æ•°çš„è£…é¥°å™¨å‡½æ•°, å¯ä»¥æ›´åŠ çµæ´»åœ°å¤„ç†ä¸åŒçš„åº”ç”¨åœºæ™¯\nä½¿ç”¨åœºæ™¯ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 function DataDisplay({ data }) { return \u0026lt;div\u0026gt;{JSON.stringify(data, null, 2)}\u0026lt;/div\u0026gt;; } const EnhancedDataDisplay = withAsync(DataDisplay, { LoadingComponent: Spinner, ErrorComponent: ErrorMessage, loadingPropName: \u0026#39;isFetching\u0026#39;, errorPropName: \u0026#39;fetchError\u0026#39; }); ... return ( \u0026lt;div\u0026gt; \u0026lt;h1\u0026gt;Data Display\u0026lt;/h1\u0026gt; \u0026lt;EnhancedDataDisplay data={state.data} isFetching={state.isFetching} fetchError={state.fetchError} /\u0026gt; \u0026lt;/div\u0026gt; ); typescipt ç‰ˆæœ¬ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 import React from \u0026#39;react\u0026#39;; interface WithAsyncOptions\u0026lt;P = any\u0026gt; { LoadingComponent?: React.ComponentType\u0026lt;P\u0026gt;; ErrorComponent?: React.ComponentType\u0026lt;P \u0026amp; { error: any }\u0026gt;; loadingPropName?: string; errorPropName?: string; } function withAsync\u0026lt;P extends object\u0026gt;( WrappedComponent: React.ComponentType\u0026lt;P\u0026gt;, options: WithAsyncOptions\u0026lt;P\u0026gt; = {} ): React.FC\u0026lt;P\u0026gt; { const { LoadingComponent = () =\u0026gt; \u0026lt;div\u0026gt;Loading...\u0026lt;/div\u0026gt;, ErrorComponent = ({ error }) =\u0026gt; \u0026lt;div\u0026gt;Error: {error}\u0026lt;/div\u0026gt;, loadingPropName = \u0026#39;loading\u0026#39;, errorPropName = \u0026#39;error\u0026#39; } = options; return (props: P \u0026amp; { [key: string]: any }) =\u0026gt; { if (props[errorPropName]) { return \u0026lt;ErrorComponent error={props[errorPropName]} {...props} /\u0026gt;; } if (props[loadingPropName]) { return \u0026lt;LoadingComponent {...props} /\u0026gt;; } return \u0026lt;WrappedComponent {...props} /\u0026gt;; }; } export default withAsync; ç»„åˆå¤šä¸ªHOCæƒ…å†µ composeå‡½æ•°(ç”¨æ¥ç»“åˆå¤šä¸ªHOC):\n1 2 3 4 5 6 7 8 9 const compose = (...hocs) =\u0026gt; (Component) =\u0026gt; hocs.reduceRight( (WrappedComponent, hoc) =\u0026gt; hoc(WrappedComponent), Component ); ä½¿ç”¨composeåœºæ™¯(ç»“åˆcontext)\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 const withUserContext = (WrappedComponent) =\u0026gt; { return (props) =\u0026gt; ( \u0026lt;UserContext.Consumer\u0026gt; {(user) =\u0026gt; \u0026lt;WrappedComponent {...props} user={user} /\u0026gt;} \u0026lt;/UserContext.Consumer\u0026gt; ); }; const EnhancedComponent = compose( withTheme, withLoading, withUserContext )(MyComponent); Render propsæ›¿ä»£HOCåœºæ™¯ è­¬å¦‚å®ç°åŸºäºç™»å½•çŠ¶æ€çš„æ¡ä»¶æ¸²æŸ“ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 function Auth({ children }) { const [user, setUser] = useState(null); useEffect(() =\u0026gt; { checkAuth().then(setUser); }, []); return children({ isAuthenticated: !!user, user }); } // ä½¿ç”¨ \u0026lt;Auth\u0026gt; {({ isAuthenticated, user }) =\u0026gt; isAuthenticated ? \u0026lt;Dashboard user={user} /\u0026gt; : \u0026lt;Login /\u0026gt; } \u0026lt;/Auth\u0026gt; ä½†æ˜¯è¿™é‡Œè¿˜æ˜¯éœ€è¦æ³¨æ„çš„ä¸€ç‚¹åœ¨äºï¼š å’Œå‰é¢çš„HOCçš„æ¡ä»¶æ¸²æŸ“ä¸åŒï¼Œ è¿™é‡Œçš„æ¡ä»¶æ¸²æŸ“äº‹å®ä¸Šæ˜¯åœ¨å­ç»„ä»¶å®ç°çš„(å‰é¢çš„HOCæ˜¯åœ¨Wrapperå‡½æ•°å®ç°çš„)ï¼Œ å¤–éƒ¨çš„Authå‡½æ•°åªæ˜¯æä¾›ç»™Childrenå¿…è¦çš„propsè€Œå·²ï¼› ä½†æ˜¯å¯ä¸å¯ä»¥æŠŠUIé€»è¾‘æ”¾åˆ°Authç»„ä»¶é‡Œï¼Ÿå…¶å®ä¹Ÿæ˜¯å¯ä»¥çš„ï¼›ä½†æ˜¯render propsæ¨¡å¼ä¸€èˆ¬åªæ˜¯æä¾›ç»™childrenå…±äº«çš„çŠ¶æ€(æ¯”å¦‚ä¸Šé¢çš„user)ï¼› å¦å¤–å‡è®¾æœ‰å¤šä¸ªå­ç»„ä»¶è¦å…±ç”¨çŠ¶æ€çš„è¯ï¼Œ å¯ä»¥è€ƒè™‘ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 \u0026lt;Auth\u0026gt; {({ isAuthenticated, user }) =\u0026gt; ( \u0026lt;\u0026gt; {isAuthenticated ? ( \u0026lt;\u0026gt; \u0026lt;Dashboard user={user} /\u0026gt; \u0026lt;Profile user={user} /\u0026gt; \u0026lt;/\u0026gt; ) : ( \u0026lt;\u0026gt; \u0026lt;Login /\u0026gt; \u0026lt;Signup /\u0026gt; \u0026lt;/\u0026gt; )} \u0026lt;/\u0026gt; )} \u0026lt;/Auth\u0026gt; æˆ–è€…ç›´æ¥ä½¿ç”¨Context(è¯¸å¦‚å‰é¢çš„Compundæ¨¡å¼)ï¼Œ contexté€‚åˆæ›´åŠ å¤æ‚ï¼ˆæ¯”å¦‚æ·±åº¦åµŒå¥—ï¼‰çš„çŠ¶æ€å…±äº«\nProps Collection æ¨¡å¼ åŸºç¡€ç”¨æ³• é¼ æ ‡äº¤äº’é€»è¾‘\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 function useMouse() { const [position, setPosition] = useState({ x: 0, y: 0 }); const mouseProps = { onMouseMove: (e) =\u0026gt; setPosition({ x: e.clientX, y: e.clientY }), style: { cursor: \u0026#39;pointer\u0026#39; }, }; return { position, mouseProps, }; } function MouseTracker() { const { position, mouseProps } = useMouse(); return ( \u0026lt;div {...mouseProps}\u0026gt; Mouse position: {position.x}, {position.y} \u0026lt;/div\u0026gt; ); } ç®€å•æ¥è®²Props collectionå°±æ˜¯æŠŠç›¸å…³çš„propsé›†åˆåœ¨äº†ä¸€èµ·ï¼Œ æ¯”å¦‚ä¸Šé¢æ‹¿åˆ°useMouse, æŠŠä½ç½®ç›¸å…³çš„ï¼Œ ä»¥åŠå’Œé¼ æ ‡ä½ç½®ç›¸å…³è”çš„actionç»„åˆåœ¨äº†ä¸€èµ·\nç»“åˆRender Propsæ¨¡å¼ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 function Tooltip({ children, content }) { const [isVisible, setIsVisible] = useState(false); const tooltipProps = { onMouseEnter: () =\u0026gt; setIsVisible(true), onMouseLeave: () =\u0026gt; setIsVisible(false), }; return children({ isVisible, tooltipProps, }); } function App() { return ( \u0026lt;Tooltip content=\u0026#34;This is a tooltip\u0026#34;\u0026gt; {({ isVisible, tooltipProps }) =\u0026gt; ( \u0026lt;div\u0026gt; \u0026lt;button {...tooltipProps}\u0026gt;Hover me\u0026lt;/button\u0026gt; {isVisible \u0026amp;\u0026amp; \u0026lt;div className=\u0026#34;tooltip\u0026#34;\u0026gt;Tooltip content\u0026lt;/div\u0026gt;} \u0026lt;/div\u0026gt; )} \u0026lt;/Tooltip\u0026gt; ); } ä½¿ç”¨å¤šç§Propsé›†åˆ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 function useHover() { const [isHovered, setIsHovered] = useState(false); const hoverProps = { onMouseEnter: () =\u0026gt; setIsHovered(true), onMouseLeave: () =\u0026gt; setIsHovered(false), }; return { isHovered, hoverProps, }; } function useFocus() { const [isFocused, setIsFocused] = useState(false); const focusProps = { onFocus: () =\u0026gt; setIsFocused(true), onBlur: () =\u0026gt; setIsFocused(false), }; return { isFocused, focusProps, }; } function Button() { const { isHovered, hoverProps } = useHover(); const { isFocused, focusProps } = useFocus(); return ( \u0026lt;button {...hoverProps} {...focusProps} style={{ backgroundColor: isHovered ? \u0026#39;lightblue\u0026#39; : \u0026#39;white\u0026#39;, borderColor: isFocused ? \u0026#39;blue\u0026#39; : \u0026#39;gray\u0026#39;, }} \u0026gt; Interactive Button \u0026lt;/button\u0026gt; ); } Props Getter æ¨¡å¼ ä¸ç›´æ¥è¿”å›Propså¯¹è±¡ï¼Œ è€Œæ˜¯è¯´åˆ©ç”¨é—­åŒ…è¿”å›å¯ä»¥ç”ŸæˆPropsçš„å‡½æ•°ï¼Œ è¿™æ ·åœ¨åç»­ä½¿ç”¨ä¸­å¯ä»¥æ›´åŠ çµæ´»\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 function useToggle(initialOn = false) { const [on, setOn] = useState(initialOn); const toggle = () =\u0026gt; setOn(!on); // Props Getter å‡½æ•° const getTogglerProps = ({ onClick, ...props } = {}) =\u0026gt; ({ \u0026#39;aria-pressed\u0026#39;: on, onClick: () =\u0026gt; { toggle(); onClick?.(); }, ...props, }); return { on, toggle, getTogglerProps, }; } function App() { const { on, getTogglerProps } = useToggle(); return ( \u0026lt;div\u0026gt; \u0026lt;button {...getTogglerProps({ onClick: () =\u0026gt; console.log(\u0026#39;Button clicked\u0026#39;), className: \u0026#39;my-button\u0026#39;, })} \u0026gt; {on ? \u0026#39;ON\u0026#39; : \u0026#39;OFF\u0026#39;} \u0026lt;/button\u0026gt; \u0026lt;/div\u0026gt; ); } State Reduceræ¨¡å¼ State Reducer æ¨¡å¼çš„æ ¸å¿ƒæ€æƒ³æ˜¯ï¼šâ€‹â€‹ç»„ä»¶ä»ç„¶ç®¡ç†è‡ªå·±çš„çŠ¶æ€ï¼Œä½†å°†çŠ¶æ€æ›´æ–°çš„å†³å®šæƒé€šè¿‡ reducer å‡½æ•°æš´éœ²ç»™ä½¿ç”¨è€…â€‹â€‹\nä¼ ç»ŸReducer 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 function toggleReducer(state, action) { switch (action.type) { case \u0026#39;TOGGLE\u0026#39;: return { on: !state.on }; default: return state; } } function useToggle() { const [state, dispatch] = useReducer(toggleReducer, { on: false }); const toggle = () =\u0026gt; dispatch({ type: \u0026#39;TOGGLE\u0026#39; }); return { on: state.on, toggle, }; } æ·»åŠ State Reducer 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 function useToggle({ reducer = toggleReducer } = {}) { const [state, dispatch] = useReducer(reducer, { on: false }); const toggle = () =\u0026gt; dispatch({ type: \u0026#39;TOGGLE\u0026#39; }); return { on: state.on, toggle, }; } // ä½¿ç”¨é»˜è®¤è¡Œä¸º function App() { const { on, toggle } = useToggle(); return \u0026lt;button onClick={toggle}\u0026gt;{on ? \u0026#39;ON\u0026#39; : \u0026#39;OFF\u0026#39;}\u0026lt;/button\u0026gt;; } // è‡ªå®šä¹‰ reducer function App() { const { on, toggle } = useToggle({ reducer(state, action) { if (action.type === \u0026#39;TOGGLE\u0026#39; \u0026amp;\u0026amp; on) { return state; // é˜»æ­¢å…³é—­ } return toggleReducer(state, action); } }); return \u0026lt;button onClick={toggle}\u0026gt;{on ? \u0026#39;ON\u0026#39; : \u0026#39;OFF\u0026#39;}\u0026lt;/button\u0026gt;; } ä½¿ç”¨åœºæ™¯ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 function useForm({ reducer = formReducer } = {}) { const [state, dispatch] = useReducer(reducer, { values: {} }); const setFieldValue = (name, value) =\u0026gt; dispatch({ type: \u0026#39;SET_FIELD\u0026#39;, name, value }); return { values: state.values, setFieldValue, }; } // è‡ªå®šä¹‰ reducer æ·»åŠ æ—¥å¿— function LoggingForm() { const { values, setFieldValue } = useForm({ reducer(state, action) { console.log(\u0026#39;Action:\u0026#39;, action); const newState = formReducer(state, action); console.log(\u0026#39;New state:\u0026#39;, newState); return newState; } }); // æ¸²æŸ“é€»è¾‘... } State Reducerçš„å®ç°åŸºç¡€åœ¨äº reducerå‡½æ•°ç­¾åçš„ä¸€è‡´æ€§ï¼šï¼ˆstate, actionï¼‰ =\u0026gt; void ä¹Ÿæ­£å› ä¸ºå¤šä¸ªreducerå…±äº«ç›¸åŒçš„å‡½æ•°ç­¾åï¼Œ æ‰€ä»¥State Reducerä¹Ÿå¯ä»¥å’Œç»„åˆå¤šä¸ªHOCé‚£æ ·å®ç°composeræ¨¡å¼(ç±»ä¼¼å‰é¢ç»„åˆå¤šä¸ªHOCä¸€æ ·)\nå¤šä¸ªreducerç»„åˆ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 function composeReducers(...reducers) { return (state, action) =\u0026gt; reducers.reduce((currentState, reducer) =\u0026gt; reducer(currentState, action), state); } function useAdvancedToggle() { const { on, toggle } = useToggle({ reducer: composeReducers( toggleReducer, (state, action) =\u0026gt; { if (action.type === \u0026#39;TOGGLE\u0026#39; \u0026amp;\u0026amp; state.on) { // æ·»åŠ é¢å¤–é™åˆ¶ return state; } return state; }, (state, action) =\u0026gt; { // æ·»åŠ æ—¥å¿— console.log(action); return state; } ) }); } æ€»ç»“ å…¶å®ä¸Šé¢çš„è®¾è®¡æ¨¡å¼ï¼Œ æ ¸å¿ƒå°±æ˜¯å›´ç»• å…³æ³¨ç‚¹åˆ†ç¦»ï¼Œ æ¯”å¦‚Container \u0026amp; presentionæ¨¡å¼(æ¯”è¾ƒç®€å•ï¼Œä¸Šé¢æ²¡æœ‰è¯¦ç»†å±•å¼€)ä»¥åŠProps renderï¼Œ Props collectionsæ¨¡å¼éƒ½æ˜¯å¦‚æ­¤ é€»è¾‘å¤ç”¨ï¼Œ æ¯”å¦‚HOCä»¥åŠState Reducer; å‰ææ˜¯å¯å¤ç”¨é€»è¾‘æœ¬èº«å’Œç›®æ ‡æ˜¯å­˜åœ¨æ­£äº¤æ€§çš„ï¼›å½“ç„¶ä¸¥æ ¼ä»¥ä¸Šæ¥è¯´é€»è¾‘å¤ç”¨å…¶å®ä¹Ÿæ˜¯å…³æ³¨ç‚¹åˆ†ç¦»çš„ä¸€ç§è¡¨ç°å½¢å¼ï¼Œ æŠŠé‡å¤çš„é€»è¾‘å’Œä¸»é€»è¾‘æŠ½ç¦»å‡ºæ¥ ä¸Šè¯‰reactè®¾è®¡æ¨¡å¼ä¹‹æ‰€ä»¥éœ€è¦å¼ºè°ƒå…³æ³¨ç‚¹åˆ†ç¦»çš„ä¸€ä¸ªé‡è¦åŸå› åœ¨äºï¼šReact Hookæœ¬èº«åœ¨è®¾è®¡ä¸Šï¼Œ å°†UIå’Œé€»è¾‘ç´§å¯†åœ°ç³…åœ¨äº†ä¸€èµ·ï¼ˆç›¸å¯¹çš„Vue3å°†é€»è¾‘ä¹Ÿå°±æ˜¯scriptå’ŒUIè¿›è¡Œäº†åˆ†ç¦»ï¼Œ ä¸¤ç§æµæ´¾å„æœ‰åˆ©å¼Šï¼‰ï¼Œæ‰€ä»¥åœ¨è®¾è®¡å¤æ‚åº”ç”¨çš„æ—¶å€™åˆéœ€è¦ä»¥æŸç§æ–¹å¼å®ç°å…³æ³¨ç‚¹åˆ†ç¦»\n","date":"2025-08-13T07:45:54Z","permalink":"https://superjcd.github.io/p/react%E5%B8%B8%E7%94%A8%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F%E6%96%B0/","title":"Reactå¸¸ç”¨è®¾è®¡æ¨¡å¼(æ–°)"},{"content":"æˆ‘ä»¬çŸ¥é“å¥½çš„promptä¼šç›´æ¥å…³ç³»åˆ°LLMåº”ç”¨çš„è´¨é‡ï¼Œé‚£ä¹ˆå¦‚ä½•é€šè¿‡æç¤ºå·¥ç¨‹è·å¾—æ›´å¥½çš„Promptä¼šæ˜¯ä¸€ä»¶éå¸¸é‡è¦ä¸”æœ‰æ„ä¹‰çš„äº‹æƒ…ã€‚\nåœ¨å®ç°æŸç§è°ƒä¼˜ä¹‹å‰ï¼Œ æˆ‘ä»¬é¦–å…ˆéœ€è¦ææ¸…æ¥šä¸€ä»¶äº‹æƒ…ï¼Œ å¦‚ä½•å»è¯„ä¼°æŸä¸€é¡¹å¯¹Promptè¿›è¡Œè°ƒä¼˜çš„å·¥ç¨‹æ˜¯ä¸æ˜¯çœŸçš„æ˜¯æœ‰æ•ˆçš„\nå®ç°å¯¹Query Engineçš„è¯„ä¼° å®ç°çš„æ–¹å¼è¯´èµ·æ¥å¾ˆç®€å•ï¼Œä»¥QAåœºæ™¯ä¸ºä¾‹ï¼Œ å‡å®šæˆ‘ä»¬æœ‰ä¸€ä¸ªäººä¸ºæ ‡æ³¨è¿‡çš„æ•°æ®é›†ï¼Œå®ƒåŒ…å«Questionåˆ—å’ŒAnsweråˆ—ï¼ˆè§ä¸‹è¡¨ï¼‰ï¼Œ ç„¶åæˆ‘ä»¬ç”¨LLMå›ç­”Questionï¼Œå¾—åˆ°ä¸€ä¸ªé¢„æµ‹å›ç­”ï¼Œ ç„¶åå¯¹ç…§çœŸå®Answerå’Œé¢„æµ‹Anwseræ˜¯ä¸æ˜¯ä¸€è‡´æˆ–è€…è¿‘ä¼¼ä¸€è‡´å°±å¥½äº†ã€‚\nQuestion Answer How old is Biden now Biden is 81 years old \u0026hellip;. \u0026hellip; \u0026hellip;. \u0026hellip;. å½“ç„¶è¿™é‡Œçš„é—®é¢˜åœ¨äºï¼Œ æˆ‘å¦‚ä½•å»‰ä»·åœ°è·å–ç±»ä¼¼ä¸Šé¢çš„è¿™ç§æ ¼å¼çš„æ•°æ®é›†å‘¢ï¼Ÿè¦çŸ¥é“äººå·¥æ ‡æ³¨æ˜¯éå¸¸æ˜‚è´µçš„ã€‚\nä¸€ä¸ªèªæ˜çš„æ–¹æ¡ˆæ˜¯: ç›¸è¾ƒäºåŸºäºé—®é¢˜ç»™å‡ºå›ç­”ï¼Œ ä½•ä¸å¦‚åŸºäºå›ç­”æ¥è·å–é—®é¢˜å‘¢ï¼Ÿåè€…åœ¨å®ç°ä¸Šï¼Œ å¯¹LLMæ¥è¯´æ˜¯æ¯”è¾ƒå®¹æ˜“çš„ï¼Œ æ‰€ä»¥åªè¦é€šè¿‡LLMæ¥è§£ææ–‡æœ¬ï¼Œ å¹¶åŸºäºæ–‡æœ¬å†…å®¹æ¥ç”±LLMè¾“å‡ºå¯¹åº”çš„é—®é¢˜ï¼Œ æˆ‘ä»¬å°±èƒ½å¤Ÿè·å¾—ä¸€ä¸ªç±»ä¼¼äºäººä¸ºæ ‡æ³¨è¿‡çš„\u0026quot;é»„é‡‘æ•°æ®é›†\u0026quot;(Golden Dataset)\nå…·ä½“ä»£ç å®ç°\u0026ndash;ä»¥llamaindexä¸ºä¾‹å­ å‡†å¤‡\n1 2 3 4 5 6 7 8 from llama_index.core import Settings from llama_index.llms.ollama import Ollama from llama_index.embeddings.huggingface import HuggingFaceEmbedding llm = Ollama(model=\u0026#34;llama3\u0026#34;, request_timeout=60.0, temperature=0.1) Settings.llm = llm embed_modle = HuggingFaceEmbedding(\u0026#34;BAAI/bge-base-en-v1.5\u0026#34;) Settings.embed_model = embed_modle è€æ ·å­ï¼Œ è´«ç©·çš„æˆ‘ä¾ç„¶é€‰æ‹©llama3å¼€å±€ ğŸ¤¡ï¼ˆç†æƒ³æƒ…å†µä¸‹è‚¯å®šæ˜¯ä¸Šæœ€æ–°ç‰ˆæœ¬çš„chatgptä¼šæ›´å¥½ï¼‰\nè·å–æ•°æ®:\n1 2 3 4 5 6 7 from llama_index.readers.file import PDFReade from llama_index.core import Document loader = PDFReader() docs0 = loader.load_data(file=\u0026#34;./data/llama2.pdf\u0026#34;) doc_text = \u0026#34;\\n\\n\u0026#34;.join([d.get_content() for d in docs0]) docs = [Document(text=doc_text)] llama2.pdfæ˜¯llama2çš„è®ºæ–‡ï¼Œä¸‹è½½åœ°å€ï¼šhttps://arxiv.org/pdf/2307.09288\n1 2 3 4 from llama_index.core.node_parser import SentenceSplitter node_parser = SentenceSplitter(chunk_size=1024) base_nodes = node_parser.get_nodes_from_documents(docs) è¿™é‡Œæˆ‘ä»¬å¯¹æ–‡æ¡£æŒ‰å¥å­è¿›è¡Œåˆ‡åˆ†\n1 2 3 4 5 from llama_index.core import VectorStoreIndex index = VectorStoreIndex(base_nodes) query_engine = index.as_query_engine(similarity_top_k=2) ç”Ÿæˆæ¨¡æ‹Ÿçš„\u0026quot;é»„é‡‘æ•°æ®é›†\u0026quot;\n1 2 3 4 5 6 7 8 9 10 11 12 13 import nest_asyncio nest_asyncio.apply() dataset_generator = DatasetGenerator( base_nodes[:20], show_progress=True, num_questions_per_chunk=3, ) eval_dataset = await dataset_generator.agenerate_dataset_from_nodes(num=60) nest_asyncio.apply()æ˜¯ä¸ºäº†æ–¹ä¾¿æˆ‘ä»¬åœ¨jupyterlabä¸­è¿è¡Œå¼‚æ­¥ä»£ç ï¼Œ ä¸Šé¢çš„ä¾‹å­å…¶å®ä¸éœ€è¦ï¼ˆå› ä¸ºjupyterlabæœ¬èº«å°±æ˜¯è¿è¡Œåœ¨ä¸€ä¸ªeventloopä¸Šçš„ï¼‰ï¼Œ ä½†æ˜¯åé¢ä¼šç”¨åˆ°\neval_datasetå°±æ˜¯æˆ‘ä»¬é€šè¿‡LLMè·å–çš„æ•°æ®é›†ï¼Œ å¦‚æœä½ è¿˜æ˜¯å¾ˆå¥½å¥‡DatasetGeneratorå®ç°åŸç†ï¼Œ ä½ åªè¦çœ‹ä¸€ä¸‹å®ƒçš„promptå°±çŸ¥é“äº†ï¼š\nå¦‚æœä½ ä¸æ„Ÿå…´è¶£çš„è¯ï¼Œ è¿™éƒ¨åˆ†å¯ä»¥è·³è¿‡\né¦–å…ˆæˆ‘ä»¬å‡†å¤‡ä¸€ä¸ªå¯ä»¥ä¼˜ç¾å±•ç¤ºpromptçš„è¾…åŠ©å‡½æ•°ï¼š\n1 2 3 4 5 6 7 8 from IPython.display import Markdown, display def display_prompt_dict(prompts_dict): for k, p in prompts_dict.items(): text_md = f\u0026#34;**Prompt Key**: {k}\u0026lt;br\u0026gt;\u0026#34; f\u0026#34;**Text:** \u0026lt;br\u0026gt;\u0026#34; display(Markdown(text_md)) print(p.get_template()) display(Markdown(\u0026#34;\u0026lt;br\u0026gt;\u0026lt;br\u0026gt;\u0026#34;)) ç„¶åæŸ¥çœ‹dataset_generatorçš„prompt:\n1 display_prompt_dict(dataset_generator.get_prompts()) è¾“å‡ºï¼š\n1 2 3 4 5 6 7 Context information is below. --------------------- {context_str} --------------------- Given the context information and not prior knowledge. generate only questions based on the below query. {query_str} Seeï¼Ÿæˆ‘ä»¬å…¶å®æ˜¯è®©å¤§æ¨¡å‹æ ¹æ®æ–‡æœ¬æ¥ç”Ÿæˆé—®é¢˜\nä½¿ç”¨Meta Promptæ¥è°ƒä¼˜prompt é¦–å…ˆè¿™ä¸ªideaæ¥è‡ªäºè¿™ç¯‡è®ºæ–‡ï¼šhttps://arxiv.org/pdf/2309.03409\nè‡³äºå®ç°ï¼Œ ç®€å•æ¥è®²ï¼Œ å°±æ˜¯é€šè¿‡è¿­ä»£çš„æ–¹å¼ï¼Œ è®©Meta Prompt(å…ƒæç¤º)åŸºäºç°æœ‰çš„promptè¡¨ç°(æ˜¯ä¸€ä¸ªéšç€è¿­ä»£ä¸æ–­æ‰©å±•çš„åˆ—è¡¨ï¼Œ å®ƒä¼šæˆä¸ºMeta Promptçš„ä¸€éƒ¨åˆ†æ¥åšä¸ºä¸Šä¸‹æ–‡çš„ä¸€éƒ¨åˆ†)ï¼Œ æ¥ç”Ÿæˆæ›´å¥½çš„æç¤ºæ¥æ”¹å–„æˆ‘ä»¬çš„åˆå§‹prompt\né¦–å…ˆæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹æˆ‘ä»¬çš„å…ƒæç¤ºé•¿ä»€ä¹ˆæ ·ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 meta_tmpl_str = \u0026#34;\u0026#34;\u0026#34;\\ Your task is to generate the instruction \u0026lt;INS\u0026gt;. Below are some previous instructions with their scores. The score ranges from 1 to 5. {prev_instruction_score_pairs} Below we show the task. The \u0026lt;INS\u0026gt; tag is prepended to the below prompt template, e.g. as follows: ###### \u0026lt;INS\u0026gt; {prompt_tmpl_str} ####### The prompt template contains template variables. Given an input set of template variables, the formatted prompt is then given to an LLM to get an output. Some examples of template variable inputs and expected outputs are given below to illustrate the task. **NOTE**: These do NOT represent the \\ entire evaluation dataset. {qa_pairs_str} We run every input in an evaluation dataset through an LLM. If the LLM-generated output doesn\u0026#39;t match the expected output, we mark it as wrong (score 0). A correct answer has a score of 1. The final \u0026#34;score\u0026#34; for an instruction is the average of scores across an evaluation dataset. Write your new instruction (\u0026lt;INS\u0026gt;) that is different from the old ones and has a score as high as possible. Instruction (\u0026lt;INS\u0026gt;): \\ \u0026#34;\u0026#34;\u0026#34; è¿™ä¸€é•¿ä¸²çš„promtçš„æœ€ç»ˆç›®çš„æ˜¯ä¸ºäº†ç”Ÿæˆä¸€ä¸ªpromtçš„å‰ç¼€ï¼ˆä¹Ÿå°±æ˜¯ä¸Šé¢å…ƒæç¤ºä¸­çš„Instruction ()ï¼‰ï¼Œ åç»­ä¼šä¸æ–­åœ°æ ¹æ®ç”Ÿæˆçš„InstructionåŠç›¸åº”çš„è¡¨ç°ï¼ˆè¿™ä¸ªè¡¨ç°å°±æ˜¯åŸºäºå‰é¢æˆ‘ä»¬æ¨¡æ‹Ÿç”Ÿæˆçš„é‚£ä¸ªæ•°æ®é›†æ¥çš„ï¼‰\né¦–å…ˆæˆ‘ä»¬éœ€è¦å‡†å¤‡å¥½ç”¨æ¥è¯„ä¼°LLMé—®ç­”æ•ˆæœçš„å‡½æ•°ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 from llama_index.core.evaluation.eval_utils import get_responses from llama_index.core.evaluation import CorrectnessEvaluator, BatchEvalRunner evaluator_c = CorrectnessEvaluator() evaluator_dict = { \u0026#34;correctness\u0026#34;: evaluator_c, } batch_runner = BatchEvalRunner(evaluator_dict, workers=2, show_progress=True) async def get_correctness(query_engine, eval_qa_pairs, batch_runner): eval_qs = [q for q, _ in eval_qa_pairs] eval_answers = [a for _, a in eval_qa_pairs] pred_responses = get_responses(eval_qs, query_engine, show_progress=True) eval_results = await batch_runner.aevaluate_responses( eval_qs, responses=pred_responses, reference=eval_answers ) avg_correctness = np.array( [r.score for r in eval_results[\u0026#34;correctness\u0026#34;]] ).mean() return avg_correctness å¯ä»¥çœ‹åˆ°get_correctnessä¼šé€šè¿‡æ–°çš„query_engine(å†…åµŒäº†æ–°ç”Ÿæˆçš„æç¤ºå‰ç¼€, ä¹Ÿå°±æ˜¯Instruction)æ¥å¯¹æˆ‘ä»¬çš„æ¨¡æ‹Ÿæ•°æ®ä¸­çš„é—®é¢˜è¿›è¡Œå›ç­”ï¼Œ ç„¶ååŸºäºè¿™ä¸ªé¢„æµ‹å›ç­”å’Œæ¨¡æ‹Ÿæ•°æ®ä¸­çš„å›ç­”æ¥è·å¾—å‡†ç¡®ç‡\n1 2 3 4 5 from llama_index.core import PromptTemplate QA_PROMPT_KEY = \u0026#34;response_synthesizer:text_qa_template\u0026#34; meta_tmpl = PromptTemplate(meta_tmpl_str) 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 def format_meta_tmpl( prev_instr_score_pairs, prompt_tmpl_str, qa_pairs, meta_tmpl, ): \u0026#34;\u0026#34;\u0026#34;Call meta-prompt to generate new instruction.\u0026#34;\u0026#34;\u0026#34; # format prev instruction score pairs. pair_str_list = [ f\u0026#34;Instruction ():\\n{instr}\\nScore:\\n{score}\u0026#34; for instr, score in prev_instr_score_pairs ] full_instr_pair_str = \u0026#34;\\n\\n\u0026#34;.join(pair_str_list) # now show QA pairs with ground-truth answers qa_str_list = [ f\u0026#34;query_str:\\n{query_str}\\nAnswer:\\n{answer}\u0026#34; for query_str, answer in qa_pairs ] full_qa_pair_str = \u0026#34;\\n\\n\u0026#34;.join(qa_str_list) fmt_meta_tmpl = meta_tmpl.format( prev_instruction_score_pairs=full_instr_pair_str, prompt_tmpl_str=prompt_tmpl_str, qa_pairs_str=full_qa_pair_str, ) return fmt_meta_tmpl prev_instr_score_pairsæ˜¯ä¹‹å‰è¿­ä»£äº§å‡ºçš„æç¤ºå‰ç¼€ä»¥åŠç›¸åº”çš„è¯„åˆ†ï¼Œ æ‰€ä»¥å®ƒä¼šéšç€è¿­ä»£çš„å¢åŠ è€Œä¸æ–­æ‰©å±•ï¼Œ å®ƒçš„é•¿åº¦ä¼šå’Œè¿­ä»£æ¬¡æ•°å¯¹åº”çš„\n1 2 3 4 5 def get_full_prompt_template(cur_instr: str, prompt_tmpl): tmpl_str = prompt_tmpl.get_template() new_tmpl_str = cur_instr + \u0026#34;\\n\u0026#34; + tmpl_str new_tmpl = PromptTemplate(new_tmpl_str) return new_tmpl get_full_prompt_templateå…¶å®å°±æ˜¯æŠŠæˆ‘ä»¬ç”Ÿæˆçš„Intructionå’ŒåŸæœ‰çš„æç¤ºè¿›è¡Œäº†æ‹¼æ¥ï¼Œ åç»­ä¼šæ‹¿è¿™ä¸ªæ‹¼æ¥å®Œçš„æç¤ºå»æ›´æ–°Intruction\næœ€åå°±æ˜¯æˆ‘ä»¬çš„ä¸»æµç¨‹ä»£ç ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 def _parse_meta_response(meta_response: str): return str(meta_response).split(\u0026#34;\\n\u0026#34;)[0] async def optimize_prompts( query_engine, initial_instr: str, base_prompt_tmpl, meta_tmpl, meta_llm, batch_eval_runner, eval_qa_pairs, exemplar_qa_pairs, num_iterations: int = 5, ): prev_instr_score_pairs = [] base_prompt_tmpl_str = base_prompt_tmpl.get_template() cur_instr = initial_instr for idx in range(num_iterations): if idx \u0026gt; 0: # first generate fmt_meta_tmpl = format_meta_tmpl( prev_instr_score_pairs, base_prompt_tmpl_str, exemplar_qa_pairs, meta_tmpl, ) meta_response = meta_llm.complete(fmt_meta_tmpl) print(fmt_meta_tmpl) print(str(meta_response)) # Parse meta response cur_instr = _parse_meta_response(meta_response) # append instruction to template new_prompt_tmpl = get_full_prompt_template(cur_instr, base_prompt_tmpl) query_engine.update_prompts({QA_PROMPT_KEY: new_prompt_tmpl}) avg_correctness = await get_correctness( query_engine, eval_qa_pairs, batch_runner ) prev_instr_score_pairs.append((cur_instr, avg_correctness)) # find the instruction with the highest score max_instr_score_pair = max( prev_instr_score_pairs, key=lambda item: item[1] ) # return the instruction return max_instr_score_pair[0], prev_instr_score_pairs ç„¶åæ­£å¼åœ°å¼€å§‹è¿­ä»£\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 new_instr, prev_instr_score_pairs = await optimize_prompts( query_engine, initial_instr, base_qa_prompt, meta_tmpl, llm, # note: treat llm as meta_llm batch_runner, eval_qr_pairs, exemplar_qr_pairs, num_iterations=5, ) new_qa_prompt = query_engine.get_prompts()[QA_PROMPT_KEY] print(new_qa_prompt) æœ€åè¾“å‡ºçš„new_qa_promptåº”è¯¥å°±æ˜¯è¯„åˆ†æœ€å¥½çš„é‚£ä¸ªpromptäº†ï¼Œ å½“ç„¶æˆ‘ä»¬ä¹Ÿå¯ä»¥æ‰“å°prev_instr_score_pairsï¼Œçœ‹çœ‹å®ƒæ˜¯ä¸æ˜¯æœ€å¥½çš„prompt\nå‚è€ƒ https://docs.llamaindex.ai/en/stable/examples/prompts/prompt_optimization\n","date":"2024-04-30T00:00:00Z","permalink":"https://superjcd.github.io/p/%E9%AB%98%E7%BA%A7prompt%E4%BC%98%E5%8C%96%E6%8A%80%E5%B7%A7-%E5%9F%BA%E4%BA%8E%E5%85%83%E6%8F%90%E7%A4%BA/","title":"é«˜çº§Promptä¼˜åŒ–æŠ€å·§-åŸºäºå…ƒæç¤º"},{"content":"å…ˆç®€å•è®²ä¸€ä¸‹ä»€ä¹ˆæ˜¯RAG(Retrieval-Augmented Generation), æˆ–è€…è¯´ä¸ºä»€ä¹ˆéœ€è¦RAGã€‚\nLLMçš„è®­ç»ƒæ•°æ®æ˜¯åŸºäºè¿‡å»çš„ä¿¡æ¯ï¼Œ LLMæ²¡æœ‰åŠæ³•å›ç­”æœ€æ–°çš„é—®é¢˜ï¼Œ æ¯”å¦‚ä½ æ²¡æœ‰åŠæ³•è®©ä¸€ä¸ª2022å¹´è®­ç»ƒçš„æ¨¡å‹å›ç­”2023å¹´NBAçš„å† å†›å½’å±ã€‚\nå½“ç„¶æˆ‘ä»¬å¯ä»¥é€‰æ‹©ç»™ä»–å–‚æœ€æ–°çš„æ•°æ®é‡æ–°è®­ç»ƒå¤§æ¨¡å‹ï¼Œ ä½†æ˜¯è¿™ç§æ–¹å¼çš„æˆæœ¬éå¸¸é«˜æ˜‚ã€‚\nå¦‚ä½•æ•™\u0026quot;è¿‡æ—¶\u0026quot;çš„æ¨¡å‹ä»¥æ–°çŸ¥è¯†ï¼Œ é€šè¿‡RAGï¼Œ æˆ‘ä»¬æŠŠæ–°çš„çŸ¥è¯†çŒè¾“æˆ–è€…å¡«å……åˆ°å¯¹è¯çš„è¯­å¢ƒä¸­ï¼Œ é‚£ä¹ˆLLMé€šè¿‡æ£€ç´¢è¿™äº›æ–°çŸ¥è¯†ï¼Œ ç»“åˆæ¨¡å‹åŸæœ‰çš„ç†è§£èƒ½åŠ›ï¼Œ ä»–å°±èƒ½å¤Ÿå›ç­”è‡ªå·±åœ¨è®­ç»ƒæ—¶æ²¡æœ‰é‡åˆ°è¿‡çš„é—®é¢˜ã€‚\næœ¬æ•™ç¨‹æˆ‘ä»¬ä¼šä½¿ç”¨llamaindexï¼Œå…·ä½“ç‰ˆæœ¬ä¿¡æ¯ï¼š\n1 2 3 4 5 6 7 Name: llama-index Version: 0.10.31 Summary: Interface between LLMs and your data Home-page: https://llamaindex.ai Author: Jerry Liu Author-email: jerry@llamaindex.ai License: MIT åŸºç¡€RAGæµç¨‹ è¿™é‡Œæˆ‘ä»¬ä¼šä½¿ç”¨llama3è€Œä¸æ˜¯OpenAIçš„chatgptæ¥ä½œä¸ºæˆ‘ä»¬çš„åŸºåº§æ¨¡å‹ï¼Œ å…³äºå¦‚ä½•éƒ¨ç½²å’Œä½¿ç”¨llama3å¯ä»¥å‚è€ƒollamaçš„githubæ–‡æ¡£ï¼š\né¦–å…ˆï¼Œ æˆ‘ä»¬ä¼šä¸ºæˆ‘ä»¬çš„RAGåº”ç”¨å‡†å¤‡å¥½llmåŸºåº§å’Œè¯åµŒå…¥æ¨¡å‹ï¼š\n1 2 3 4 5 6 7 8 9 10 from llama_index.core import Settings from llama_index.llms.ollama import Ollama from llama_index.embeddings.huggingface import HuggingFaceEmbedding from llama_index.core import SimpleDirectoryReader llm = Ollama(model=\u0026#34;llama3\u0026#34;, request_timeout=60.0, temperature=0.1) Settings.llm = llm embed_modle = HuggingFaceEmbedding(\u0026#34;BAAI/bge-base-en-v1.5\u0026#34;) Settings.embed_model = embed_modle Settingsæ˜¯å…¨å±€çš„é…ç½®ç±»ï¼Œ è¿™æ ·å¯ä»¥å…å»åç»­æ˜¾å¼è¾“å…¥llmå‚æ•°ä»¥åŠembed_modelå‚æ•°çš„è¿‡ç¨‹ï¼›è¿™é‡Œæˆ‘ä»¬ç”¨æ™ºæºï¼ˆBAAIï¼‰çš„bgeé€šç”¨æ¨¡å‹, ä»–ä»¬çš„è¯åµŒå…¥æ¨¡å‹æ˜¯æ¯”è¾ƒå¥½çš„\næ¥ç€æˆ‘ä»¬è¦åŠ è½½æ–‡æ¡£ï¼Œ å¹¶å¯¹æ–‡æ¡£è¿›è¡Œåˆ†å‰²\n1 2 3 4 5 6 7 8 9 10 11 from llama_index.core import SimpleDirectoryReader from llama_index.core.node_parser import SimpleNodeParser documents = SimpleDirectoryReader( input_files=[\u0026#34;./data/paul_graham_eassay.txt\u0026#34;] ).load_data() node_parser = SimpleNodeParser(chunk_size=1024) nodes = node_parser.get_nodes_from_documents(documents) print(len(nodes)) æˆ‘ä»¬è¯»å–äº†dataè·¯å¾„ä¸‹çš„paul_graham_eassay.txtæ–‡æ¡£ï¼Œ å¹¶å°†æ–‡æ¡£åˆ†å‰²æˆäº†é•¿åº¦ä¸º1024çš„è‹¥å¹²ä¸ªæ–‡æ¡£ï¼Œ è¿™æ ·æ–‡æ¡£æ•°ä»åŸæ¥çš„1ä¸ªå˜æˆäº†21ä¸ª æ‰“å°å…¶ä¸­ä¸€ä¸ªæ–‡æ¡£ï¼š\n1 print(str(nodes[0])) è¾“å‡ºï¼š\n1 2 3 4 5 6 7 (\u0026#39;Node ID: 00886ada-1a64-47ea-9f91-0eb48caf2138\\n\u0026#39; \u0026#39;Text: What I Worked On February 2021 Before college the two main\\n\u0026#39; \u0026#39;things I worked on, outside of school, were writing and programming. I\\n\u0026#39; \u0026#34;didn\u0026#39;t write essays. I wrote what beginning writers were supposed to\\n\u0026#34; \u0026#39;write then, and probably still are: short stories. My stories were\\n\u0026#39; \u0026#39;awful. They had hardly any plot, just characters with strong feelings,\\n\u0026#39; \u0026#39;whic...\u0026#39;) åœ¨æˆ‘æ­£å¼ä½¿ç”¨è¯­ä¹‰è¿›è¡Œæ–‡æ¡£æŸ¥è¯¢ä¹‹å‰ï¼Œ æˆ‘ä»¬éœ€è¦å‡†å¤‡å¥½æˆ‘ä»¬çš„å‘é‡æ•°æ®åº“ï¼Œ å¯é€‰é¡¹æœ‰å¾ˆå¤šï¼Œ å…·ä½“å¯ä»¥å‚è€ƒè¿™é‡Œ;è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨weaviate(æ¨èä½¿ç”¨dockeræœ¬åœ°è¿è¡Œweaviateï¼Œ å…·ä½“å‚è€ƒè¿™é‡Œ, )\n1 2 3 4 5 6 7 8 9 10 11 import weaviate # v3 version from llama_index.core import VectorStoreIndex, StorageContext from llama_index.vector_stores.weaviate import WeaviateVectorStore index_name = \u0026#34;MyExternalContext\u0026#34; client = weaviate.Client(url=\u0026#34;http://localhost:8080\u0026#34;) vector_store = WeaviateVectorStore(weaviate_client=client, index_name=index_name) storage_context = StorageContext.from_defaults(vector_store=vector_store) index = VectorStoreIndex(nodes, storage_context=storage_context) æ¥ç€æˆ‘ä½¿ç”¨VectotreStoreIndexä½œä¸ºæˆ‘ä»¬æŸ¥è¯¢å¼•æ“æ¥æŸ¥è¯¢æ–‡æ¡£ï¼š\n1 2 3 4 5 6 7 Question = \u0026#34;What happened at Interleaf?\u0026#34; query_engine = index.as_query_engine() response = query_engine.query(Question) print(response) å‰ç½®è¿‡ç¨‹ä¼˜åŒ– \u0026ndash; ä½¿ç”¨SentenceWindowNodeParseråˆ†å‰²æ–‡æ¡£ æ‰€è°“çš„å‰ç½®ä¼˜åŒ–ï¼Œ å°±æ˜¯å‘ç”Ÿåœ¨queryä¹‹å‰çš„ä¼˜åŒ–ã€‚\nå‰é¢æˆ‘ä»¬ä½¿ç”¨äº†SimpleNodeParseræ¥åˆ†å‰²æˆ‘ä»¬çš„æ–‡æ¡£ï¼Œ å½“æ—¶æˆ‘ä»¬æŠŠæ–‡æ¡£åˆ†å‰²æˆäº†é•¿åº¦ä¸º1024çš„21ä¸ªæ–‡æ¡£ï¼Œ è¿™é‡Œçš„é—®é¢˜åœ¨äºï¼šå½“æˆ‘ä»¬è¿›è¡Œqueryçš„æ—¶å€™ï¼Œ æˆ‘ä»¬ä¼šå…ˆå®šä½åˆ°è¿™21ä¸ªæ–‡æ¡£ä¸­çš„æŸä¸€ä¸ªæ¥å¡«å……llmçš„contextï¼Œ ç„¶åé€šè¿‡llmæ¥è¾“å‡ºé—®é¢˜ï¼›\nå¾ˆæ˜¾ç„¶ï¼Œ 1024è¿™ä¸ªé•¿åº¦å…¶å®æœ‰ç‚¹å¤ªå¤§äº†ï¼Œä¸åˆ©äºç²¾å‡†å®šä½ï¼›ä½†æ˜¯å‡è®¾æˆ‘ç¼©å°æ–‡æ¡£çš„é•¿åº¦ï¼Œæ–‡æ¡£åŒ¹é…çš„ç²¾åº¦ä¼šä¸Šå‡ï¼Œ ä½†æ˜¯åŒæ—¶å¯èƒ½å¯¼è‡´contextçš„ä¸Šä¸‹æ–‡ä¿¡æ¯å˜å°‘ï¼Œä¹Ÿåˆ©äºè¾“å‡ºæ­£ç¡®çš„ç­”æ¡ˆï¼›\næ‰€ä»¥æˆ‘ä»¬éœ€è¦åœ¨åŒ¹é…ç²¾åº¦å’Œä¿è¯contextä¸Šä¸‹æ–‡çš„åŸºç¡€ä¸Šè¿›è¡Œå¹³è¡¡ï¼Œ è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨ SentenceWindowNodeParseræ¥åˆ†å‰²æ–‡æ¡£ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 from llama_index.core.node_parser import SentenceWindowNodeParser node_parser = SentenceWindowNodeParser.from_defaults( window_size=3, window_metadata_key=\u0026#34;window\u0026#34;, # ä¼šæˆä¸ºå…ƒæ•°æ® original_text_metadata_key=\u0026#34;original_text\u0026#34;, ) nodes = node_parser.get_nodes_from_documents(documents) print(len(nodes)) vector_store = WeaviateVectorStore(weaviate_client=client, index_name=index_name) storage_context = StorageContext.from_defaults(vector_store=vector_store) index = VectorStoreIndex(nodes, storage_context=storage_context) # è€ƒè™‘æ–‡ åŒæ—¶æˆ‘ä»¬éœ€è¦å»ç½®æ¢as_query_engineçš„node_postprocessorså‚æ•°\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 from llama_index.core.postprocessor import MetadataReplacementPostProcessor # The target key defaults to `window` to match the node_parser\u0026#39;s default postproc = MetadataReplacementPostProcessor( target_metadata_key=\u0026#34;window\u0026#34; ) query_engine = index.as_query_engine( node_postprocessors = [postproc], ) response = query_engine.query(Question) print(response) åŒ¹é…æœºåˆ¶ä¼˜åŒ–\u0026ndash;ä½¿ç”¨Hybrid Search å‰é¢çš„ä¼˜åŒ–æ–¹å¼ï¼Œ å‘ç”Ÿåœ¨åŒ¹é…ä¹‹å‰ï¼Œ æˆ‘ä»¬ä¹Ÿå¯ä»¥é€‰æ‹©ä¼˜åŒ–åŒ¹é…ç®—æ³•ï¼Œ å°†åŸºäºè¯­ä¹‰ï¼ˆè¯å‘é‡ï¼‰çš„æ–¹å¼ä¿®æ”¹ä¸ºç»“åˆå…³é”®è¯æŸ¥è¯¢\nå…³é”®è¯æŸ¥è¯¢çš„ç‰¹ç‚¹ä¼šæŸ¥æ‰¾å’ŒæŸ¥è¯¢å†…å®¹æ›´ç›¸ä¼¼çš„å†…å®¹ï¼Œ æ¯”å¦‚ç”¨æˆ·æœç´¢appleï¼Œ åœ¨å…³é”®è¯æŸ¥è¯¢çš„åœºæ™¯ä¸‹ï¼Œ æ‰€æœ‰å¸¦æœ‰appleçš„æ–‡æ¡£éƒ½æ˜¯ç›®æ ‡æ–‡æ¡£ï¼Œ ä¸è®ºappleæŒ‡çš„æ˜¯è‹¹æœè¿˜æ˜¯æ‰‹æœºã€‚ å¦å¤–å‡è®¾ç”¨æˆ·è¾“å…¥çš„è¯è¯­å‘ç”Ÿäº†æ‹¼å†™é”™è¯¯ï¼Œ å…³é”®è¯åŒ¹é…æœºåˆ¶ä¹Ÿä¼šå¤±æ•ˆ\n1 2 3 4 5 6 7 8 9 query_engine = index.as_query_engine( node_postprocessors = [postproc], vector_store_query_mode=\u0026#34;hybrid\u0026#34;, alpha=0.5 ) response = query_engine.query(Question) print(response) alphaæ˜¯0-1ä¹‹é—´çš„å€¼ï¼Œè¡¨ç¤ºå…³é”®è¯åŒ¹é…çš„æ¯”ä¾‹ï¼Œ å¦‚æœæ˜¯0çš„è¯ï¼Œ åˆ™ä¸ä½¿ç”¨ï¼›\næ³¨æ„å¹¶ä¸æ˜¯æ‰€æœ‰å‘é‡æ•°æ®åº“éƒ½æ”¯æŒå…³é”®è¯åŒ¹é…\nåç½®è¿‡ç¨‹ä¼˜åŒ– æœ€åï¼Œ å½“æˆ‘ä»¬å¾—åˆ°äº†ç›®æ ‡ç»“æœï¼Œ å¦‚æœæˆ‘ä»¬æƒ³è¦è¿›æ­¥ä¸€æ­¥ä¼˜åŒ–æŸ¥è¯¢ï¼Œ é‚£è¯¥æ€ä¹ˆå¤„ç†ï¼Ÿ ä¸€ç§æ–¹æ³•å°±æ˜¯ä½¿ç”¨rerankerä»å€™é€‰æ–‡æ¡£ï¼ˆæ¯”å¦‚æœ‰6ä¸ªå€™é€‰æ–‡æ¡£ï¼‰ä¸­ç­›é€‰å‡º1-2ä¸ªæ›´åŒ¹é…çš„æ–‡æ¡£ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 from llama_index.core.postprocessor import SentenceTransformerRerank # è®¡ç®—ç›¸ä¼¼åº¦ rerank = SentenceTransformerRerank(top_n=2, model=\u0026#34;BAAI/bge-reranker-base\u0026#34;) query_engine = index.as_query_engine( similarity_top_k=6, node_postprocessors = [rerank, postproc], vector_store_query_mode=\u0026#34;hybrid\u0026#34;, alpha=0.3 ) response = query_engine.query(Question) print(response) å‚è€ƒ Retrieval-Augmented Generation (RAG): From Theory to LangChain Implementation\n","date":"2024-04-29T00:00:00Z","permalink":"https://superjcd.github.io/p/rag%E8%BF%9B%E9%98%B6%E6%8A%80%E5%B7%A7/","title":"RAGè¿›é˜¶æŠ€å·§"},{"content":" å…³è”é¡¹ç›®: https://github.com/superjcd/gocrawler\nç¼˜èµ· æˆ‘è‡ªå·±æ˜¯ä¸€ä¸ªpythonçš„é‡åº¦ä½¿ç”¨è€…ï¼Œ pythonä¸­æœ‰å¤§é‡çš„çˆ¬è™«ç›¸å…³çš„åŒ…ï¼Œ ä¹Ÿä¸ä¹ç±»ä¼¼scrapyè¿™ç§éå¸¸æœ‰çŸ¥ååº¦çš„åŒ…ï¼Œ ç»“åˆredisçš„scrapy-redisä¼¼ä¹ä¹Ÿèƒ½åœ¨ä¸€å®šç¨‹åº¦ä¸Šè§£å†³åˆ†å¸ƒå¼çˆ¬è™«çš„éœ€æ±‚ã€‚ ä½†æ˜¯è¿™äº›ä¾ç„¶è¿˜æ˜¯ä¸å¤Ÿï¼Œ ä¸ç®¡æ˜¯ä½¿ç”¨ç”¨åŸºäºçº¿ç¨‹çš„çˆ¬è™«æ¡†æ¶ï¼ˆscrapyï¼‰ï¼Œ è¿˜æ˜¯åŸºäºåç¨‹çš„çˆ¬è™«(ruia)ï¼Œ å®ƒä»¬è¿˜æ˜¯ä¸å¤Ÿé«˜æ•ˆï¼Œ å½“ç„¶ä¸€éƒ¨åˆ†çš„åŸå› æ˜¯åœ¨äºpythonè¯­è¨€æœ¬èº«ã€‚pythonçš„ä¼˜åŠ¿æ˜¯çµæ´»æ€§ï¼Œ ä»¥åŠä¸°å¯Œçš„ç”Ÿæ€ï¼Œ ä½†æ˜¯å¦‚æœè¦è¿½æ±‚æè‡´çš„è¿è¡Œæ•ˆç‡ï¼Œ é‚£ä¹ˆgoå…¶å®æ˜¯ä¸€ä¸ªæ›´å¥½çš„é€‰æ‹©\næ ¸å¿ƒç‰¹æ€§ ä¸ªäººå‘æ¥æ¨å´‡æç®€ä¸»ä¹‰ï¼Œ çˆ¬è™«æ¡†æ¶gocrawlerçš„å¼€å‘ä¹Ÿä¸ä¾‹å¤–ï¼Œ å¯¹æˆ‘ä¸ªäººè€Œè¨€ï¼Œ è¿™ä¸ªæ¡†æ¶æœ€æœ€é‡è¦çš„å…¶å®å°±æ˜¯ä¸€ä¸ªä»»åŠ¡è°ƒåº¦å™¨(scheduler)ï¼š\n1 2 3 4 5 6 7 8 9 package scheduler import \u0026#34;github.com/superjcd/gocrawler/request\u0026#34; type Scheduler interface { Pull() *request.Request Push(typ int, reqs ...*request.Request) Schedule() } scheduleréœ€è¦å®ç°çš„æ–¹æ³•æ— éå°±æ˜¯ï¼š\nPull, è·å–ä¸€ä¸ªrequestå¯¹è±¡ Push, æäº¤è‹¥å¹²requestå¯¹è±¡ Scheduleï¼Œ è°ƒåº¦å™¨çš„å…¥å£ï¼Œ å¯åŠ¨å¹¶æŒç»­è¿è¡Œè°ƒåº¦å™¨ åŒæ ·çš„, ä»¥æ•°æ®çš„å­˜å‚¨æ¨¡å—storeä¸ºä¾‹ï¼Œ storeåªéœ€è¦å®ç°ä¸€ä¸ªSaveæ–¹æ³•å°±å¯ä»¥äº†\n1 2 3 4 5 6 7 8 9 package store import ( \u0026#34;github.com/superjcd/gocrawler/parser\u0026#34; ) type Storage interface { Save(ctx context.Context, datas ...parser.ParseItem) error } å…¶å®ƒç»„ä»¶ï¼Œ å†æ¯”å¦‚Fetcher(è¯·æ±‚æ•°æ®æ¨¡å—)ä¹Ÿä¸è¿‡åªæ˜¯ä¸€ä¸ªä»…ä»…æœ‰Fetchæ–¹æ³•çš„interfaceã€‚\n1 2 3 type Fetcher interface { Fetch(ctx context.Context, req *request.Request) (*http.Response, error) } å½“ç„¶gocrawlerä¼šä¸ºç”¨æˆ·æä¾›ä¸€äº›å¼€ç®±å¯ç”¨çš„è°ƒåº¦å™¨ä»¥åŠå­˜å‚¨ç»„ä»¶ç­‰ç­‰ï¼Œ ä½†æ‰€æœ‰è¿™äº›æ„æˆçˆ¬è™«çš„ç»„æˆéƒ¨åˆ†ï¼Œ ä¸è¿‡å°±æ˜¯ä¸€ä¸ªä¸ªçš„æ¥å£ï¼Œ ç”¨æˆ·å¯ä»¥ä½¿ç”¨gocrawleræä¾›çš„æ¨¡å—ï¼Œ ä¹Ÿå¯ä»¥ä½¿ç”¨è‡ªå·±çš„ï¼Œ æ‰€ä»¥gocrawlerå¤©ç„¶çš„ç§‰æ‰¿äº†æç®€ä¸»ä¹‰å’Œé¢å‘æ¥å£ç¼–ç¨‹çš„å“²å­¦ã€‚\næç®€å’Œå¯æ‹“å±•æ€§æ‰æ˜¯gocrawleræœ€æœ€æ ¸å¿ƒçš„feature\næ„å»ºè¯·æ±‚å¯¹è±¡ Requestè¯·æ±‚å¯¹è±¡æ˜¯ä¸€ä¸ªç»“æ„ä½“ï¼Œ å®šä¹‰å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 type Request struct URL string Method string Retry int Data map[string]string } type RequestDataCtxKey struct{} Requestå¯¹è±¡å­—æ®µè¯´æ˜ï¼š\nURLå®šä¹‰äº†è¯·æ±‚åœ°å€ Methodå®šä¹‰äº†å…·ä½“çš„è¯·æ±‚æ–¹æ³•ï¼Œ æ¯”å¦‚GET, POSTç­‰ Retryå®šä¹‰äº†é‡è¯•çš„æ¬¡æ•°ï¼Œ å¦‚æœworkerå®šä¹‰äº†å…¨å±€æœ€å¤§retryæ•°ï¼Œ çˆ¬è™«å¼•æ“ä¼šåœ¨å…³é”®èŠ‚ç‚¹(æ¯”å¦‚å†³å®šæ˜¯å¦é‡è¯•)çš„æ—¶å€™æŸ¥çœ‹è¿™ä¸ªå€¼ Dataæ˜¯ç”¨æˆ·è‡ªå®šä¹‰çš„ä¸€äº›å…ƒæ•°æ®ï¼Œ è¿™äº›å…ƒæ•°æ®ä¼šé€šè¿‡context.WithValueçš„æ–¹å¼æ³¨å…¥åˆ°çˆ¬è™«ä¸Šä¸‹æ–‡ä¸­ï¼Œ æ³¨å…¥çš„é”®ä¸ºä¸Šé¢çš„RequestDataCtxKeyç±»å‹ ä¸ºäº†å®ç°çˆ¬è™«çš„å»é‡ï¼Œ ä¸€ç§å®ç°çš„æ–¹å¼æ˜¯ï¼šä¸å¸Œæœ›ç›¸åŒçš„Requeståœ¨ä¸€å®šçš„æ—¶é—´å†…è¢«è®¿é—®ä¸¤æ¬¡ï¼Œ é¦–å…ˆéœ€è¦å»hashè¿™ä¸ªè¯·æ±‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 func (r *Request) Hash(hashFields ...string) string { components := make([][]byte, 2+len(hashFields)) components[0] = []byte(r.URL) components[1] = []byte(r.Method) for i, field := range hashFields { if fieldValue, ok := r.Data[field]; ok { components[i+2] = []byte(fieldValue) } else { panic(fmt.Errorf(\u0026#34;field not in request.Data\u0026#34;)) } } hash := md5.Sum(bytes.Join(components, []byte(\u0026#34;:\u0026#34;))) return string(hash[:]) } é»˜è®¤çš„Hashå®ç°æ¯”è¾ƒç®€å•ï¼Œ è¿™é‡Œä½¿ç”¨md5å¯¹æŒ‡å®šçš„å­—æ®µè¿›è¡Œæ‘˜è¦ï¼›\nå½“ç„¶ï¼Œ éœ€è¦æ³¨æ„çš„ä¸€ç‚¹æ˜¯ï¼šä»€ä¹ˆæ—¶å€™è®¾ç½®å·²è¯·æ±‚å·²è®¿é—®å¾ˆå…³é”®ï¼Œ å‡è®¾åœ¨è·å¾—è¯·æ±‚çš„æ—¶å€™å°±è¿›è¡Œè®¾ç½®ï¼Œ é‚£ä¹ˆå¦‚æœè¯·æ±‚å¤±è´¥æ²¡æœ‰å…¥åº“ï¼Œ ä¾ç„¶ä¼šè¢«è®¤ä¸ºæ˜¯è®¿é—®è¿‡çš„ï¼Œæ‰€ä»¥åœ¨gocrawlerä¸­ï¼Œ è®¾ç½®å»é‡é¡¹çš„æ—¶é—´èŠ‚ç‚¹æ˜¯åœ¨æ•°æ®å¯¼å…¥ä¹‹å\nå®ç°è°ƒåº¦å™¨ è°ƒåº¦å™¨æ˜¯gocrawlerçš„æ ¸å¿ƒï¼Œå› ä¸ºéœ€è¦å®ç°åˆ†å¸ƒå¼è°ƒåº¦ï¼Œ æ‰€ä»¥ç±»ä¼¼scrapyçš„é‚£ç§åŸºäºçº¿ç¨‹å’Œå†…å­˜é˜Ÿåˆ—çš„æ–¹å¼æ˜¯ä¸åˆé€‚çš„, æ‰€ä»¥éœ€è¦é€‰æ‹©ä¸€ä¸ªé«˜ååçš„å­˜å‚¨ä»‹è´¨ï¼› æ¶ˆæ¯é˜Ÿåˆ—æ˜¯å¾ˆå®¹æ˜“æƒ³åˆ°çš„é€‰é¡¹ï¼Œ kafaka, rabbit mq, rocket mqè¿™äº›å…¶å®éƒ½å¯ä»¥ï¼Œ ä½†æ˜¯ä½œä¸ºçˆ¬è™«workerçš„æ¶ˆæ¯é˜Ÿåˆ—ï¼Œ ä¸éœ€è¦å¤ªå¼ºçš„ä¸€è‡´æ€§ä¿è¯ï¼Œæ‰€ä»¥gocrawleré»˜è®¤æä¾›äº†ä¸€ä¸ªåŸºäºnsqçš„å®ç°ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 package nsq import ( \u0026#34;encoding/json\u0026#34; \u0026#34;log\u0026#34; \u0026#34;github.com/nsqio/go-nsq\u0026#34; \u0026#34;github.com/superjcd/gocrawler/request\u0026#34; \u0026#34;github.com/superjcd/gocrawler/scheduler\u0026#34; ) const ( DIRECT_PUSH = iota NSQ_PUSH ) type nsqScheduler struct { workerCh chan *request.Request nsqLookupdAddr string topicName string channelName string nsqConsumer *nsq.Consumer nsqProducer *nsq.Producer } type nsqMessageHandler struct { s *nsqScheduler } func (h *nsqMessageHandler) HandleMessage(m *nsq.Message) error { var err error if len(m.Body) == 0 { return nil } processMessage := func(mb []byte) error { var req request.Request if err = json.Unmarshal(mb, \u0026amp;req); err != nil { return err } h.s.Push(DIRECT_PUSH, \u0026amp;req) return nil } err = processMessage(m.Body) return err } var _ scheduler.Scheduler = (*nsqScheduler)(nil) func NewNsqScheduler(topicName, channelName, nsqAddr, nsqLookupdAddr string) *nsqScheduler { nsqConfig := nsq.NewConfig() nsqConsumer, err := nsq.NewConsumer(topicName, channelName, nsqConfig) if err != nil { log.Fatal(err) } nsqProducer, err := nsq.NewProducer(nsqAddr, nsqConfig) if err != nil { log.Fatal(err) } workerCh := make(chan *request.Request) return \u0026amp;nsqScheduler{workerCh: workerCh, topicName: topicName, channelName: channelName, nsqLookupdAddr: nsqLookupdAddr, nsqConsumer: nsqConsumer, nsqProducer: nsqProducer, } } func (s *nsqScheduler) Pull() *request.Request { req := \u0026lt;-s.workerCh return req } func (s *nsqScheduler) Push(typ int, reqs ...*request.Request) { switch typ { case DIRECT_PUSH: for _, req := range reqs { s.workerCh \u0026lt;- req } case NSQ_PUSH: for _, req := range reqs { msg, err := json.Marshal(req) if err != nil { log.Printf(\u0026#34;push msg to nsq failed\u0026#34;) } s.nsqProducer.Publish(s.topicName, msg) } default: log.Fatal(\u0026#34;wrong push type\u0026#34;) } } func (s *nsqScheduler) Schedule() { s.nsqConsumer.AddHandler(\u0026amp;nsqMessageHandler{s: s}) if err := s.nsqConsumer.ConnectToNSQLookupd(s.nsqLookupdAddr); err != nil { log.Fatal(err) } } func (s *nsqScheduler) Stop() { s.nsqConsumer.Stop() } å› ä¸ºè°ƒåº¦å™¨éœ€è¦åŒæ—¶å®ç°Pushå’ŒPullçš„æ“ä½œï¼Œ æ‰€ä»¥nsqScheduleråŒæ—¶å…·æœ‰ä¸€ä¸ªnsq.Consumer(å®ç°pull)å’Œnsq.Producer(å®ç°push)çš„æŒ‡é’ˆ. Pullçš„é€»è¾‘å¾ˆç®€å•ï¼Œ ç›´æ¥ä»workerChanè·å–ä¸€ä¸ªRequestå¯¹è±¡å°±å¥½ Pushåˆ™ä¼šæ ¹æ®ç±»å‹é€‰æ‹©DIRECT_PUSHç›´æ¥å¾€workerChanæ”¾ä¸€ä¸ªRequestï¼Œ å¦‚æœæ˜¯NSQ_PUSHåˆ™ä¼šæ˜¯å°†Requesté€šè¿‡nsqProducerå‘å¸ƒåˆ°nsqé‡Œé¢ æœ€åScheduleçš„å®ç°å¾ˆç®€å•ï¼Œ å°±æ˜¯è¿æ¥nsqlookupd, å¼€èµ·ç›‘å¬ï¼Œ å½“ç›‘å¬ä¸€ä¸ªåˆ°messageæ—¶å°±ä¼šè§¦å‘HandleMessageå›è°ƒå‡½æ•°ï¼Œ è€ŒHandleMessageçš„ä¸»è¦é€»è¾‘å°±æŠŠè·å–çš„Requestå¯¹è±¡pushåˆ°workerChä¸­\nç”±äºnsqæœ¬èº«å¹¶ä¸èƒ½ä¿è¯é¡ºåº, æ‰€ä»¥è¿™ä¸ªSchedulerä¸æ˜¯ä¸¥æ ¼æ„ä¹‰ä¸Šçš„FIFO, å½“ç„¶å¯¹äºçˆ¬è™«æ¥è¯´ç»å¯¹çš„å…ˆå…¥å…ˆå‡ºä¸æ˜¯ç‰¹åˆ«çš„é‡è¦\nå®ç°å­˜å‚¨å™¨ é€šå¸¸æˆ‘ä»¬ä¼šä½¿ç”¨mysqlä¹‹ç±»çš„å…³ç³»æ€§æ•°æ®åº“ä½œä¸ºå­˜å‚¨å™¨ï¼Œ æ— å®ƒï¼Œ æ¯”è¾ƒä¾¿åˆ©ã€‚ä½†æ˜¯è€ƒè™‘åˆ°çˆ¬è™«ä»»åŠ¡çš„ç‰¹æ®Šæ€§ï¼Œ æˆ‘ä¸ªäººå…¶å®ä¼šæ›´å€¾å‘äºä½¿ç”¨æ–‡æ¡£æ€§æ•°æ®åº“ï¼Œ å› ä¸ºé¡µé¢çš„å˜åŠ¨æ˜¯å¸¸æœ‰çš„äº‹ï¼Œ è€Œä¸”ï¼Œçˆ¬å–å¾—çš„æ•°æ®ä¸è§å¾—éƒ½æ˜¯è§„åˆ™çš„ï¼Œæ‰€ä»¥æœ‰ä¸¥æ ¼çš„shemaçš„å…³ç³»å‹æ•°æ®åº“æ˜¾ç„¶ä¸æ˜¯æœ€é€‚åˆçš„é€‰æ‹©\nè™½ç„¶mysqlç°åœ¨ä¹Ÿæ”¯æŒå­˜å‚¨jsonï¼Œ ä½†æ˜¯æŸ¥è¯¢æ€§èƒ½æ— æ³•ä¸åŸç”Ÿçš„æ–‡æ¡£æ•°æ®åº“ç›¸åª²ç¾ã€‚å½“ç„¶ä½¿ç”¨gocrawler, å› ä¸ºåªæ˜¯ä¾èµ–æ¥å£ï¼Œ æ‰€ä»¥å®ç°ä¸€ä¸ªæ”¯æŒSaveçš„mysqlå­˜å‚¨å™¨ä¹Ÿæ˜¯å¯ä»¥çš„ã€‚\ngocrawlerè‡ªå¸¦åŸºäºmongoçš„å­˜å‚¨å™¨ï¼š\næ— ç¼“å­˜mongoå­˜å‚¨å™¨ å¸¦ç¼“å­˜çš„mongoå­˜å‚¨å™¨ æ— ç¼“å­˜å®ç°ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 type mongoStorage struct { Cli *qmgo.QmgoClient } var _ store.Storage = (*mongoStorage)(nil) func NewMongoStorage(uri, database, collection string) *mongoStorage { ctx := context.Background() cli, err := qmgo.Open(ctx, \u0026amp;qmgo.Config{Uri: uri, Database: database, Coll: collection}) // counter if err != nil { panic(err) } return \u0026amp;mongoStorage{Cli: cli} } func (s *mongoStorage) Save(items ...parser.ParseItem) error { var result *qmgo.InsertOneResult var err error for _, item := range items { result, err = s.Cli.Collection.InsertOne(context.Background(), item) if err == nil { log.Println(\u0026#34;[store]insert one ok\u0026#34;) } } if err != nil { return err } _ = result return nil } æ— ç¼“å­˜çš„mongoStorageï¼Œ ä¼šåœ¨æ¯æ¬¡è°ƒç”¨Saveæ–¹æ³•çš„æ—¶å€™ï¼Œ ä¾æ¬¡å°†æ•°æ®æ’å…¥åˆ°mongodbä¸­ã€‚ å¾ˆæ˜¾ç„¶è¿™ç§å®ç°åªé€‚åˆå¯¹çˆ¬è™«é€Ÿåº¦è¦æ±‚ä¸é«˜çš„åœºæ™¯ï¼Œ æ›´åˆç†çš„æ–¹å¼æ˜¯ä½¿ç”¨ç¼“å­˜ï¼Œ ä¸‹é¢æ˜¯å¸¦ç¼“å­˜çš„å­˜å‚¨å™¨å®ç°(éƒ¨åˆ†ä»£ç ):\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 type bufferedMongoStorage struct { L *sync.Mutex Cli *qmgo.QmgoClient buf []parser.ParseItem bufSize int counter counter.Counter taskKeyField string } // ç•¥ func (s *bufferedMongoStorage) Save(items ...parser.ParseItem) error { s.L.Lock() defer s.L.Unlock() for { if len(items) \u0026gt; s.bufSize { return fmt.Errorf(\u0026#34;number of items too large(larger than the max bufSize), either increase storage bufSize or decrease number of items\u0026#34;) } if len(items) \u0026gt; (s.bufSize - len(s.buf)) { if err := s.flush(); err != nil { return err } } else { s.buf = append(s.buf, items...) break } } return nil } // ç•¥ bufferedMongoStorageä¼šå¯¹å°†è¦å¯¼å…¥çš„æ•°æ®è¿›è¡Œåˆ¤æ–­ï¼š\nå¦‚æœè¦å¯¼å…¥çš„æ•°æ®é‡å¤§äºæœ€å¤§ç¼“å­˜ï¼Œ é‚£ä¹ˆç›´æ¥è¿”ä¼šé”™è¯¯ å¦‚æœè¦å¯¼å…¥çš„æ•°æ®é‡å·²ç»å¤§äºç¼“å­˜çš„å‰©ä½™ç©ºé—´ï¼Œ é‚£ä¹ˆç›´æ¥ä¿ƒå‘flushï¼Œ flushä¼šå°†ç¼“å­˜bufä¸­æ•°æ®æ‰¹é‡å¯¼å…¥åˆ°mongodbï¼Œ flushå®Œæˆåbufä¼šè¢«æ¸…ç©º å¦åˆ™ï¼Œ ç›´æ¥è¿½åŠ åˆ°ç¼“å­˜ä¸­å¹¶é€€å‡ºå¾ªç¯ ä¹‹æ‰€ä»¥ä½¿ç”¨forå¾ªç¯çš„æ„ä¹‰åœ¨äºï¼Œ ä¸Šè¯‰çš„ç¬¬äºŒæ­¥åªæ˜¯æŠŠç¼“å­˜ä¸­çš„æ•°æ®å†™åˆ°mongoï¼Œ itemsè¿˜æ²¡æœ‰è¢«å†™å…¥ï¼Œ æ‰€ä»¥éœ€è¦æ‰§è¡Œä¸‹æ¬¡æ“ä½œï¼Œ å°†å®ƒä»¬åŠ å…¥åˆ°ç¼“å­˜ä¸­\nç”±äºflushçš„è§¦å‘æ¡ä»¶æ˜¯ç¼“å­˜å·²æ»¡æˆ–è€…å°†æ»¡çš„æƒ…å†µï¼Œ é‚£ä¹ˆå¦‚æœæ²¡æœ‰æ–°çš„æ•°æ®å¯¼å…¥åˆ°ç¼“å­˜ä¸­ï¼Œ é‚£ä¹ˆç¼“å­˜ä¸­çš„æ•°æ®å°±ä¼šä¸€ç›´é©»ç•™ï¼Œ æ‰€ä»¥æˆ‘ä»¬éœ€è¦æŸç§æœºåˆ¶æ¥è§£å†³æ•°æ®é©»ç•™çš„æƒ…å†µï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 func NewBufferedMongoStorage(...) *bufferedMongoStorage { (ç•¥) ticker := time.NewTicker(autoFlushInterval) go func() { for t := range ticker.C { log.Printf(\u0026#34;auto flush triggered at %v\u0026#34;, t) store.flush() } }() return store } è§£å†³çš„æ–¹æ¡ˆä¹Ÿå¾ˆç®€å•ï¼Œ åˆ©ç”¨å®šæ—¶å™¨å®šæ—¶è§¦å‘flushå³å¯\nå®ç°åˆ†å¸ƒå¼ä»»åŠ¡è®¡æ•° ä»¥pythonçš„scrapyä¸ºä¾‹ï¼Œ ä»–ä¼šåœ¨å°†requeståŠ å…¥é˜Ÿåˆ—çš„æ—¶å€™ç»Ÿè®¡ä»»åŠ¡æ•°é‡ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 def enqueue_request(self, request: Request) -\u0026gt; bool: if not request.dont_filter and self.df.request_seen(request): self.df.log(request, self.spider) return False dqok = self._dqpush(request) assert self.stats is not None if dqok: self.stats.inc_value(\u0026#34;scheduler/enqueued/disk\u0026#34;, spider=self.spider) else: self._mqpush(request) self.stats.inc_value(\u0026#34;scheduler/enqueued/memory\u0026#34;, spider=self.spider) self.stats.inc_value(\u0026#34;scheduler/enqueued\u0026#34;, spider=self.spider) return True ç„¶åstatsæ˜¯å­˜å‚¨åœ¨å†…å­˜ä¸­çš„ä¸€ä¸ªå­—å…¸ï¼Œ è¿™ç§å®ç°æ–¹å¼ä¹Ÿå­˜åœ¨ä»¥ä¸‹é—®é¢˜ï¼š\nç›¸æ¯”äºè¯·æ±‚æ•°ï¼Œ å…¶å®æˆ‘æ›´å…³å¿ƒå®Œæˆæ•°é‡ï¼Œ ç‰¹åˆ«æ˜¯å½“æˆ‘éœ€è¦é‡è¯•è¯·æ±‚ï¼Œ æˆ–è€…æœ‰å¸¦ç¼“å­˜çš„å­˜å‚¨å™¨çš„æ—¶å€™ï¼›è¯·æ±‚æ•°é‡ä¸æ˜¯ä¸€ä¸ªæ ¸å¿ƒæŒ‡æ ‡ æ›´é‡è¦çš„ä¸€ç‚¹æ˜¯ï¼Œ åœ¨åˆ†å¸ƒå¼åœºæ™¯ä¸‹ ï¼ŒåŸºäºworkerçš„å†…å­˜è®¡æ•°æ˜¾ç„¶æ˜¯ä¸è¡Œçš„ é¡ºå¸¦æä¸€å˜´ï¼Œscrapyçš„è®¡æ•°å‡½æ•°inc_valueå¹¶æ²¡æœ‰é”ï¼Œ å½“ç„¶åŸå› åœ¨äºå®ƒçš„schdulerçš„å…¥é˜Ÿæ“ä½œå¹¶ä¸æ˜¯å¹¶å‘å®ç°çš„ 1 2 3 4 5 def inc_value( self, key: str, count: int = 1, start: int = 0, spider: Optional[Spider] = None ) -\u0026gt; None: d = self._stats d[key] = d.setdefault(key, start) + count Ok, è¨€å½’æ­£è½¬ï¼Œæ€»è€Œè¨€ä¹‹æˆ‘éœ€è¦ä¸€ä¸ªå¯ä»¥åœ¨åˆ†å¸ƒå¼åœºæ™¯ä¸‹å®Œæˆä»»åŠ¡å®Œæˆè®¡æ•°çš„åŠŸèƒ½ï¼Œ ä¸€ä¸ªå¾ˆå®¹æ˜“æƒ³åˆ°çš„è§£å†³æ–¹æ¡ˆå°±æ˜¯redisçš„INCRæ“ä½œ, incrä¼šä»¥å¹¶å‘å®‰å…¨çš„æ–¹å¼ä¸ºkeyåŠ ä¸Š1ï¼Œ è¿™æ ·ç»“åˆgocrawlerçš„workerçš„AfterSaveç”Ÿå‘½å‘¨æœŸå‡½æ•°ï¼ˆæ·»åŠ ä¸€ä¸ªè°ƒç”¨redisçš„incrå‡½æ•°çš„hookï¼‰ï¼Œ æˆ‘å°±å¯ä»¥å®ç°ä¸€ä¸ªä¸é”™çš„åˆ†å¸ƒå¼è®¡æ•°åŠŸèƒ½ã€‚\nä½†é—®é¢˜æ˜¯ï¼Œ å¦‚æœæˆ‘ç”¨çš„æ˜¯å¸¦ç¼“å­˜çš„å­˜å‚¨å™¨ï¼Œ ç„¶åå®ç°çš„æ˜¯æ‰¹é‡å­˜å‚¨å‘¢ï¼Ÿå¦‚æœå­˜å‚¨ä¸ä¼šå¤±è´¥ï¼Œ é‚£ä¹ˆä½¿ç”¨ç”Ÿå‘½å‘¨æœŸå‡½æ•°ç»Ÿè®¡æ•°é‡ï¼Œ ç„¶åå¤šæ¬¡è°ƒç”¨INCRä¼¼ä¹ä¹Ÿä¸æ˜¯ä¸è¡Œï¼Œ ä½†æ˜¯ä¸ç®¡æ˜¯å­˜å‚¨ä¸ä¼šå¤±è´¥è¿˜æ˜¯å¤šæ¬¡è°ƒç”¨INCRéƒ½ä¸æ˜¯é²æ£’æ€§å¾ˆé«˜çš„æ“ä½œï¼Œç†æƒ³æƒ…å†µæ˜¯åœ¨å‘ç”Ÿflushçš„æƒ…å†µä¸‹ï¼Œ å¯¹flushçš„æ•°é‡è¿›è¡Œå•æ¬¡è®¡æ•°æ‰æ˜¯æœ€å®Œç¾çš„ã€‚ä½†æ˜¯redisé™¤äº†incræ˜¯å¹¶å‘å®‰å…¨ä¹‹å¤–ï¼Œå¸¸è§„çš„ä¿®æ”¹è®¡æ•°çš„æ–¹æ³•ä¸€å®šä¼šæ¶‰åŠgetå’Œputæ“ä½œï¼Œ æ‰€ä»¥å®ƒä¸æ˜¯å¹¶å‘å®‰å…¨çš„ï¼Œ æ‰€ä»¥éœ€è¦ä½¿ç”¨redisçš„äº‹åŠ¡ï¼š\nè¿™é‡Œæˆ‘ç›´æ¥ç”¨äº†å®˜æ–¹ç¤ºä¾‹ï¼Œ ç¨å¾®è°ƒæ•´ä¸€ä¸‹æ¥å®ç°äº†è¿™ä¸ªåŠŸèƒ½\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 ... func (c *redisTaskCounters) Incr(key string, increment int64) { // transaction key = c.prefix + key txf := func(tx *redis.Tx) error { // Get the current value or zero. n, err := tx.Get(key).Int64() if err != nil \u0026amp;\u0026amp; err != redis.Nil { return err } // Actual operation (local in optimistic lock). atomic.AddInt64(\u0026amp;n, increment) // Operation is commited only if the watched keys remain unchanged. _, err = tx.Pipelined(func(pipe redis.Pipeliner) error { pipe.Set(key, n, c.TTL) // time return nil }) return err } // Retry if the key has been changed. for i := 0; i \u0026lt; maxRetries; i++ { err := c.RCli.Watch(txf, key) if err == nil { // Success. return } if err == redis.TxFailedErr { // Optimistic lock lost. Retry. continue } // TODO: igonore any other error. return } } æ—¢ç„¶è¿™ä¸ªè®¡æ•°åŠŸèƒ½éœ€è¦ç»Ÿè®¡flushçš„æ•°æ®é‡ï¼Œ é‚£ä¹ˆæˆ‘ä»¬å°±æŠŠå®ƒå†™åœ¨flushå‡½æ•°é‡Œé¢\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 func (s *bufferedMongoStorage) flush() error { if len(s.buf) == 0 { return nil } err := s.insertManyTOMongo(s.buf...) if err != nil { return err } if s.counter != nil { tc := s.collectTaskCounts(s.buf) s.count(tc) } // update buffer to an empty buffer s.buf = make([]parser.ParseItem, 0, s.bufSize) log.Printf(\u0026#34;Flushed\u0026#34;) return nil } func (s *bufferedMongoStorage) count(tc map[string]int64) { for k, v := range tc { s.counter.Incr(k, v) } } collectTaskCountså‡½æ•°æ˜¯è€ƒè™‘åˆ°ç¼“å­˜é˜Ÿåˆ—ä¸­å¯èƒ½åŒæ—¶å­˜åœ¨å¤šä¸ªä»»åŠ¡çš„æ•°æ®ï¼Œæ‰€ä»¥è€ƒè™‘å…ˆç»Ÿè®¡äº†æ¯ä¸ªä»»åŠ¡å¯¹åº”çš„æ•°æ®é‡\nç”Ÿå‘½å‘¨æœŸå‡½æ•° ç›®å‰gocrawlerçš„workeræ”¯æŒçš„ç”Ÿå‘½å‘¨æœŸå‡½æ•°æœ‰ï¼š\nBeforeRequest AfterRequest BeforeSave AfterSave å®ƒä»¬çš„åº”ç”¨åœºæ™¯æ˜¯æ€æ ·çš„å‘¢ï¼Ÿè¿™é‡Œä»¥BeforeRequestä¸ºä¾‹ï¼Œ\n1 2 3 4 5 6 7 8 9 10 type BeforeRequestHook func(context.Context, *request.Request) (Signal, error) func (w *worker) BeforeRequest(ctx context.Context, req *request.Request) (Signal, error) { var sig Signal if w.BeforeRequestHook != nil { return w.BeforeRequestHook(ctx, req) } sig |= DummySignal return sig, nil } BeforeRequestä¼šåœ¨workerè°ƒç”¨Fetchä¹‹å‰è¢«è°ƒç”¨ï¼š\n1 2 3 4 ... w.BeforeRequest(context.Background(), req) resp, err := w.Fetcher.Fetch(req) ... å› ä¸ºBeforeRequestHookæœ‰æŒ‡å‘Requestçš„æŒ‡é’ˆï¼Œ æ„å‘³ç€æˆ‘ä»¬å¯ä»¥åœ¨workerå‘èµ·ç½‘ç»œè¯·æ±‚ä¹‹å‰ä¿®æ”¹Requestçš„å‚æ•°ï¼Œ æ¯”å¦‚Requestçš„Urlï¼Œ çˆ¬è™«ä»»åŠ¡çš„ç›®æ ‡urlé€šå¸¸æ˜¯è§„å¾‹çš„ï¼Œ æ¯”å¦‚ç«™ç‚¹ç½‘å€+ æŸç§IDæˆ–è€…é¡µç æ•°ï¼Œè€Œç«™ç‚¹ç½‘å€é€šå¸¸æ˜¯å›ºå®šçš„ï¼Œ å¦‚æ­¤ä¸€æ¥ï¼Œ æˆ‘ä»¬åœ¨æäº¤ä»»åŠ¡çš„æ—¶å€™ï¼Œ ä¸ç”¨å†™å…¥å®Œæ•´çš„urlï¼Œ æŠŠè¡¥å…¨Urlçš„åŠŸèƒ½å†™æˆä¸€ä¸ªBeforeRequestHookæäº¤ç»™workerå³å¯ï¼Œ è¿™æ ·å¯ä»¥åœ¨å¾ˆå¤§ç¨‹åº¦å‡å°‘ä»»åŠ¡é˜Ÿåˆ—çš„å­˜å‚¨æ¶ˆè€—\nå…³äºSignal ç”Ÿå‘½å‘¨æœŸå‡½æ•°çš„ç¬¬ä¸€ä¸ªè¿”å›å€¼æ˜¯Signal, Siganlæ˜¯ä¸€ä¸ª8ä½çš„flagï¼Œ æ–¹ä¾¿ç”¨æˆ·å‘Šè¯‰workerçš„ä¸»æµç¨‹ï¼Œ æ¥ä¸‹æ¥è¯¥å¦‚ä½•æ“ä½œ é€šè¿‡signal, ç”¨æˆ·å¯ä»¥æ§åˆ¶workeré€‰æ‹©ç›´æ¥è¿›è¡Œä¸€ä¸‹è½®å¾ªç¯ï¼Œ æˆ–è€…ç›´æ¥å¿½ç•¥é”™è¯¯ï¼Œ å†æˆ–è€…ç›´æ¥panicé”™è¯¯\nç”Ÿå‘½å‘¨æœŸå‡½æ•°æ˜¯ç”¨æˆ·å¤–éƒ¨æ³¨å…¥åˆ°æ¡†æ¶çš„ï¼Œæ‰€ä»¥é€šè¿‡Signalä½œä¸ºæ¡¥æ¢ï¼Œ è®©ç”¨æˆ·æ‹¥æœ‰æ§åˆ¶workerè¿è¡Œæµç¨‹çš„èƒ½åŠ›æ˜¯å¾ˆé‡è¦çš„\nå…¶ä»–ç»„ä»¶ å…¶ä»–è¯¸å¦‚ç½‘é¡µè§£æå™¨ï¼Œ ä»£ç†è·å–ï¼Œ cookieè·å–ï¼Œ è¯·æ±‚å¤´è·å–ç­‰ç»„ä»¶çš„å®ç°ä¹Ÿå¹¶ä¸å›°éš¾, gocrawleråŒæ ·ä¹Ÿæä¾›äº†ç›¸åº”çš„æ¥å£ã€‚ å½“ç„¶æœ‰ä¸€ä¸ªç»„ä»¶å…¶å®éå¸¸é‡è¦ï¼Œé‚£å°±æ˜¯è¿›è¡Œç½‘ç»œè¯·æ±‚çš„Fetcherç»„ä»¶\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 type Fetcher interface { Fetch(req *request.Request) (*http.Response, error) } type fectcher struct { Cli *http.Client CookieGetter cookie.CoookieGetter UaGetter ua.UaGetter } func NewFectcher(timeOut time.Duration, proxyGetter proxy.ProxyGetter, cookieGetter cookie.CoookieGetter, uaGetter ua.UaGetter) *fectcher { tr := http.DefaultTransport.(*http.Transport) tr.Proxy = proxyGetter.Get tr.DisableKeepAlives = true client := \u0026amp;http.Client{Transport: tr, Timeout: timeOut} f := \u0026amp;fectcher{ Cli: client, CookieGetter: cookieGetter, UaGetter: uaGetter, } return f } func (f *fectcher) Fetch(r *request.Request) (resp *http.Response, err error) { jar, err := f.CookieGetter.Get() if err != nil { return nil, err } f.Cli.Jar = jar req, err := http.NewRequest(r.Method, r.URL, nil) if err != nil { return nil, fmt.Errorf(\u0026#34;get url failed: %w\u0026#34;, err) } ua, err := f.UaGetter.Get() if err != nil { return nil, fmt.Errorf(\u0026#34;get ua failed: %w\u0026#34;, err) } req.Header.Set(\u0026#34;User-Agent\u0026#34;, ua) resp, err = f.Cli.Do(req) if err != nil { return nil, err } return } gocrawlerè‡ªå¸¦äº†ä¸€ä¸ªåŸºç¡€çš„é»˜è®¤fetcherï¼›å¯ä»¥çœ‹åˆ°NewFectcherçš„ä¾èµ–åŸºæœ¬ä¸Šéƒ½æ˜¯æ¥å£ï¼Œ æ„å‘³ç€ç”¨æˆ·å¯ä»¥è‡ªè¡Œæ›¿æ¢æ‰€éœ€è¦çš„ä¾èµ–ï¼Œ å¢åŠ äº†æ¡†æ¶çš„çµæ´»æ€§ é»˜è®¤fetcherä¼šè°ƒç”¨net/httpä¸­çš„è¯·æ±‚å‡½æ•°æ¥å‘èµ·ç½‘ç»œè¯·æ±‚ï¼Œ ä¸è¿‡å®˜æ–¹åº“çš„è¯·æ±‚å‡½æ•°ä¸ºäº†è¿½æ±‚æ€§èƒ½ï¼Œ ä¼šå¤ç”¨è¿æ¥ï¼Œ ä½†æ˜¯å¾ˆå¤šçˆ¬è™«åœºæ™¯ä¸‹ï¼Œ æˆ‘ä»¬ä¼šå¸Œæœ›æˆ‘ä»¬æ¯æ¬¡çš„è¯·æ±‚éƒ½æ˜¯ä¸€ä¸ªæ–°çš„è¿æ¥ï¼Œè¿™æ ·å°±å¯ä»¥æ¯æ¬¡è°ƒç”¨ä¸åŒçš„ä»£ç†ï¼Œ æ‰€ä»¥åœ¨å®ä¾‹fetcherçš„æ—¶å€™ï¼Œ æˆ‘ä»¬æŠŠ.DisableKeepAlivesè®¾ç½®æˆäº†false\nworkerå®Œæ•´å·¥ä½œæµ æœ‰äº†å‰é¢çš„é“ºå«ï¼Œ æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹workerçš„Runå…¥å£å‡½æ•°çš„å®ç°ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 func (w *worker) Run() { ctx, cancel := context.WithTimeout( context.Background(), w.MaxRunTime, ) defer cancel() for i := 0; i \u0026lt; w.Workers; i++ { go singleRun(w) } \u0026lt;-ctx.Done() } Runå‡½æ•°å…¶å®å°±æ˜¯å¹¶å‘å¼€å¯å¤šä¸ªsingleRunæ¥æ‰§è¡Œå…·ä½“çš„çˆ¬è™«æµç¨‹ï¼Œ åŒæ—¶é€šè¿‡å¸¦TimeOutçš„ä¸Šä¸‹æ–‡ï¼Œ æˆ‘ä»¬ä¼šè®©workeråœ¨MaxRunTimeä¹‹åï¼Œé€€å‡ºä¸»ç¨‹åºï¼›æœ€åé™„ä¸ŠsingleRunçš„å®ç°ï¼Œ æ•´ä½“çš„é€»è¾‘è¿˜æ˜¯æ¯”è¾ƒç®€å•çš„\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 func singleRun(w *worker) { for { w.Limiter.Wait(context.TODO()) req := w.Scheduler.Pull() if req == nil { continue } var reqKey string if w.UseVisit { if w.AddtionalHashKeys == nil { reqKey = req.Hash() } else { reqKey = req.Hash(w.AddtionalHashKeys...) } if w.Vister.IsVisited(reqKey) { continue } } originReq := req // Fetch w.BeforeRequest(context.Background(), req) resp, err := w.Fetcher.Fetch(req) if err != nil { log.Printf(\u0026#34;request failed: %v\u0026#34;, err) if req.Retry \u0026lt; w.MaxRetries { originReq.Retry += 1 w.Scheduler.Push(nsq.NSQ_PUSH, originReq) } else { log.Printf(\u0026#34;too many fetch failures for request:%s, exceed max retries: %d\u0026#34;, req.URL, w.MaxRetries) } continue } if resp.StatusCode != http.StatusOK { originReq.Retry += 1 w.Scheduler.Push(nsq.NSQ_PUSH, originReq) continue } // Parse parseResult, err := w.Parser.Parse(resp) if err != nil { log.Printf(\u0026#34;parse failed for request: %s, error: %v\u0026#34;, req.URL, err) originReq.Retry += 1 w.Scheduler.Push(nsq.NSQ_PUSH, originReq) continue } // New Requests if parseResult.Requests != nil \u0026amp;\u0026amp; len(parseResult.Requests) \u0026gt; 0 { for _, req := range parseResult.Requests { w.Scheduler.Push(nsq.NSQ_PUSH, req) } } // Save if parseResult.Items != nil \u0026amp;\u0026amp; len(parseResult.Items) \u0026gt; 0 { if w.SaveRequestData { for _, p_item := range parseResult.Items { for dk, dv := range req.Data { p_item[dk] = dv } } } w.BeforeSave(context.Background(), parseResult) if err := w.Store.Save(parseResult.Items...); err != nil { log.Printf(\u0026#34;item saved failed err: %v;items: \u0026#34;, err) continue } w.AfterSave(context.Background(), parseResult) } if w.UseVisit { w.Vister.SetVisitted(reqKey, w.VisterTTL) } } } è¿™é‡Œè¿˜éœ€è¦è¿½åŠ æåˆ°çš„ä¸€ç‚¹æ˜¯ï¼Œ å¦‚æœç”¨æˆ·å†³å®šä½¿ç”¨è¿‡æ»¤å™¨ï¼ˆåœ¨ä¸€å®šæ—¶é—´å‘¨æœŸå†…ï¼Œ ä¸æƒ³åå¤åœ°æŠ“å–ç›¸åŒæ•°æ®ï¼‰ï¼Œ é‚£ä¹ˆå¯ä»¥é€šè¿‡ä¸‹é¢çš„Optionå‡½æ•°æ·»åŠ è¿‡æ»¤å™¨\n1 2 3 4 5 6 7 8 func WithVisiter(v visit.Visit, ttl time.Duration) Option { return func(opts *options) { opts.Vister = v opts.UseVisit = true opts.VisiterTTL = ttl } } workerçš„æ‰€æœ‰å¤–éƒ¨ä¾èµ–éƒ½æ˜¯åŸºäºOptionæ¨¡å¼æ·»åŠ çš„ ç„¶åå¦‚æœUseVisitæ˜¯trueçš„è¯ï¼Œ workerä¼šåœ¨å‘èµ·è¯·æ±‚å‰å…ˆåˆ¤æ–­Requestæ˜¯ä¸æ˜¯å·²ç»Visitè¿‡äº†, å¦‚æœå¼€å¯UseVisitå…¶æœ‰è®¿é—®è¿‡ï¼Œ é‚£ä¹ˆå°±ä¼šç›´æ¥è¿›å…¥ä¸‹è½®å¾ªç¯ gocralweræä¾›äº†ä¸€ä¸ªåŸºäºredisçš„Visterçš„å®ç°ï¼Œé»˜è®¤å®ç°å¹¶æ²¡æœ‰ä½¿ç”¨BloomFilterï¼Œ å¦‚æœæ•°æ®é‡éå¸¸å¤§ï¼Œ ä¸”ä¸å¤ªåœ¨æ„éƒ¨åˆ†Requestä¼šè¢«è¯¯åˆ¤ä¸ºè®¿é—®è¿‡(hashå†²çª)çš„è¯ï¼Œ ä¹Ÿå¯ä»¥è‡ªå·±å®ç°ä¸€ä¸ªåŸºäºBloomFilter(redisä¹Ÿæ˜¯æ”¯æŒçš„)\n","date":"2024-02-21T00:00:00Z","permalink":"https://superjcd.github.io/p/golang%E5%88%86%E5%B8%83%E5%BC%8F%E7%88%AC%E8%99%AB%E8%AE%BE%E8%AE%A1/","title":"golangåˆ†å¸ƒå¼çˆ¬è™«è®¾è®¡"},{"content":"åŠ¨æœº æˆ‘ä»¬ç»å¸¸ä¼šçœ‹åˆ°å¾ˆå¤šçš„goè¯­è¨€åº“ä¼šä½¿ç”¨go:generate xxxå‘½ä»¤æ¥å‡å°‘ä¸€äº›é‡å¤æ€§ä»£ç çš„ç¼–å†™ï¼ˆboilerplate codesï¼‰ï¼Œ ä½†æ˜¯go:generateå‘½ä»¤æœ¬èº«ä¸æ˜¯è¾¾åˆ°å‡è½»é‡å¤æ€§å·¥ä½œçš„å…³é”®ï¼Œ å…³é”®æ˜¯ä¸Šé¢çš„xxx(æŒ‡ä»£ä»»ä½•ä¸€ç§ä»£ç ç”Ÿæˆå·¥å…·)æ˜¯å¦‚ä½•å¸®ç»„æˆ‘ä»¬å®ç°ä»£ç ç”Ÿæˆçš„å‘¢ï¼Ÿ\næ¯”å¦‚, æˆ‘ä»¬åœ¨å†™ginçš„controllerçš„æ—¶å€™(MVCæ¶æ„)ï¼Œ æˆ‘ä»¬é€šå¸¸ä¼šé€šè¿‡å¦‚ä¸‹æ–¹å¼æå–httpè¯·æ±‚å¯¹è±¡çš„å‚æ•°ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 // controller/controller.go type GetUserParmas struct { Name string `form:\u0026#34;name\u0026#34;` Email string `form:\u0026#34;email\u0026#34;` IsAdmin int `form:\u0026#34;is_admin\u0026#34;` } func (con *Controller) GetUser() gin.HandlerFunc { return func(c *gin.Context) { var rq GetUserParmas if err := c.ShouldBindQuery(\u0026amp;rq); err != nil { response.BadRequest(c, err) return } // } } å¯¹Getè¯·æ±‚æˆ‘ä»¬æˆ‘ä»¬ä¼šåƒä¸Šé¢é‚£æ ·è°ƒç”¨ShouldBindQueryæ¥è§£æå‚æ•°ï¼Œ é—®é¢˜çš„å…³é”®åœ¨äºGetUserParamsè¿™ä¸ªè¡¨ç¤ºè¯·æ±‚çš„ç»“æ„ä½“ï¼Œ å®ƒåœ¨ç»“æ„ä¸Šå…¶å®å’ŒUserç»“æ„ä½“å…¶å®æ˜¯ç±»ä¼¼çš„ã€‚\næˆ‘ä»¬åœ¨åº”ç”¨MVCçš„æ—¶å€™ï¼Œ è‚¯å®šä¼šå®šä¹‰ä¸€äº›æ•°æ®çš„æ¨¡å‹ï¼Œ å¦‚æœä½¿ç”¨gormè¿™ç±»çš„ORMå·¥å…·çš„è¯ï¼Œ ä¼šç›´æ¥å€Ÿç”¨è¿™äº›ç»“æ„ä½“æ¥è¿›è¡Œå¯¹æ•°æ®åº“çš„æ“ä½œã€‚ä½†æ˜¯åœ¨å®šä¹‰æ•°æ®æ¨¡å‹çš„æ—¶å€™ï¼Œ ç”¨çš„tagå¯èƒ½ä¼šç±»ä¼¼äº:\n1 2 3 4 5 6 //models/users.go type User struct { Name string `gorm:\u0026#34;column:name\u0026#34;` Email string `gorm:\u0026#34;column:email\u0026#34;` IsAdmin int `gorm:\u0026#34;column:is_admin\u0026#34;` } å¯ä»¥çœ‹åˆ°Userå’ŒGetGetUserParamså”¯ä¸€çš„å·®åˆ«åªæ˜¯å®ƒä»¬çš„tagæ˜¯ä¸åŒçš„è€Œå·²ï¼Œ ä¸Šé¢æ¼”ç¤ºçš„åªæ˜¯Getè¯·æ±‚è§£æå‚æ•°çš„åœºæ™¯ï¼Œ å¦‚æœè¿˜æœ‰ç±»ä¼¼çš„å…¶ä»–åœºæ™¯å‘¢ï¼Œ æ¯”å¦‚ä½¿ç”¨ShouldBindJson, é‚£ä¹ˆåœ¨æˆ‘ä»¬çš„tagé‡Œé¢å°±éœ€è¦åŠ ä¸Šjsonæ ‡ç­¾äº†ï¼Œ å¾ˆæ˜¾ç„¶è¿™ä¸ªè¿‡ç¨‹æ˜¯å¾ˆç¹æ‚çš„ã€‚\næˆ‘ä»¬å¸Œæœ›æˆ‘ä»¬æœ‰ä¸€ä¸ªèªæ˜çš„å·¥å…·ï¼Œ å¯ä»¥å¸®åŠ©æˆ‘ä»¬åŸºäºUserä»¥åŠå…¶ä»–çš„ç»“æ„ä½“ï¼Œ è‡ªåŠ¨ç”Ÿæˆç”ŸæˆGetUserParmasä¹‹ç±»çš„ä»£ç ï¼Œ å‡å°‘é‡å¤çš„å·¥ä½œé‡.\nå®ç° å®ç°çš„æ­¥éª¤å¤§æ¦‚åˆ†ä¸ºï¼š\næ”¶é›†ç»“æ„ä½“ ç”Ÿæˆä»£ç  æ”¶é›†ç»“æ„ä½“ é¦–å…ˆæˆ‘ä»¬éœ€è¦æ”¶é›†åˆ°æ‰€æœ‰çš„ç»“æ„ä½“çš„ç›¸å…³ä¿¡æ¯ï¼Œæ„å‘³ç€éœ€è¦çŸ¥é“ç»“æ„ä½“çš„åç§°ï¼Œ ç»“æ„ä½“çš„å­—æ®µï¼Œ å­—æ®µç±»å‹ï¼Œ å­—æ®µæ ‡ç­¾ç­‰ç­‰ï¼Œ è­¬å¦‚ä¸Šé¢çš„Userç»“æ„ä½“ä¸­ä¸ªå­—æ®µä¿¡æ¯ã€‚å®ç°è¿™ä¸ªç›®æ ‡çš„æ–¹æ³•å¤§ä½“ä¸Šä¼šæœ‰ä¸¤ç§ï¼š\nåå°„ å°†ä»£ç è§£ææˆæŠ½è±¡è¯­æ³•æ ‘ç„¶åéå† æˆ‘ä»¬è¿™é‡Œä¼šä½¿ç”¨ç¬¬äºŒç§æ–¹æ³•è¾¾åˆ°æˆ‘ä»¬çš„ç›®çš„ã€‚å› ä¸ºå‡ ä¹æ‰€æœ‰çš„è¯­è¨€éƒ½ä¼šæä¾›å°†æºä»£ç è§£æä¸ºç›®æ ‡è¯­è¨€ASTæ ‘ï¼ˆæŠ½è±¡è¯­æ³•æ ‘ï¼‰çš„å·¥å…·ï¼Œ golangä¹Ÿä¸ä¾‹å¤–ï¼Œ golangçš„go/parseråŒ…ä¸­çš„ParseFileæ–¹æ³•ä¼šå°†æºç è§£ææˆASTæ ‘\nä¸¥æ ¼æ¥è®²ï¼Œ ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼ä¹‹ç±»çš„æ–¹æ³•åº”è¯¥ä¹Ÿæ˜¯å¯ä»¥çš„ï¼Œ å› ä¸ºParseä»£ç çš„è¿‡ç¨‹æœ¬èº«ï¼Œé€šå¸¸ä¹Ÿä¼šåŒ…å«æŸç§å½¢å¼çš„æ­£åˆ™è¡¨è¾¾å¼æ¥å®ç°æ‰€è°“çš„è¯æ³•åˆ†æï¼ˆlexical analyzeï¼‰\n1 2 3 4 5 fset := token.NewFileSet() var contents interface{} node, err := parser.ParseFile(fset, file, contents, parser.ParseComments) ä¸Šé¢çš„fileæ˜¯ä¸€ä¸ªæºç æ–‡ä»¶åç§°ï¼ŒParseFileä¼šè¯»å–å¹¶æŠŠä»£ç è§£æä¸ºast.Fileå¯¹è±¡ï¼Œ ä¹Ÿå°±æ˜¯ä¸Šé¢çš„nodeã€‚\næ¥ç€æˆ‘ä»¬ä¼šæ²¿ç€ast.Fileè¿™æ£µè¯­æ³•æ ‘è¿›è¡Œéå†ï¼Œ æ‰¾åˆ°æˆ‘ä»¬éœ€è¦çš„ç»“æ„ä½“å¯¹è±¡ï¼š\n1 structs := collectStructs(node) 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 type structType struct { name string node *ast.StructType } func collectStructs(node ast.Node) []*structType { structs := make([]*structType, 0) collectStructs := func(n ast.Node) bool { var t ast.Expr var structName string switch x := n.(type) { case *ast.TypeSpec: if x.Type == nil { return true } structName = x.Name.Name t = x.Type case *ast.CompositeLit: t = x.Type case *ast.ValueSpec: structName = x.Names[0].Name t = x.Type case *ast.Field: if len(x.Names) != 0 { structName = x.Names[0].Name } t = x.Type } t = deref(t) x, ok := t.(*ast.StructType) if !ok { return true } structs = append(structs, \u0026amp;structType{ name: structName, node: x, }) return true } ast.Inspect(node, collectStructs) return structs } collectStructsçš„æ ¸å¿ƒå…¶å®æ˜¯é€šè¿‡ast.Inspectæ–¹æ³•è¿›è¡Œéå†ASTæ ‘ï¼Œ å®ƒçš„ç¬¬äºŒä¸ªå‚æ•°æ˜¯ä¸€ä¸ªå‚æ•°ä¸ºast.Nodeçš„å›è°ƒå‡½æ•°ï¼Œ å›è°ƒå‡½æ•°å¦‚æœè¿”å›trueï¼Œ ä¼šç»§ç»­éå†ã€‚\nä¸Šé¢çš„ä»£ç ä¼šéå†ASTæ ‘çš„æ‰€æœ‰èŠ‚ç‚¹Nodeï¼Œ ç„¶åå°†ç›®æ ‡å¯¹è±¡ast.StructTypeæ”¶é›†èµ·æ¥è¿”å›; æ³¨æ„, æˆ‘ä»¬è¿™é‡Œå…¶å®è‡ªå®šä¹‰äº†ä¸€ä¸ªstructTypeå¯¹è±¡ï¼Œ åŸå› åœ¨äºast.StructTypeæ²¡æœ‰åŒ…å«ç»“æ„ä½“åç§°çš„å­—æ®µï¼Œ è€Œç»“æ„ä½“åç§°åç»­æ˜¯éœ€è¦ç”¨åˆ°çš„\ncollectStructså‡½æ•°å‚è€ƒäº†https://github.com/fatih/gomodifytagsä¸­çš„å®ç°\nè¿™é‡Œç¨å¾®æ’æ’­ä¸€ä¸‹ast.Inspectçš„å®ç°ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 func Inspect(node Node, f func(Node) bool) { Walk(inspector(f), node) } func Walk(v Visitor, node Node) { if v = v.Visit(node); v == nil { return } // walk children // (the order of the cases matches the order // of the corresponding node types in ast.go) switch n := node.(type) { // Comments and fields case *Comment: // nothing to do case *CommentGroup: for _, c := range n.List { Walk(v, c) } case *Field: if n.Doc != nil { Walk(v, n.Doc) } walkIdentList(v, n.Names) if n.Type != nil { Walk(v, n.Type) } if n.Tag != nil { Walk(v, n.Tag) } if n.Comment != nil { Walk(v, n.Comment) } case *FieldList: for _, f := range n.List { Walk(v, f) } ï¼ˆä¸­é—´ç•¥ï¼‰ // Files and packages case *File: if n.Doc != nil { Walk(v, n.Doc) } Walk(v, n.Name) walkDeclList(v, n.Decls) // don\u0026#39;t walk n.Comments - they have been // visited already through the individual // nodes case *Package: for _, f := range n.Files { Walk(v, f) } default: panic(fmt.Sprintf(\u0026#34;ast.Walk: unexpected node type %T\u0026#34;, n)) } è¿™é‡Œä½¿ç”¨äº†é€’å½’ä¸‹é™çš„æ–¹æ³•å»éå†æ•´æ£µæ ‘ï¼Œé€šè¿‡å¯¹èŠ‚ç‚¹ç±»å‹çš„åˆ¤æ–­ï¼Œ ä½¿ç”¨ä¸åŒçš„æ–¹æ³•(Walk, walkDeclListç­‰)æ¥æ›´æ·±ä¸€æ­¥åœ°è¿›è¡Œé€’å½’è°ƒç”¨ã€‚\nå½“æˆ‘ä»¬æ”¶é›†å®Œäº†æ‰€æœ‰ç»“æ„ä½“ä¹‹åï¼Œ ä¸ºäº†æ–¹ä¾¿åç»­çš„ä»£ç ç”Ÿæˆç¯èŠ‚ï¼Œ æˆ‘ä»¬è¿™é‡Œå¯¹æ”¶é›†çš„ç»“æ„ä½“è¿›è¡Œè¿›ä¸€æ­¥çš„æŒ–æ˜ï¼Œ è·å–ç»“æ„ä½“ä¸­çš„å­—æ®µåç§°ã€ç±»å‹ã€Tagç­‰ä¿¡æ¯ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 components, err := collectStructComponents(structs) func collectStructComponents(structs []*structType) (map[string]structComponets, error) { result := make(map[string]structComponets, len(structs)) for _, s := range structs { sc := structComponets{ Name: s.name, } fieldNames := make([]string, 0) fieldTypes := make([]string, 0) fieldTags := make([]string, 0) for _, f := range s.node.Fields.List { fieldName := \u0026#34;\u0026#34; if len(f.Names) != 0 { for _, field := range f.Names { fieldName = field.Name } } if f.Names == nil { ident, ok := f.Type.(*ast.Ident) if !ok { continue } fieldName = ident.Name } if fieldName == \u0026#34;\u0026#34; { continue } if f.Tag == nil { f.Tag = \u0026amp;ast.BasicLit{} } fieldNames = append(fieldNames, fieldName) // add Types typeExpr := f.Type typeString := types.ExprString(typeExpr) fieldTypes = append(fieldTypes, typeString) // add Tags tagExpr := f.Tag tagString := types.ExprString(tagExpr) fieldTags = append(fieldTags, tagString) } sc.FieldNames = fieldNames sc.FieldTypes = fieldTypes sc.FieldTags = fieldTags result[sc.Name] = sc } return result, nil } ä»£ç æ•´ä½“æ¯”è¾ƒç®€å•ï¼Œ å°±æ˜¯éå†StructTypeçš„Fields.Listæ¥è·å–æ¯ä¸ªç»“æ„ä½“å­—æ®µçš„è¯¦ç»†ä¿¡æ¯ï¼Œ æœ€åæ±‡æ€»æˆä¸€ä¸ªå­—å…¸ã€‚\nç”Ÿæˆä»£ç  å½“æˆ‘ä»¬æœ‰äº†æ‰€éœ€çš„ç»“æ„ä½“ä¿¡æ¯ä¹‹åï¼Œ ç”Ÿæˆä»£ç å°±æ˜¯ä¸€ä»¶éå¸¸æ°´åˆ°æ¸ æˆçš„äº‹æƒ…; è¿™é‡Œæˆ‘ä»¬ä¼šä½¿ç”¨golangè‡ªå¸¦templateåŒ…æ¥å®ç°ä»£ç ç”Ÿæˆ\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 genCode(file, components) func genCode(file string, scm map[string]structComponets) { fileName := strings.TrimRight(file, \u0026#34;.go\u0026#34;) src := fmt.Sprintf(\u0026#34;package %s\u0026#34;, pkgName) for _, v := range scm { forms, err := genForm(v) if err != nil { log.Fatal(err) } src += \u0026#34;\\n\u0026#34; + forms jsons, err := genJson(v) if err != nil { log.Fatal(err) } src += \u0026#34;\\n\u0026#34; + jsons } finalSrc, err := format.Source([]byte(src)) if err != nil { log.Fatal(err) } // fmt.Println(string(finalSrc)) outFile := fmt.Sprintf(\u0026#34;%s_param.go\u0026#34;, fileName) os.WriteFile(outFile, finalSrc, 0644) } genCodeä¼šéå†æˆ‘ä»¬ä¸Šä¸€æ­¥è·å–çš„å­—å…¸ï¼Œ ç„¶åè°ƒç”¨genFormå’ŒgenJsonç”Ÿæˆæˆ‘ä»¬æƒ³è¦å¾—åˆ°çš„ç›®æ ‡ä»£ç :\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 func ToSnakeCase(str string) string { snake := matchFirstCap.ReplaceAllString(str, \u0026#34;${1}_${2}\u0026#34;) snake = matchAllCap.ReplaceAllString(snake, \u0026#34;${1}_${2}\u0026#34;) return strings.ToLower(snake) } var ( matchFirstCap = regexp.MustCompile(\u0026#34;(.)([A-Z][a-z]+)\u0026#34;) matchAllCap = regexp.MustCompile(\u0026#34;([a-z0-9])([A-Z])\u0026#34;) funcMap = template.FuncMap{ \u0026#34;ToLower\u0026#34;: strings.ToLower, \u0026#34;ToSnake\u0026#34;: ToSnakeCase, } ) func genForm(sc structComponets) (string, error) { tempString := ` type {{.Name}}Form struct { {{range $i, $e := .FieldNames}} {{$e}}\t{{index $.FieldTypes $i}}` + \u0026#34; `form:\\\u0026#34;{{$e|ToSnake}}\\\u0026#34;`\u0026#34; + `{{end}}` + ` }` temp, err := template.New(\u0026#34;controller\u0026#34;).Funcs(funcMap).Parse(tempString) if err != nil { return \u0026#34;\u0026#34;, err } buff := bytes.NewBufferString(\u0026#34;\u0026#34;) err = temp.Execute(buff, sc) if err != nil { return \u0026#34;\u0026#34;, err } return buff.String(), nil } ä¸Šé¢ä»¥genFormä¸ºä¾‹ï¼Œ æˆ‘ä»¬ä½¿ç”¨templateçš„Excuteæ–¹æ³•å°†Structä¸­çš„è¯¸å¤šä¿¡æ¯æ³¨å…¥åˆ°äº†ä»£ç æ¨¡æ¿ä¸­\nç‰›åˆ€å°è¯• ä¸Šé¢çš„ä»£ç æˆ‘å·²ä¸Šä¼ è‡³githubï¼Œ æˆ‘ä»¬å¯ä»¥ä¸‹è½½ä¸‹æ¥ä½¿ç”¨ä¸€ä¸‹ï¼š\n1 go install github.com/superjcd/paramgen ç„¶åæˆ‘ä»¬åœ¨ç›®æ ‡æ–‡ä»¶çš„æœ€ä¸Šæ–¹(è­¬å¦‚ä¸‹é¢è¿™æ ·)ï¼Œ æ·»åŠ //go:generate paramgen\n1 2 3 4 5 6 7 8 9 10 //go:generate paramgen package model type User struct { gorm.Model Name string Password string Email string IsAdmin int } ç„¶åå†æ ¹ç›®å½•çš„ç»ˆç«¯è¿è¡Œï¼š\n1 go generate ./... ç„¶åå°±ä¼šçœ‹åˆ°ä¸Šé¢æ–‡ä»¶çš„æ—è¾¹æ–°ç”Ÿæˆäº†åç¼€_paramçš„goæ–‡ä»¶.\nReference the-ultimate-guide-to-writing-a-go-tool go-command-generate ","date":"2024-01-29T00:00:00Z","permalink":"https://superjcd.github.io/p/golang%E4%BB%A3%E7%A0%81%E7%94%9F%E6%88%90/","title":"golangä»£ç ç”Ÿæˆ"},{"content":"Seq2Seq æ¨¡å‹æ¶æ„ seq2seqæ˜¯2014å¹´éšè®ºæ–‡[Sequence to Sequence Learning with Neural Networks]å‘å¸ƒ çš„ä¸€ç§NLGè‡ªç„¶è¯­è¨€ï¼ˆç”Ÿæˆå¼ï¼‰æ¨¡å‹ï¼Œ ä¸‹å›¾ç›´è§‚å±•ç¤ºäº†seq2seqæ¨¡å‹åœ¨æœºå™¨ç¿»è¯‘ä»»åŠ¡ï¼ˆå¾·è¯‘è‹±ï¼‰ä¸­ï¼Œç¥ç»ç½‘ç»œå‰å‘è®¡ç®—ï¼ˆForwad Computiationï¼‰çš„å·¥ä½œæµç¨‹\nseq2seqæ¨¡å‹çš„å…³é”®ç‚¹åœ¨äºï¼Œ å°†æ¨¡å‹åˆ†æˆäº†ç¼–ç å™¨å’Œè§£ç å™¨ï¼š\nç¼–ç å™¨åœ¨ç¼–ç é˜¶æ®µï¼Œä¼šå¯¹æ¯ä¸€ä¸ªTokenï¼ˆä¸Šé¢çš„è¯æ˜¯ä¸€ä¸ªä¸ªçš„å•è¯ï¼‰è¿›è¡Œç¼–ç ï¼Œç¼–ç è¿‡ç¨‹é€šå¸¸ä¼šä½¿ç”¨RNNæ¥å®ç°(è®ºæ–‡é‡Œä½¿ç”¨çš„æ˜¯LSTMï¼Œ æ‰€ä»¥ä¼šåŒæ—¶æœ‰hidden stateå’Œcellä¸¤ä¸ªè¾“å‡ºï¼Œ å¦‚æœæ˜¯æœ€åŸå§‹çš„RNNï¼Œ é‚£ä¹ˆåº”è¯¥å°±åªæœ‰ä¸€ä¸ªhidden state)ã€‚\nè§£ç å™¨ä¼šæ²¿ç”¨ç¼–ç å™¨çš„ç»“æ„ï¼Œ æ¯”å¦‚è¿™é‡Œçš„ç¼–ç å™¨ç”¨çš„æ˜¯åŒå±‚çš„LSTM(è®ºæ–‡é‡Œé¢æ˜¯4å±‚)ï¼Œ é‚£ä¹ˆè§£ç å™¨ä¹Ÿä¼šä½¿ç”¨åŒå±‚çš„LSTMï¼Œ åŒæ—¶è§£ç å™¨çš„æœ€åˆçš„hidden stateå’Œcellåˆšå¥½å°±æ˜¯è§£ç å™¨çš„æœ€åä¸€æ­¥äº§å‡ºçš„hidden stateå’Œcell\nhidden stateçš„ç»´åº¦å’Œcellçš„ç»´åº¦é€šå¸¸ä¼šä¸€æ ·\nç¼–ç å™¨ æˆ‘ä»¬æ‹†è§£ä¸€ä¸‹æ•´ä¸ªseq2seqï¼Œ å…ˆåªå…³æ³¨ç¼–ç å™¨è¿™ä¸ªéƒ¨åˆ†\nç¼–ç å™¨å‰å‘è®¡ç®—æ¶‰åŠçš„å…¬å¼ï¼š\neæŒ‡çš„æ˜¯embeddingè¯åµŒå…¥\nä¹Ÿå°±æ˜¯å½“æˆ‘ä»¬ä½¿ç”¨ä¸€èˆ¬çš„RNNæ¨¡å‹æ—¶ï¼Œ å°±æ˜¯ä¸Šé¢çš„å…¬å¼ï¼Œ å¦‚æœæ˜¯LSTM, å› ä¸ºä¼šæ¶‰åŠcellï¼ˆè®°å¿†å•å…ƒï¼‰æ‰€ä»¥ä¼šå¤šä¸€ä¸ªå‚æ•°ã€‚ä¸Šé¢çš„å…¬å¼æ²¡æœ‰æ¶‰åŠå±‚çº§ï¼Œ å¦‚æœæ¶‰åŠå¤šä¸ªå±‚çº§ï¼ˆåªæœ‰ç¬¬ä¸€å±‚ä¼šç”¨åˆ°embeddingï¼‰ï¼Œ ä»¥LSTMæ¨¡å‹ä¸ºä¾‹ï¼Œ å…¬å¼ä¸ºï¼š\nä»ç¬¬äºŒå±‚layerå¼€å§‹ï¼Œ ç¼–ç å™¨çš„ç¬¬ä¸€ä¸ªå‚æ•°å˜æˆäº†å‰ä¸€å±‚çš„hidden stateè€Œä¸æ˜¯embbeding\nç¼–ç å™¨pytorchå®ç° 1 2 3 4 5 6 7 8 9 10 11 12 13 class Encoder(nn.Module): def __init__(self, input_dim, embedding_dim, hidden_dim, n_layers, dropout): super().__init__() self.hidden_dim = hidden_dim self.n_layers = n_layers self.embedding = nn.Embedding(input_dim, embedding_dim) self.rnn = nn.LSTM(embedding_dim, hidden_dim, n_layers, dropout=dropout) self.dropout = nn.Dropout(dropout) def forward(self, src): embedded = self.dropout(self.embedding(src)) outputs, (hidden, cell) = self.rnn(embedded) return hidden, cell è¿™é‡Œæ³¨æ„è´Ÿè´£å‰å‘è®¡ç®—é€»è¾‘çš„forwardå‡½æ•°ä¸­å‚æ•°srcçš„å½¢çŠ¶æ˜¯ï¼šè¾“å…¥å¥å­é•¿åº¦ï¼ˆæˆ–è€…è¯´tokenæ•°ï¼‰ * Bacthå¤§å°ï¼Œå› ä¸ºLSTMä¼šé»˜è®¤æ¥å—è¾“å…¥å¥å­é•¿åº¦ * Bacthå¤§å° * Embeddingå¤§å°çš„è¾“å…¥ï¼Œ è™½ç„¶å¯ä»¥å°†Batchå¤§å°æ”¾åˆ°ç¬¬ä¸€ç»´åº¦ï¼Œ ä½†æ˜¯è€ƒè™‘åˆ°seq2seqå…¶å®æ˜¯æ ¹æ®ä¸€ä¸ªä¸€ä¸ªçš„tokenè¿›è¡Œå‰å‘è¿ç®—çš„è¿ç®—çš„ï¼Œ æ‰€ä»¥ç¬¬ä¸€ä¸ªç»´åº¦æ˜¯å¥å­é•¿åº¦æ˜¯æ›´ç¬¦åˆé€»è¾‘çš„ï¼Œ ç›¸å½“äºå°†tokenç½®äºfor loopçš„æœ€å¤–å±‚ï¼ˆè™½ç„¶å¯èƒ½ä¸ç¬¦åˆå¤šæ•°äººçš„ç›´è§‰ï¼‰\nOkï¼Œ ç”±äºæˆ‘ä»¬çš„Decoderåªéœ€è¦hidden stateå’Œcellï¼Œ æ‰€ä»¥forwaråªè¾“å‡ºhiddenå’Œcell\nè§£ç å™¨ å›è¿‡å¤´æ¥æˆ‘ä»¬æ¥å…³æ³¨è§£ç å™¨ï¼š\nå…¶å®è§£ç å™¨å’Œç¼–ç å™¨åœ¨ç»“æ„ä¸Šæ˜¯éå¸¸ç›¸ä¼¼çš„ï¼Œ ä¸€ä¸ªæ¯”è¾ƒç›´è§‚çš„åŒºåˆ«åœ¨äºï¼š è§£ç å™¨ä¼šåœ¨æ¯ä¸ªè®¡ç®—æ­¥éª¤äº§å‡ºçš„outputä¹‹ä¸Šæ„å»ºä¸€ä¸ªå…¨è¿æ¥å±‚ï¼Œ ç„¶åè¾“å‡ºçš„å¤§å°æ˜¯è¯æ±‡è¡¨çš„å¤§å°\nè§£ç å™¨çš„è®¡ç®—å…¬å¼ï¼š\nè¿™é‡Œçš„då…¶å®å°±æ˜¯ç›®æ ‡è¾“å‡ºçš„embedding layer, ç±»æ¯”ç¼–ç å™¨å…¬å¼ä¸­çš„eï¼› så°±æ˜¯hidden stateç±»æ¯”ç¼–ç å™¨å…¬å¼ä¸­çš„h\nè§£ç å™¨pytorchå®ç° 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 class Decoder(nn.Module): def __init__(self, output_dim, embedding_dim, hidden_dim, n_layers, dropout): super().__init__() self.output_dim = output_dim self.hidden_dim = hidden_dim self.n_layers = n_layers self.embedding = nn.Embedding(output_dim, embedding_dim) self.rnn = nn.LSTM(embedding_dim, hidden_dim, n_layers, dropout=dropout) self.fc_out = nn.Linear(hidden_dim, output_dim) self.dropout = nn.Dropout(dropout) def forward(self, input, hidden, cell): input = input.unsqueeze(0) embedded = self.dropout(self.embedding(input)) output, (hidden, cell) = self.rnn(embedded, (hidden, cell)) prediction = self.fc_out(output.squeeze(0)) return prediction, hidden, cell åœ¨ä»£ç ä¸Šï¼Œ è§£ç å™¨ä¹Ÿæ˜¯å’Œç¼–ç å™¨ç›¸ä¼¼çš„ï¼ˆç”šè‡³rnnæ¨¡å‹çš„å‚æ•°ä¹Ÿæ˜¯ä¸€æ ·çš„ï¼‰ï¼Œ å½“ç„¶ä¹Ÿä¸€äº›ä¸åŒçš„åœ°æ–¹ï¼š\nforwardçš„å‚æ•°å¤šäº†hiddenå’Œcellï¼Œ è¿™ä¸ªæ˜¯encoderçš„è¾“å‡º inputç”±äºæ˜¯ä¸€ä¸ªä¸ªçš„tokenï¼Œ æ‰€ä»¥ä½¿ç”¨input = input.unsqueeze(0)è¡¥å……äº†ç¬¬ä¸€ç»´åº¦ï¼Œ è¿™æ˜¯ä¸ºäº†æ»¡è¶³LSTMæ¨¡å‹çš„è¾“å…¥éœ€æ±‚ predictioné¢„æµ‹æ˜¯æ„å»ºåœ¨outputä¹‹ä¸Šçš„ï¼Œ ç”±äºæ˜¯ç¬¬ä¸€ç»´å¯æœ‰å¯æ— ï¼Œ æˆ‘ä»¬è¿™é‡Œç”¨squeezeå‹ç¼©æ‰ å®Œæ•´seq2seqä»£ç å®ç° 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 class Seq2Seq(nn.Module): def __init__(self, encoder, decoder, device): super().__init__() self.encoder = encoder self.decoder = decoder self.device = device assert encoder.hidden_dim == decoder.hidden_dim assert encoder.n_layers == decoder.n_layers def forward(self, src, trg, teacher_forcing_ratio): batch_size = trg.shape[1] trg_length = trg.shape[0] trg_vocab_size = self.decoder.output_dim outputs = torch.zeros(trg_length, batch_size, trg_vocab_size).to(self.device) hidden, cell = self.encoder(src) input = trg[0,:] for t in range(1, trg_length): output, hidden, cell = self.decoder(input, hidden, cell) outputs[t] = output teacher_force = random.random() \u0026lt; teacher_forcing_ratio top1 = output.argmax(1) input = trg[t] if teacher_force else top1 return outputs è¿™é‡Œå…ˆè§£é‡Šä¸€ä¸‹ä¸Šé¢çš„å‡ ä¸ªæ–°å˜é‡ï¼š\ntrgå…¶å®æ˜¯targetï¼Œ è¡¨ç¤ºç›®æ ‡è¾“å‡ºï¼Œ æ‰€ä»¥åœ¨ç»“æ„ä¸Šå’Œinputæ˜¯ç›¸ä¼¼çš„: ç›®æ ‡å­—ç¬¦ä¸²é•¿åº¦(tokenæ•°) * Batchå¤§å° teacher_forcing_ratioï¼Œ å…¶å®å°±æ˜¯ä¸€ä¸ª0åˆ°1çš„æ•°å€¼ï¼ˆè¡¨ç¤ºæ¦‚ç‡ï¼‰ï¼Œ è¿™ä¸ªå€¼è¡¨ç¤ºä½¿ç”¨ä¸Šä¸€æ­¥çš„çœŸå®å€¼ï¼ˆground truthï¼‰æˆ–è€…é¢„æµ‹å€¼ä½œä¸ºä¸‹ä¸€æ­¥è¾“å…¥çš„æ¦‚ç‡ï¼Œ æ˜¾ç„¶æ˜“è§è¿™ä¸ªå€¼å¦‚æœå¤ªå¤§çš„è¯å¯èƒ½ä¼šå¯¼è‡´è¿‡æ‹Ÿåˆ å½“æˆ‘ä»¬æŠŠencoderå’Œdecoderçš„é€»è¾‘æ”¾åœ¨ä¸€èµ·çš„æ—¶å€™ï¼Œ æˆ‘ä»¬èƒ½æ¸…æ™°åœ°çœ‹åˆ°forwadä¸­æœ‰ä¸€ä¸ªforå¾ªç¯ä¼šæ²¿ç€è¾“å‡ºé•¿åº¦ä¸€æ­¥ä¸€æ­¥è°ƒç”¨decoderï¼Œ ç„¶åå°†æ¯ä¸€æ­¥çš„outputå¡«å……åˆ°æœ€åçš„ç»“æœoutputsä¸­ï¼›\næ³¨æ„ï¼Œ encoderåœ¨æ•´ä¸ªå‰å‘è®¡ç®—ä¸­åªè¿›è¡Œäº†ä¸€æ¬¡ï¼\n","date":"2024-01-18T00:00:00Z","permalink":"https://superjcd.github.io/p/seq2seq%E5%8E%9F%E7%90%86%E5%88%B0%E5%AE%9E%E7%8E%B0/","title":"Seq2SeqåŸç†åˆ°å®ç°"},{"content":"ç½‘ç»œç¼–ç¨‹å…¥é—¨ åŒæ—¶ä¹Ÿç®—æ˜¯beejâ€˜s guide to network programmingçš„é˜…è¯»ç¬”è®°ï¼Œ å½“ç„¶è¿™é‡Œä¸ä¸€å®šä¼šæŒ‰ç« åŸä¹¦çš„ç« èŠ‚åŸå°ä¸åŠ¨çš„æ¥ï¼Œ ä¼šç©¿æ’ä¸€äº›ä¸ªäººè§è§£ï¼ˆå›¿äºæ°´å¹³æœ‰é™ï¼Œ æ— æ³•ä¿è¯éƒ½æ˜¯å¯¹çš„ï¼‰\nå‰ç½®çŸ¥è¯† ä»€ä¹ˆæ˜¯socket åœ¨unixç³»ç»Ÿä¸­ï¼Œ æ‰€æœ‰çš„ä¸€åˆ‡éƒ½æ˜¯æ–‡ä»¶ï¼Œè¿™äº›æ–‡ä»¶ä¼šå…³è”ä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦ï¼ˆå…¶å®å°±æ˜¯ä¸€ä¸ªæ•´æ•°ï¼Œ å¯ä»¥ç†è§£ä¸ºè¿™äº›æ–‡ä»¶çš„idï¼‰ã€‚\nå½“æˆ‘ä»¬åœ¨unixç³»ç»Ÿä¸­ï¼Œ ä½¿ç”¨scoket()ä¼šè¿”å›ä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦ï¼ˆæ–‡ä»¶idï¼‰, ç„¶åæˆ‘ä»¬é€šè¿‡sendå’Œrecvå¯¹è¿™ä¸ªæ–‡ä»¶ä¸Šè¿›è¡Œäº†ç±»ä¼¼writeå’Œreadçš„æ“ä½œï¼Œ ä»¥æ­¤æ¥è¾¾åˆ°äº¤æ¢æ•°æ®çš„ç›®çš„\nsocketç±»å‹ ç½‘ç»œsocketæ˜¯æœ‰ä¸¤ç§ç±»å‹çš„ï¼š\nstream dgram(DATAGRAM) å‰è€…ä½¿ç”¨çš„æ˜¯TCPåè®®(Transmission Control Protocol), TCPåè®®åœ¨ä¼ è¾“è¿‡ç¨‹ä¸­æ˜¯è¦ä¸€ç›´ä¿è¯é“¾æ¥çš„ï¼Œ è€Œä¸”æ•°æ®åŒ…æ˜¯æœ‰åºä¼ é€’çš„(ä½¿ç”¨telnetå°±æ˜¯é¡ºåºä¼ è¾“ä¿¡æ¯çš„)ä¸”ä¼šæ˜¯å®Œæ•´ä¼ é€’ï¼›\nç›¸ååœ°datagramä½¿ç”¨çš„æ˜¯UDPï¼ˆUser Datagram Protocolï¼‰ï¼Œ æ•°æ®ä¸èƒ½ä¿è¯æ˜¯æœ‰åºçš„ï¼Œ ç”šè‡³ä¸èƒ½ä¿è¯æ•°æ®æ˜¯å®Œæ•´çš„ï¼ˆå½“ç„¶ç›¸åº”çš„ï¼Œ udpçš„ä¼ è¾“å¯ä»¥æ›´å¿«ï¼‰ã€‚\næœ‰äº›æ–‡ä»¶ä¼ è¾“è½¯ä»¶ï¼Œ æ¯”å¦‚tftpå…¶å®ç”¨çš„ä¹Ÿæ˜¯udpï¼Œ ä½†æ˜¯å®ƒåœ¨udpåè®®çš„åŸºç¡€ä¸Šåˆæ·»åŠ äº†ä¸€å±‚åè®®ï¼Œè¿™å±‚åè®®ä¼šè¦æ±‚æ¥æ”¶è€…å—åˆ°ä¿¡æ¯åè¿”å›ä¸€ä¸ªä¿¡å·ACK,ä¿¡æ¯å‘é€è€…åªæœ‰æ”¶åˆ°è¿™ä¸ªä¿¡å·æ‰èƒ½è¡¨ç¤ºå‘é€ä¿¡æ¯æˆåŠŸï¼Œ ä¸ç„¶ä¿¡æ¯ä¼šè¢«é‡å‘\nData Encapsulation æˆ‘ä»¬çŸ¥é“OSIï¼ˆopen system interconnect ï¼‰ä¼šæœ‰7ä¸ªå±‚çº§ï¼š\nApplication Presentation Session Transport Network Data Link Physical æ¯ä¸€ä¸ªå±‚çº§éƒ½ä¼šæºå¸¦ä¸€äº›ç›¸åº”çš„ä¿¡æ¯ï¼Œæœ€å¼€å§‹ç”¨æˆ·å‘é€çš„å‡ºå»çš„ä¿¡æ¯å¯èƒ½å°±æ˜¯ä¸€ä¸ªç®€å•çš„å­—ç¬¦ä¸²ï¼Œ è¿™ä¸€ä¸²ä¿¡æ¯ä¼šè¢«å±‚å±‚å°åŒ…ï¼š\nè¶Šå¤–å±‚çš„å°åŒ…ä¿¡æ¯ï¼Œ è¶Šæ¥è¿‘ç‰©ç†å±‚ï¼Œ ä¸ºä»€ä¹ˆï¼Ÿå› ä¸ºæ•°æ®çš„æ¥æ”¶è€…ï¼Œ è‚¯å®šå…ˆæ˜¯ç‰©ç†å±‚ï¼Œ æ¯”å¦‚Ethernetï¼Œ wifiè¿™äº›é è¿‘ç‰©ç†çš„layerï¼Œ æœ€åå±‚å±‚è§£åŒ…ï¼Œ æ‹¿åˆ°è¢«å°è£…åœ¨æœ€é‡Œé¢çš„æ•°æ®data\nipv4å’Œipv6 ipv4åœ°å€ï¼Œ è¯¸å¦‚ï¼š 192.10.2.111, å°±æ˜¯4å­—èŠ‚ï¼Œ 32ä½çš„åœ°å€ï¼Œä¹Ÿå°±æ˜¯å­˜ç€2çš„32æ¬¡æ–¹çš„å¯èƒ½æ€§ï¼Œ å¤§æ¦‚æœ€å¤šèƒ½è¡¨ç¤º40äº¿ä¸ªåœ°å€ã€‚\nåœ¨äº’è”ç½‘åˆšåˆšè¯ç”Ÿçš„æ—¶å€™ï¼Œ 40äº¿å½“ç„¶æ˜¯ä¸ªå¤©æ–‡æ•°å­—ï¼Œ ä½†æ˜¯åœ¨äººå‡éƒ½æœ‰æ‰‹æœºä»¥åŠå„ç§å¯ä»¥è”ç½‘çš„ç©¿æˆ´è®¾å¤‡çš„ä»Šå¤©ï¼Œ 40äº¿æœ‰ç‚¹æ‰è¥Ÿè§è‚˜äº†ã€‚\nipv6åˆ™æ˜¯16ä¸ªå­—èŠ‚ï¼Œ ä¹Ÿå°±æ˜¯128ä½ï¼Œ æ„å‘³ç€èƒ½è¡¨ç¤º2çš„128ç§åœ°å€ï¼Œ æ‰€ä»¥å¾ˆæ˜¾ç„¶ï¼Œ å³ä¾¿æ˜¯å…¨å®‡å®™çš„ç”Ÿç‰©ä½“éƒ½æœ‰ä¸€å°èƒ½è¿æ¥äº’è”ç½‘çš„æ‰‹æœºï¼Œ åº”è¯¥ä¹Ÿæ˜¯å¤Ÿå¤Ÿç”¨äº†ã€‚\nipv6çš„åœ°å€ï¼š 2001:0db8:c9d2:aee5:73e3:934a:a5ae:9551\nä¸Šé¢æ¯ä¸ªå†’å·åˆ†å‰²çš„éƒ½æ˜¯ç”¨16è¿›åˆ¶è¡¨ç¤ºçš„2ä¸ªå­—èŠ‚ï¼Œ ä¹Ÿå°±æ˜¯16ä½(16 * 8åˆšå¥½å°±æ˜¯128) åœ¨ipv6åœ¨è¡¨ç¤ºä¸Šï¼Œ ä¸ºäº†æ›´ç®€ä¾¿ï¼Œ å¯ä»¥å‹ç¼©æ¯ä¸ªå†’å·åˆ†å‰²ä¸­é å‰é¢çš„0ï¼Œ æ¯”å¦‚ä¸Šé¢çš„0db8è¿™éƒ¨åˆ†å¯ä»¥å‹ç¼©æˆdb8ã€‚\nç±»ä¼¼0000:0000:0000:0000:0000:0000:0000:0001è¿™æ ·çš„åœ°å€å¯ä»¥ç›´æ¥è¢«å‹ç¼©ä½::1,è¿™ä¸ªå°±æ˜¯ç›¸å½“äºipv4ä¸­locahostï¼Œ å³127.0.0.1 ã€‚ å¦å¤–ipv4æ˜¯å¯ä»¥è½¬åŒ–ä½ipv6ï¼Œ è½¬åŒ–è§„åˆ™å¹¶æ²¡æœ‰æˆ‘ä»¬æƒ³è±¡ä¸­çš„éœ€è¦ç‰µæ¶‰åˆ°è¿›åˆ¶çš„è½¬åŒ–ï¼Œè€Œæ˜¯ç›´æ¥åœ¨ipv4åœ°å€çš„åŸºç¡€ä¸ŠåŠ ä¸Šå‰ç¼€ï¼Œ æ¯”å¦‚åœ°å€192.0.2.33å¯ä»¥è½¬åŒ–ä½ ::ffff:192.0.2.33\nsubnetså­ç½‘ é€šå¸¸æˆ‘ä»¬ä¼šæŠŠipåœ°å€æ‹†åˆ†æˆæ‰€è°“networkéƒ¨åˆ†å’Œhostéƒ¨åˆ†ï¼Œå‡è®¾æˆ‘ä»¬çš„netmaskæ˜¯255.255.255.0 ï¼Œç„¶åæˆ‘ä»¬çš„ipåœ°å€æ˜¯192.0.2.33ï¼Œ é‚£ä¹ˆè¿™ä¸ªåœ°å€çš„networkéƒ¨åˆ†å°±æ˜¯192.0.2.0ï¼Œ è¿™ä¸ªå€¼å°±æ˜¯å­æ©ç å’Œipåœ°å€æ‰§è¡Œé€»è¾‘ä¸çš„ç»“æœã€‚\nä¸€ç§æ›´ä¸ºçµæ´»çš„è¡¨ç¤ºæ–¹æ³•æ˜¯å°†ipåœ°å€ç›´æ¥è¡¨ç¤ºä¸º192.0.2.33/24 ï¼ˆä¹Ÿå°±æ˜¯netmaskæ˜¯255.255.255.0ï¼‰ï¼Œ ipv6ä¹Ÿæ˜¯åŒç†\nå­—èŠ‚é¡ºåº å­—èŠ‚åºæœ‰ä¸¤ç§ï¼Œ ä¸€ç§æ˜¯å¤§ç«¯ï¼ˆBig-Endianï¼‰å¦å¤–ä¸€ç§æ˜¯å°ç«¯ï¼ˆLittle-Endianï¼‰ï¼Œå¤§ç«¯å­—èŠ‚åºé€šå¸¸ä¼šæŠŠæœ€æœ‰æ•ˆä½å­˜å‚¨åœ¨è¾ƒä½çš„åœ°å€ï¼Œ å°ç«¯åˆ™ç›¸åã€‚\næ¯”å¦‚å¤§ç«¯ä¼šæŠŠä¸€ä¸ª10è¿›åˆ¶æ•°å­—100ä¸­çš„1ï¼Œ å…ˆå­˜å‚¨åœ¨å†…å­˜çš„è¾ƒä½çš„ä½ç½®ã€‚\nç”±äºç½‘ç»œåŸºæœ¬ä¸Šæ˜¯å¤§ç«¯å­˜å‚¨çš„ï¼Œ è€Œå¾ˆå¤šæ“ä½œç³»ç»Ÿåˆæ˜¯å°ç«¯çš„ï¼Œ æ‰€ä»¥åœ¨ä¿¡æ¯ä¼ è¾“çš„è¿‡ç¨‹ä¸­è‡ªç„¶ä¼šæ¶‰åŠåˆ°å­—èŠ‚åºçš„è½¬æ¢ã€‚\næ¯”å¦‚å‡½æ•°htons()ï¼Œ è¿™ä¸ªå‡½æ•°å°±æ˜¯ç”¨æ¥æŠŠhostçš„shortæ ¼å¼çš„æ•°æ®è½¬åŒ–æˆnetworkçš„shortæ ¼å¼\nåº”ç”¨1-æŸ¥æ‰¾ipåœ°å€ ä»£ç  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 /* ** showip.c -- show IP addresses for a host given on the command line */ #include \u0026lt;stdio.h\u0026gt; #include \u0026lt;string.h\u0026gt; #include \u0026lt;sys/types.h\u0026gt; #include \u0026lt;sys/socket.h\u0026gt; #include \u0026lt;netdb.h\u0026gt; #include \u0026lt;arpa/inet.h\u0026gt; #include \u0026lt;netinet/in.h\u0026gt; int main(int argc, char *argv[]) { struct addrinfo hints, *res, *p; // 1 int status; char ipstr[INET6_ADDRSTRLEN]; if (argc != 2) { fprintf(stderr,\u0026#34;usage: showip hostname\\n\u0026#34;); return 1; } memset(\u0026amp;hints, 0, sizeof hints); hints.ai_family = AF_UNSPEC; // 2 hints.ai_socktype = SOCK_STREAM; if ((status = getaddrinfo(argv[1], NULL, \u0026amp;hints, \u0026amp;res)) != 0) { // 3 fprintf(stderr, \u0026#34;getaddrinfo: %s\\n\u0026#34;, gai_strerror(status)); return 2; } printf(\u0026#34;IP addresses for %s:\\n\\n\u0026#34;, argv[1]); for(p = res;p != NULL; p = p-\u0026gt;ai_next) { // 4 void *addr; char *ipver; // get the pointer to the address itself, // different fields in IPv4 and IPv6: if (p-\u0026gt;ai_family == AF_INET) { // IPv4 struct sockaddr_in *ipv4 = (struct sockaddr_in *)p-\u0026gt;ai_addr; addr = \u0026amp;(ipv4-\u0026gt;sin_addr); ipver = \u0026#34;IPv4\u0026#34;; } else { // IPv6 struct sockaddr_in6 *ipv6 = (struct sockaddr_in6 *)p-\u0026gt;ai_addr; addr = \u0026amp;(ipv6-\u0026gt;sin6_addr); ipver = \u0026#34;IPv6\u0026#34;; } // convert the IP to a string and print it: inet_ntop(p-\u0026gt;ai_family, addr, ipstr, sizeof ipstr); printf(\u0026#34; %s: %s\\n\u0026#34;, ipver, ipstr); } freeaddrinfo(res); // free the linked list return 0; } è¯´æ˜ è¯´æ˜çš„æ•°å€¼æ ‡è¯†å¯¹åº”ä»£ç åé¢çš„æ•°å­—æ³¨é‡Š\naddrinfoæ˜¯ä¸€ä¸ªç‰¹æ®Šçš„ç»“æ„ä½“ï¼Œ ç»“æ„ä½“çš„ç­¾åå¦‚ä¸‹ï¼š 1 2 3 4 5 6 7 8 9 10 11 struct addrinfo { int ai_flags; // AI_PASSIVE, AI_CANONNAME, etc. int ai_family; // AF_INET, AF_INET6, AF_UNSPEC int ai_socktype; // SOCK_STREAM, SOCK_DGRAM int ai_protocol; // use 0 for \u0026#34;any\u0026#34; size_t ai_addrlen; // size of ai_addr in bytes struct sockaddr *ai_addr; // struct sockaddr_in or _in6 char *ai_canonname; // full canonical hostname struct addrinfo *ai_next; // linked list, next node }; å¯ä»¥çœ‹åˆ°addrinfoé™¤äº†ä¼šåŒ…å«ä¸€äº›å’Œç½‘ç»œåœ°å€ï¼Œ socket ç±»å‹ç­‰åŸºç¡€ä¿¡æ¯ä¹‹å¤–ï¼Œ è¿˜æœ‰ä¸€ä¸ªæŒ‡å‘ä¸‹ä¸€ä¸ªåœ°å€çš„æŒ‡é’ˆï¼ˆai_nextï¼‰ï¼Œ ai_addræ˜¯ä¸€ä¸ªæŒ‡å‘sockaddrç»“æ„ä½“çš„æŒ‡é’ˆï¼š\n1 2 3 4 struct sockaddr { unsigned short sa_family; // address family, AF_xxx char sa_data[14]; // 14 bytes of protocol address }; sa_dataå½“ç„¶å­˜å‚¨çš„æ˜¯åè®®åœ°å€ï¼Œ åœ¨å®é™…ä»£ç ç¼–å†™çš„æ—¶å€™æˆ‘ä»¬ä¼šä½¿ç”¨sockaddr_in(ip4åœ°å€)æˆ–è€…sockaddr_in6(ipv6)ï¼Œ ç„¶åè½¬åŒ–ä¸ºsockaddrï¼Œ è¿™é‡Œä¸€sockaddr_inä¸ºä¾‹ï¼Œ å®ƒçš„ç»“æ„æ˜¯ï¼š\n1 2 3 4 5 6 struct sockaddr_in { short int sin_family; // Address family, AF_INET unsigned short int sin_port; // Port number struct in_addr sin_addr; // Internet address unsigned char sin_zero[8]; // Same size as struct sockaddr }; ä¸Šé¢çš„sin_familyå°±æ˜¯ä¸ªæšä¸¾å€¼ï¼Œå’Œaddrinfoçš„ai_familyçš„å€¼å…¶å®æ˜¯ä¸€è‡´çš„ã€‚ ç„¶åæ˜¯ä¸Šé¢çš„in_addrï¼š\n1 2 3 struct in_addr { uint32_t s_addr; // that\u0026#39;s a 32-bit int (4 bytes) }; ç„¶åin_addrå°±æ˜¯ä¸ª4å­—èŠ‚çš„åœ°å€ä¿¡æ¯ï¼ˆipv4åœ°å€ï¼‰\nè¿™é‡Œæˆ‘ä»¬æ²¡æœ‰é™å®šæ˜¯IPV4è¿˜æ˜¯IPV6, å¦‚æœæƒ³è¦é™å®šï¼Œ å¯ä»¥é€šè¿‡AF_INETï¼Œ AF_INET6æ¥é™å®šIPV4æˆ–IPV6 getaddrinfoä¼šè¿”å›ä¸€ä¸ªæ•´æ•°å€¼ï¼Œ å¦‚æœè¯¥å€¼ä¸º0ï¼Œ æ ‡è¯†è¿è¡ŒæˆåŠŸï¼Œ ä¸ç„¶å°±æ˜¯æœ‰é”™è¯¯ è¿™é‡Œæ’ä¸€å¥ï¼š goè¯­è¨€çš„é”™è¯¯å¤„ç†æœºåˆ¶ä»æŸç§æ„ä¹‰ä¸Šæ¥è®²ï¼Œ æ²¿è¢­äº†cè¯­è¨€ï¼Œ ä¹Ÿå°±æ˜¯ç›´æ¥è¿”å›é”™è¯¯ï¼Œ è®©è°ƒç”¨è€…å†³å®šå¦‚ä½•å¤„ç†ï¼Œ è€Œä¸æ˜¯æŠ›å‡ºå¼‚å¸¸çš„è¿™ç§java/pythonçš„æ–¹å¼\nè¿™é‡Œæˆ‘ä»¬è¿›å…¥äº†ä¸€ä¸ªforå¾ªç¯ï¼Œ å‰é¢æˆ‘ä»¬æœ‰æåŠaddrinfoæœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªé“¾è¡¨ï¼Œå®ƒæœ‰ä¸€ä¸ªæŒ‡å‘ä¸‹ä¸€ä¸ªaddrinfoçš„æŒ‡é’ˆï¼Œ æˆ‘ä»¬ä¸æ–­å¾ªç¯è·å–addråœ°å€ï¼Œ ç„¶åç”¨è¿™ä¸ªåœ°å€å»è·å–ipåœ°å€çš„å­—ç¬¦ä¸²ï¼ˆinet_ntopä¸­çš„ntopå®é™…ä¸º network to presentationï¼‰ åº”ç”¨2-ä½¿ç”¨scoketè¿›è¡Œç½‘ç»œä¼ è¾“ ä½¿ç”¨socketè¿›è¡Œé€šè¡Œï¼Œ é€šå¸¸ä¼šç‰µæ¶‰åˆ°ä¸¤ä¸ªè§’è‰²ï¼š\næ¥å—ä¿¡å·çš„ï¼Œ æˆ‘ä»¬ç§°ä¹‹ä¸ºserveræœåŠ¡ç«¯ å‘é€ä¿¡å·çš„ï¼Œ æˆ‘ä»¬ç§°ä¹‹ä¸ºclientå®¢æˆ·ç«¯ serveræ—¢ç„¶æ˜¯æ¥å—ä¿¡å·çš„ï¼Œ æ¶‰åŠçš„æµç¨‹é€šå¸¸ä¼šæœ‰listenï¼ˆç›‘å¬ï¼‰å’Œrecvï¼ˆæ¥å—æ•°æ®ï¼Œ å¦‚æœæ˜¯udpçš„è¯å°±æ˜¯recvtoï¼‰ clientä¸»è¦æ˜¯å‘é€ä¿¡å·çš„ï¼Œ æ‰€ä»¥ä»–é€šå¸¸ä¼šæ¶‰åŠconnectï¼ˆé“¾æ¥ï¼‰å’Œsendï¼ˆä¼ é€ï¼Œ å¦‚æœæ˜¯udpçš„è¯å°±æ˜¯sendtoï¼‰ ä¸Šé¢æ‰€æœ‰çš„æ“ä½œé¦–å…ˆæ˜¯éœ€è¦å›´ç»•è°ƒç”¨socketå‡½æ•°è¿”å›çš„å¥—æ¥å­—æè¿°ç¬¦(socket descriptor)å±•å¼€çš„ ä»£ç  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 #include \u0026lt;string.h\u0026gt; #include \u0026lt;sys/types.h\u0026gt; #include \u0026lt;sys/socket.h\u0026gt; #include \u0026lt;netdb.h\u0026gt; #define MYPORT \u0026#34;3490\u0026#34; // the port users will be connecting to #define BACKLOG 10 // how many pending connections queue will hold int main(void) { struct sockaddr_storage their_addr; socklen_t addr_size; struct addrinfo hints, *res; int sockfd, new_fd; // !! don\u0026#39;t forget your error checking for these calls !! // first, load up address structs with getaddrinfo(): memset(\u0026amp;hints, 0, sizeof hints); hints.ai_family = AF_UNSPEC; // use IPv4 or IPv6, whichever hints.ai_socktype = SOCK_STREAM; hints.ai_flags = AI_PASSIVE; // 1 getaddrinfo(NULL, MYPORT, \u0026amp;hints, \u0026amp;res); // make a socket, bind it, and listen on it: sockfd = socket(res-\u0026gt;ai_family, res-\u0026gt;ai_socktype, res-\u0026gt;ai_protocol); // 2 bind(sockfd, res-\u0026gt;ai_addr, res-\u0026gt;ai_addrlen); // 3 listen(sockfd, BACKLOG); // 4 // now accept an incoming connection: addr_size = sizeof their_addr; ã€ã€ 5 new_fd = accept(sockfd, (struct sockaddr *)\u0026amp;their_addr, \u0026amp;addr_size); //5 // ready to communicate on socket descriptor new_fd! . . . è¯´æ˜ ä½¿ç”¨AI_PASSIVEä½œä¸ºæˆ‘ä»¬ai_flagså°±æ˜¯å‘Šè¯‰ç¨‹åºæˆ‘è¦ç»‘å®šæœ¬æœºçš„ipï¼Œ è¿™ä¹Ÿå°±æ˜¯æ˜¯ä¸ºä»€getaddrinfoçš„ç¬¬ä¸€ä¸ªå‚æ•°å¯ä»¥æ˜¯ç©ºçš„ï¼Œ å› ä¸ºæˆ‘æ˜¯serverï¼Œæ‰€ä»¥ä¸éœ€è¦ç‰¹å®šçš„server nameï¼Œ è¿™é‡Œè°ƒç”¨äº†socketå‡½æ•°ï¼Œ è¿”å›ä¸€ä¸ªå¥—æ¥å­—æè¿°ç¬¦ï¼Œ socketçš„ä¸‰ä¸ªå‚æ•°ï¼Œ ai_familyå°±æ˜¯å‰é¢æåˆ°çš„ipv4æˆ–è€…ipv6ï¼Œ sockettypeæ˜¯å‰é¢æåˆ°çš„SOCKETSTREAMï¼ˆtcpåè®®ï¼‰æˆ–è€…SOCKETDGRAMï¼ˆudpåè®®ï¼‰ bindä½¿ç”¨äº†socketè¿”å›çš„æè¿°ç¬¦å·ï¼Œ ç„¶åä¼šbindåˆ°ä¸€ä¸ªå…·ä½“çš„port ç„¶åserverè°ƒç”¨listeå¼€å¯ç›‘å¬ï¼Œ BACKLOGæ˜¯ä¸€ä¸ªå¸¸é‡ç”¨æ¥æ§åˆ¶èƒ½åŒäº‹ç›‘å¬çš„æœ€å¤§æ•°é‡(å…¶å®å°±æ˜¯é™åˆ¶äº†ç›‘å¬é˜Ÿåˆ—çš„å¤§å°) acceptå…¶å®å°±æ˜¯æŠŠå®¢æˆ·ç«¯çš„connectç»™acceptçš„æ„æ€ï¼Œç„¶åacceptä¼šè¿”å›ä¸€ä¸ªå…¨æ–°çš„å¥—æ¥å­—æè¿°ç¬¦å·ï¼Œ è¿™ä¸ªæ–°çš„æè¿°ç¬¦å°±æ˜¯åç»­ç”¨æ¥send åº”ç”¨3 - ç®€å•çš„server \u0026amp; clientå®ç° å®Œæ•´ä»£ç çš„è¯ï¼Œ ç›´æ¥å‚è€ƒï¼šhttps://beej.us/guide/bgnet/html/split/client-server-background.html\nserverç«¯ æ•´ä½“çš„serverçš„è¿è¡Œæµç¨‹è¿˜æ˜¯éµå¾ªäº†å‰é¢æåˆ°çš„å‡ ä¸ªå…³é”®ç‚¹ï¼š\ngeraddtrinfoè·å–ipåœ°å€ä¿¡æ¯ socket å»ºç«‹ä¸€ä¸ªå¥—æ¥å­—é“¾æ¥è¿”å›socket descriptor bind ç»‘å®šç‰¹å®šport listen ç›‘å¬ accept æ¥å—ä¸€ä¸ªincomming connection send é€šè¿‡socketå‘é€ä¿¡æ¯ ä¸è¿‡è¿™é‡Œä¸ºäº†åŒæ—¶å¤„ç†æ›´å¤šçš„é“¾æ¥ï¼Œ ä¼šç”¨forkå¼€å¯ä¸€ä¸ªå­è¿›ç¨‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 while(1) { // main accept() loop sin_size = sizeof their_addr; new_fd = accept(sockfd, (struct sockaddr *)\u0026amp;their_addr, \u0026amp;sin_size); if (new_fd == -1) { perror(\u0026#34;accept\u0026#34;); continue; } inet_ntop(their_addr.ss_family, get_in_addr((struct sockaddr *)\u0026amp;their_addr), s, sizeof s); printf(\u0026#34;server: got connection from %s\\n\u0026#34;, s); if (!fork()) { // this is the child process close(sockfd); // child doesn\u0026#39;t need the listener if (send(new_fd, \u0026#34;Hello, world!\u0026#34;, 13, 0) == -1) perror(\u0026#34;send\u0026#34;); close(new_fd); exit(0); } close(new_fd); // parent doesn\u0026#39;t need this } forkåœ¨æˆåŠŸå¼€å¯å­è¿›ç¨‹çš„æ—¶å€™ï¼Œ è¿”å›å€¼æ˜¯0ï¼Œ æ‰€ä»¥ !0 å°±æ˜¯true; ä½†æ˜¯è¿™é‡Œæ²¡æœ‰forkå¤±è´¥çš„å¤„ç†é€»è¾‘\nå› ä¸ºç”¨åˆ°äº†å­è¿›ç¨‹ï¼Œ è‡ªç„¶éœ€è¦æœ‰å­è¿›ç¨‹çš„åƒåœ¾å›æ”¶\n1 2 3 4 5 6 7 sa.sa_handler = sigchld_handler; // reap all dead processes sigemptyset(\u0026amp;sa.sa_mask); sa.sa_flags = SA_RESTART; if (sigaction(SIGCHLD, \u0026amp;sa, NULL) == -1) { perror(\u0026#34;sigaction\u0026#34;); exit(1); } å½“ä¸»è¿›ç¨‹é€šè¿‡sigactionè·å–åˆ°äº†SIGCHLDè¿™ä¸ªä¿¡å·çš„æ—¶å€™ï¼Œ ä¼šè§¦å‘å‡½æ•°sigchld_handleræ¥è¿›è¡ŒGCï¼š\n1 2 3 4 5 6 7 8 9 void sigchld_handler(int s) { // waitpid() might overwrite errno, so we save and restore it: int saved_errno = errno; while(waitpid(-1, NULL, WNOHANG) \u0026gt; 0); errno = saved_errno; } clientç«¯ clientçš„ä»£ç ä¼šæ¯”è¾ƒç®€å•ï¼Œ å®ƒçš„æµç¨‹å’Œserveræœ‰å°‘è®¸ä¸ä¸€æ ·ï¼š\ngetaddrinfoï¼Œ ä¸è¿‡ä½œä¸ºclientï¼Œæˆ‘çš„ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯éœ€è¦æŒ‡å®šserver nameçš„ socket connect recvï¼Œ å’ŒæœåŠ¡ç«¯éœ€è¦ä½¿ç”¨acceptè¿”å›çš„æ–°çš„socket descriptoræ¥å‘é€ä¿¡æ¯ï¼Œ clientç›´æ¥ç”¨socketè¿”å›çš„desciptorå°±å¯ä»¥æ¥å—ä¿¡æ¯äº† That\u0026rsquo;s it ","date":"2024-01-01T00:00:00Z","permalink":"https://superjcd.github.io/p/%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B%E5%85%A5%E9%97%A8/","title":"ç½‘ç»œç¼–ç¨‹å…¥é—¨"},{"content":"ç¬¬äºŒç« ï¼š B-Tree Basics B+ æ ‘æ˜¯å‡ ä¹æ‰€æœ‰åŸºäºç£ç›˜çš„å…³ç³»å‹æ•°æ®åº“(mysqlï¼Œ pgç­‰)çš„åŸºç¡€æ•°æ®ç»“æ„ B+ æ ‘æ˜¯Binary Search Treeçš„è¡ç”Ÿï¼Œ æœ‰è·Ÿå¤šçš„fanout, æ‰€ä»¥æœç´¢é€Ÿåº¦ä¼šæ›´å¿«ï¼ˆLog2 -\u0026gt; LogK, å½“ç„¶åœ¨å®ƒä»¬çš„ç®—æ³•å¤æ‚åº¦æ˜¯ä¸€è‡´çš„ï¼‰ B+æ ‘çš„æœç´¢è§ä¸‹å›¾ï¼Œ æ˜¯ä»rootæ ¹èŠ‚ç‚¹ä¸€ç›´å¾€ä¸‹éå†çš„ æ•°æ®çš„å¢åˆ ä¼šè§¦å‘B+æ•°çš„splitå’Œmergeï¼ˆè§¦å‘æ¡ä»¶å°±æ˜¯overflowå’Œunderflowï¼‰ ç¤ºæ„å›¾ B+æ ‘ï¼ˆn keyï¼Œ n+1 pointerç»“æ„ï¼Œ å½“ç„¶æœ‰äº›B+æ ‘åªä¼šåœ¨å¶å­èŠ‚ç‚¹å­˜å‚¨æ•°æ®ï¼Œ ç„¶åå­èŠ‚ç‚¹ä¹‹é—´ç”¨é“¾è¡¨å’ŒåŒå‘é“¾è¡¨æ¥æå‡æŸ¥è¯¢æ•ˆç‡ï¼‰.\nleaf nodeçš„split.\nleaf nodeçš„merge\nnon-leaf nodeçš„split\nnon-leaf nodeçš„merge ä¸Šé¢ä¹Ÿçœ‹åˆ°äº†ï¼Œ æ ‘çš„mergeå’Œsplitæ˜¯æ¯”è¾ƒè€—æ—¶çš„æ“ä½œ(ä»¥splitä¸ºä¾‹ï¼Œ åœ¨æŸäº›åœºæ™¯ä¸‹æ˜¯éœ€è¦ä¸€ç›´å‘ä¸Šé€’å½’çš„)ï¼Œ ç‰¹åˆ«åœ¨ä½¿ç”¨ç£ç›˜çš„åœºæ™¯ä¸‹ï¼Œ é‚£ä¹ˆå‡å°‘è¿™ç§æ“ä½œï¼ˆè°ƒåº¦ï¼‰ï¼Œ æˆ–è€…è¯¥è¡¨æ•°æ®å¤§å°ï¼ˆå‹ç¼©ï¼‰é€šå¸¸ä¼šæ˜¯ä¼˜åŒ–æ•°æ®åº“æ€§èƒ½çš„é‡è¦æ–¹å‘\nç¬¬ä¸‰ç«  File Formats åŸºäºç£ç›˜å­˜å‚¨çš„æ•°æ®åº“ï¼Œ å®ƒçš„ä¸»è¦çš„å­˜å‚¨å•å…ƒæ˜¯Page, å¤§å°ä¸€èˆ¬æ˜¯4kb-16kbä¹‹é—´ï¼Œ åŸºæœ¬ä¸Šä¸€ä¸ªPageå¯¹åº”ä¸€ä¸ªB-Treeçš„èŠ‚ç‚¹\nåŸå§‹çš„Pageç»“æ„ pï¼š æŒ‡é’ˆï¼Œ æŒ‡å‘å­èŠ‚ç‚¹ k: key vï¼š value è¿™ç§ç»“æ„éå¸¸é€‚åˆç”¨æ¥å­˜å‚¨å¤§å°å›ºå®šçš„æ•°æ®ï¼Œ æ¯”å¦‚char(13)æ¥å­˜å‚¨ç”µè¯å·ç (é‚£ä¹ˆæ‰€æœ‰ç”µè¯å·ç éƒ½æ˜¯åŒæ ·é•¿åº¦çš„ï¼Œ è¿™ç§æ–¹å¼çš„å­˜å‚¨å’ŒæŸ¥æ‰¾éå¸¸çš„ä¾¿åˆ©) ä½†æ˜¯è¿™ç§æ–¹å¼æœ€å¤§çš„é—®é¢˜æ˜¯ä¸å¥½å­˜å‚¨å­˜å‚¨å¯å˜é•¿åº¦çš„æ•°æ®ï¼Œ æ¯”å¦‚stringæˆ–è€…text\nslotted page ç°ä»£æ•°æ®åº“çš„pageç»“æ„ï¼Œ ä¸»è¦é‡‡ç”¨çš„æ˜¯slotted pageçš„å½¢å¼ï¼š å¥½å¤„å°±æ˜¯è§£å†³äº†åŸå§‹Pageç»“æ„ä¸å¥½å­˜å‚¨å¯å˜é•¿åº¦è®°å½•çš„é—®é¢˜ï¼Œ åŒæ—¶æ”¯æŒåœ¨æ•°æ®è¢«åˆ é™¤çš„æ—¶å€™è¿›è¡Œæ›´å¥½çš„å†åˆ©ç”¨ï¼ˆä¸‹é¢ä¼šæåŠï¼‰\nCell cellå­˜å‚¨å„ç§ç±»å‹çš„æ•°æ®ï¼Œå®ƒåœ¨Slotted Pageä¸­çš„æ’å…¥æ–¹å¼æ˜¯ä»å°¾éƒ¨å¾€å‰æ’å…¥ï¼Œ ç„¶ååœ¨Headerä¸­çš„Poitnerä¼šä¾æ¬¡ä¿ç•™å„ä¸ªcellçš„offetä¿¡æ¯\nä¸ºä»€ä¹ˆé‡‡ç”¨è¿™æ ·çš„æ’å…¥é¡ºåºå…¶å®ä¹Ÿå¾ˆå¥½ç†è§£ï¼Œ å¦‚æœç›´æ¥ä»å·¦è‡³å³ï¼Œ æ¯æ¬¡æœ‰ä¸€ä¸ªæ–°çš„cell, é‚£ä¹ˆåŸæ¥å­˜å‚¨åœ¨æœ€å·¦ä¾§ï¼ˆç´§æŒ¨ç€Headerï¼‰çš„cellï¼Œ ç”±äºHeaderå˜åŒ–äº†ï¼Œ å®ƒä¹Ÿéœ€è¦ç›¸åº”åœ°å³ç§»ï¼Œ è€Œä»å°¾éƒ¨å‘å‰åˆ™ä¸éœ€è¦\nå½“ç„¶å¦‚æœè¦ä¿æŒOffsetçš„é€»è¾‘é¡ºåº(æ¯”å¦‚æ ¹æ®Cellæ•°æ®çš„å­—æ¯åº)ï¼Œ æˆ‘ä»¬å¯ä»¥è°ƒæ•´Offsetçš„ä½ç½® æ’å…¥é¡ºåºï¼š Tom -\u0026gt; Lesile -\u0026gt; Ronï¼Œ Offsetsçš„é¡ºåºåˆ™æ˜¯Lesile -\u0026gt; Ron -\u0026gt; Tom\nå‰é¢æåˆ°äº†ï¼Œ Slotted Pageåœ¨ç©ºé—´å†åˆ©ç”¨ï¼ˆreclaim spaceï¼Œ åˆ©ç”¨è¢«åˆ é™¤çš„æ•°æ®ï¼‰çš„é«˜æ•ˆæ€§ï¼Œ ä»¥sqlite dbä¸ºä¾‹ï¼Œ æ•°æ®åº“ä¼šç»´æŒä¸€ä»½å¯ä»¥ç”¨spaceçš„æŒ‡é’ˆåˆ—è¡¨. å½“è¦æ’å…¥æ–°çš„æ•°æ®çš„æ—¶å€™ï¼Œ ä¼šä½¿ç”¨First fitæˆ–è€…Best fitç®—æ³•å»æ‰¾åˆ°å“ªä¸€å—ç©ºé—´æœ€æœ€é€‚åˆæ’å…¥æ–°æ•°æ®\nFirst fit: æ‰¾åˆ°ç¬¬ä¸€å—å¯ä»¥å®¹çº³æ–°æ•°æ®çš„space Best fitï¼šæ‰¾åˆ°æµªè´¹æœ€å°çš„space(å°±æ˜¯spaceå’Œæ–°æ’å…¥æ•°æ®å¤§å°çš„å·®å€¼æœ€å°) ä»ç©ºé—´åˆ©ç”¨ç‡ä¸ŠBest fitä¼šæ›´å¥½ï¼Œå½“ç„¶First fité€Ÿåº¦æ˜æ˜¾ä¼šæ›´å¿«\nå‡è®¾ï¼Œ æ²¡æœ‰åŠæ³•æ‰¾åˆ°ä»»æ„ä¸€å—èƒ½å¤Ÿå®¹çº³æ–°æ•°æ®çš„ç©ºç™½spaceï¼Œ å¹¶ä¸”æˆ‘çš„ç©ºç™½spaceæ€»å’Œåˆå¤§äºæ–°æ•°æ®ï¼Œ é‚£è¿™ä¸ªæ—¶å€™å°±éœ€è¦è¿›è¡Œå»ç¢ç‰‡åŒ–(defragmenting)\nCellçš„ç»“æ„ cellæœ‰ä¸¤ç§ï¼Œ ç¬¬ä¸€ç§å«åšKey Cellï¼Œ ä¸»è¦ç”¨æ¥å­˜å‚¨keyã€‚ç¬¬äºŒç§æ˜¯Key-Value Cell, å°±æ˜¯åŒæ—¶ç”¨æ¥å­˜å‚¨keyå’Œvlaueçš„ï¼Œ ä¸€ä¸ªpageä¸Šé¢ï¼Œ é€šå¸¸æ˜¯è¿™æœ‰è¿™ä¸¤ç§keyä¸­çš„ä»»æ„ä¸€ç§çš„(å› ä¸ºä¸¤ç§keyçš„ç»“æ„ç•¥æœ‰ä¸åŒï¼Œ æ‰€ä»¥ä»æ•ˆç‡è§’åº¦ï¼Œ è‚¯å®šæ˜¯å­˜å‚¨ä¸€ç§ç±»å‹çš„ä¼šæ›´å¥½).\nKey Cellç»“æ„ï¼š\ncell type key size child page id key bytes Key-Value Cellç»“æ„:\ncell type key size value size key bytes Data record bytes(ä¹Ÿå°±æ˜¯value bytes) ç¬¬å››ç«  Implementing B-Trees Page Header page headerä¼šå­˜å‚¨ä¸€äº›å’Œpageç›¸å…³çš„å…ƒä¿¡æ¯ï¼Œ é™¤äº†ä¸Šå‰é¢æåˆ°çš„cell offsets, è¿˜ä¼šæœ‰è¯¸å¦‚ï¼š\nMagic numbers sibling links rightmost pointers node high key magic numbersæ˜¯ä¼šå­˜å‚¨åœ¨Pageä¸Šçš„çš„ç‰¹å®šä½ç½®çš„äºŒè¿›åˆ¶çš„å€¼ï¼Œ æ¯”å¦‚å­˜å‚¨ç¬¬51 ï¼Œ 47ï¼Œ 41ï¼Œ 45ä½çš„å€¼ï¼Œ ç›®çš„æ˜¯ä¸ºäº†éªŒè¯pageæœ‰æ²¡æœ‰è¢«æ±¡æŸ“ï¼Œ åªè¦åœ¨è¯»æ•°æ®çš„æ—¶å€™ï¼Œ æ¯”è¾ƒä¸€ä¸‹è¿™å‡ ä½çš„å®é™…å€¼å’Œå­˜å‚¨åœ¨headerä¸­çš„å€¼æ˜¯å¦ä¸€æ ·å³å¯ ä¸€èˆ¬æ¥è¯´æ¯ä¸ªnodeï¼Œ ä¼šå­˜å‚¨nä¸ªkeyä»¥åŠn+1 pointeræŒ‡å‘è¿™ä¸ªnodeçš„å­èŠ‚ç‚¹ï¼Œ è¿™ä¸ªç¬¬nä¸ªkeyç»å¸¸ä¼šè¢«å­˜å‚¨åœ¨page header æœ‰æ—¶å€™ï¼Œ è¿™ç§æ–¹å¼ä¼šæœ‰ä¸€ç§å˜ä½“å°±æ˜¯keyä¼šé¥¿pointerçš„æ•°é‡å¯¹é½ï¼š ä¸Šé¢çš„K3å°±æ˜¯high key\nOverflow pages é€šå¸¸pageçš„sizeæ˜¯å›ºå®šçš„ï¼Œ åœ¨4-16kbä¹‹é—´ï¼Œ è¿‡å¤§çš„sizeä¸å¯é¿å…çš„ä¼šç…§æˆç©ºé—´çš„æµªè´¹ã€‚ ä½†æ˜¯page sizeçš„å›ºå®šè¯ï¼Œ å½“å¯å˜é•¿çš„æ•°æ®è¿‡å¤§çš„æ—¶å€™ï¼Œæˆ‘ä»¬å°±éœ€è¦æœ‰ä¸€ä¸ªæ‰©å±•çš„é¡µå»å­˜å‚¨æº¢å‡ºçš„æ•°æ®, è¿™äº›é¡µå°±è¢«ç§°ä¸ºoverflow page.\nè¯´åˆ°åº•ï¼Œ ç£ç›˜çš„load reloadçš„å¼€é”€è¿‡å¤§æ‰éœ€è¦å›ºå®šsizeçš„pageï¼Œ ä»¥åŠè¿™ç§overflow pageï¼Œ å¦‚æœæ˜¯å†…å­˜ï¼Œ ä¹‹é—´åŸæ¥çš„size æŒ‰æ¯”ä¾‹æ‰©å®¹å°±å¥½äº†\npage headerä¼šä¿ç•™æŒ‡å‘è¿™äº›overflow pageçš„æŒ‡é’ˆï¼ˆoverflow pageä¹Ÿéœ€è¦ä¿ç•™æŒ‡å‘åŸå§‹é¡µé¢çš„æŒ‡é’ˆï¼‰ ä¸€èˆ¬æ¥è¯´è¯´ï¼Œ ä¸€ä¸ªpageåªä¼šæŒ‡å‘å•ä¸€çš„overflow pageï¼Œ å¦‚æœè¿˜æ˜¯æ”¾ä¸ä¸‹ï¼Œ é‚£ä¹ˆå¯ä»¥ç»§ç»­ä»overlow pageå‡ºå‘é“¾æ¥æ–°çš„overflow page\näºŒåˆ†æŸ¥æ‰¾åœ¨é¡µé¢ä¸­åº”ç”¨ ç”±äºpage headerä¸­å¯ä»¥ä»¥é€»è¾‘é¡ºåºä¿ç•™cellçš„offsetsï¼Œ é‚£ä¹ˆæˆ‘ä»¬å®Œå…¨å¯ä»¥å¯¹è¿™äº›offsetè¿›è¡ŒäºŒåˆ†æŸ¥æ‰¾ï¼š å…·ä½“æ­¥éª¤å°±æ˜¯ï¼Œ ç°å–è¿™äº›offsetsä¸­æœ€ä¸­é—´çš„é‚£ä¸ªï¼Œ ç„¶åæ‰¾åˆ°å¯¹åº”çš„cellï¼Œ æ¯”è¾ƒå’ŒæŸ¥æ‰¾é”®çš„å¤§å°æ¥å†³å®šäºŒåˆ†æŸ¥æ‰¾çš„æ–¹å‘æ˜¯å¾€å·¦è¿˜æ˜¯å¾€å³\né¡µçš„Splitå’ŒMergeçš„ä¼ æ’­ éšç€æ•°æ®çš„æ’å…¥å’Œåˆ é™¤ï¼Œ Bæ ‘çš„èŠ‚ç‚¹éœ€è¦è¿›è¡Œç›¸åº”çš„æ‹†åˆ† \u0026amp; åˆå¹¶ï¼Œ è¿™æ„å‘³ç€å­èŠ‚ç‚¹çš„çˆ¶èŠ‚ç‚¹ä»¥ä¹Ÿä¼šå‘ç”Ÿå˜åŒ–ï¼Œ è€Œä¸”è¿™ç§å˜åŒ–é€šå¸¸æ˜¯ä¸€å±‚å±‚å‘ä¸Šä¼ æ’­çš„ã€‚æœ‰æ²¡æœ‰ä¸€ç§é«˜æ•ˆçš„ç®—æ³•å»æ›´æ–°è¿™ç§å˜åŒ– ï¼Œ å…¶ä¸­ä¸€ç§å°±æ˜¯Breadcrumsï¼ˆé¢åŒ…å±‘ï¼‰ï¼Œ è¿™ä¸ªç®—æ³•çš„åç§°å…¶å®å¾ˆå½¢è±¡åœ°æŒ‡å‡ºäº†å®ƒçš„å®ç°æ–¹å¼ï¼š æˆ‘ä»¬æŸ¥æ‰¾æ–°çš„æ’å…¥èŠ‚ç‚¹ï¼Œ ä¸€å®šæ˜¯ä»æ ¹èŠ‚ç‚¹ä¹‹ä¸Šè€Œä¸‹çš„ï¼Œ å¦‚æœæˆ‘ä»¬è®°å½•äº†è¿™ä¸ªpathçš„è¯ï¼Œ é‚£ä¹ˆå°†å…¶é€†åºï¼Œ ä¸å°±æ‰¾åˆ°äº†æ¯ä¸ªå­èŠ‚ç‚¹çš„çˆ¶èŠ‚ç‚¹å˜›ï¼Ÿ æ¯”å¦‚æˆ‘ä»¬è¦æ’å…¥ä¸€ä¸ªå¤§äº37çš„æ•°å€¼ï¼Œ æŸ¥æ‰¾è·¯å¾„å…¥ä¸Šå…¥æ‰€ç¤ºï¼Œ Breadcrumbsè®°å½•äº†æ¯ä¸ªinsertion pointçš„offsetã€‚ Breadcumbsçš„å®ç°ä¸€èˆ¬æ˜¯stack\nRebalancing é€šå¸¸æ¥è®²ï¼Œ æ ‘çš„å†å¹³è¡¡ä¼šæ¶‰åŠåˆ°å¤§é‡çš„splitå’Œmergeï¼Œ è¿›è€Œå½±å“æ•°æ®åº“æ€§èƒ½ã€‚æ‰€ä»¥æ•°æ®åº“é€šå¸¸ä¼šå»¶è¿Ÿsplitå’Œmergeï¼Œ å¹¶ä½¿ç”¨ä¸€ç§ç›¸å¯¹å¼€é”€è¾ƒå°‘çš„æ–¹å¼å»å®ç°reblancing \u0026ndash; å¹³è¡¡é‚»å±…èŠ‚ç‚¹ä¹‹é—´çš„æ•°æ®ï¼Œ æŠŠæœ‰è¾ƒå¤šæ•°æ®çš„èŠ‚ç‚¹çš„æ•°æ®æ¬åˆ°éš”å£çš„èŠ‚ç‚¹ï¼Œ ä»è€Œé¿å…èŠ‚ç‚¹ä¹‹é—´çš„splitå’Œmerge\nRight-only appends å¾ˆå¤šåœºæ™¯ä¸‹ ï¼Œ æ•°æ®åº“éƒ½æœ‰ä¸€ä¸ªè‡ªå¢çš„é”®æ¯”å¦‚ä¸€ä¸ªè‡ªå¢çš„idï¼Œ å¦‚æœè¿˜æ˜¯é‡‡ç”¨å¸¸è§„çš„è‡ªä¸Šè€Œä¸‹çš„æŸ¥æ‰¾æ–¹å¼æ˜¯çº¯ç²¹çš„æµªè´¹æ—¶é—´ã€‚ Postgresqlç­‰æ•°æ®åº“ï¼Œ ä¼šç›´æ¥æ¯”è¾ƒæ’å…¥çš„keyçš„å€¼å’Œæœ€å³é¡µï¼ˆå­˜å‚¨æœ€å¤§æ•°æ®çš„pageï¼‰çš„ç¬¬ä¸€ä¸ªkeyè¿›è¡Œæ¯”è¾ƒï¼Œ å¦‚æœæŸ¥è¦æ’å…¥çš„keyçš„å€¼æ›´å¤§ä¸”è¯¥é¡µä»æœ‰è¶³å¤Ÿç©ºé—´ï¼Œ é‚£ä¹ˆå°±ç›´æ¥æŠŠæ•°æ®æ’å…¥åˆ°è¿™ä¸ªæœ€å³é¡µä¸Šï¼Œ é¿å…äº†è‡ªä¸Šè€Œä¸‹çš„æŸ¥æ‰¾ï¼ˆè®¡ç®—å¤æ‚åº¦å˜åŒ–ï¼š LogN -\u0026gt; å¸¸æ•°æ—¶é—´ï¼Œæ”¹è¿›å¾ˆå¤§ï¼‰ï¼Œè¿™ç§æ–¹å¼ä¹Ÿå«fast path\nå‹ç¼© æ•°æ®çš„å‹ç¼©ä¼šç‰µæ¶‰åˆ°ä¸€ä¸ªå¾ˆé‡è¦çš„æŒ‡æ ‡ï¼š å‹ç¼©ç‡:\næ›´é«˜çš„å‹ç¼©ç‡æ„å‘³ç€æ›´å¥½çš„ç©ºé—´åˆ©ç”¨ç‡ åŒæ—¶æ„å‘³ç€ï¼Œ æ›´é«˜çš„æ—¶é—´å¤æ‚åº¦ï¼Œ å› ä¸ºè§£å‹ç¼©ä¼šæ¶ˆè€—å¤§é‡çš„cpuèµ„æº å¾ˆæ˜æ˜¾ï¼Œ è¿™é‡Œæœ‰ä¸€ä¸ªéå¸¸é‡è¦çš„tradeoff : ç©ºé—´vsæ—¶é—´\nå¦å¤–é€šå¸¸æ¥è®²ï¼Œ æˆ‘ä»¬ä¸ä¼šå†æ–‡ä»¶å±‚çº§å»å‹ç¼©æ•°æ®ï¼Œ åªä¼šåœ¨pageçº§åˆ«ï¼Œ å¾ˆæ˜æ˜¾å‰è€…ä¼šå½±å“æŸ¥è¯¢æ•ˆç‡ã€‚\nå¦å¤–å‹ç¼©çš„æ–¹å¼é™¤äº†å’Œpageç»‘å®šåœ¨ä¸€èµ·ï¼Œ ä¹Ÿå¯ä»¥ä½œä¸ºä¸€ç§æ’ä»¶çš„å½¢å¼è¿›è¡Œï¼Œ å’Œpageçš„ç®¡ç†è¿›è¡Œè§£è€¦ï¼ˆæ¯”å¦‚å¯¹æ•´ä¸ªcolumnçš„æ•°æ®è¿›è¡Œå‹ç¼©ï¼Œ å…¶å®åˆ—å¼æ•°æ®å°±æ˜¯è¿™ä¹ˆåšçš„ï¼‰\nç¬¬äº”ç«  Transaction Processing and Recovery Buffer managment ç±»ä¼¼äºIOç³»ç»Ÿï¼Œ æ•°æ®åº“ä¹Ÿä¼šä½¿ç”¨ç±»ä¼¼ç¼“å­˜é¡µ(page cache)çš„æ¦‚å¿µæ¥ç®¡ç†è®¿é—®æ•°æ®çš„ç¼“å­˜ã€‚\nä¸Šå›¾å±•ç¤ºäº†B+æ ‘çš„èŠ‚ç‚¹Pageåœ¨ç¼“å­˜æ± ä»¥åŠåœ¨ç£ç›˜ä¸Šçš„å¯¹åº”å…³ç³»ã€‚ Page cacheæœºåˆ¶çš„åŒ…æ‹¬ï¼š\nå°†æ•°æ®ä¿ç•™åœ¨å†…å­˜ å¦‚æœè¦çš„Pageåœ¨å†…å­˜ä¸­ï¼Œ ç›´æ¥è¿”å›ç¼“å­˜é¡µ å¦‚æœéœ€è¦çš„Pageä¸å†å†…å­˜ä¸­ï¼Œ ä¸”Buffer poolè¶³å¤Ÿå¤§ï¼Œ ä¼šå°†è¯¥é¡µå­˜å‚¨åœ¨ç¼“å­˜æ± ï¼ˆpage inï¼‰ å¦‚æœæ²¡æœ‰è¶³å¤Ÿç©ºé—´æ¥å­˜å‚¨æ–°çš„ç¼“å­˜é¡µï¼Œ å°±éœ€è¦è¿è¡ŒæŸç§æœºåˆ¶æ·˜æ±°ï¼ˆevictionï¼‰ä¸€éƒ¨åˆ†ç¼“å­˜é¡µï¼ˆæ¯”å¦‚ä½¿ç”¨LFU, LRUï¼Œ CLOCKç­‰ç®—æ³•ï¼‰ï¼Œ ç„¶åå½“ç¼“å­˜é¡µè¢«æ·˜æ±°çš„æ—¶å€™ï¼Œ ä¼šå†™é“ç£ç›˜ä»¥ä¿è¯æ•°æ®çš„ä¸€è‡´æ€§ ç¼“å­˜é¡µå¯ä»¥çœ‹ä½œæ˜¯æ•°æ®è¯·æ±‚å’Œç£ç›˜ä¹‹é—´çš„ä¸­é—´å±‚ï¼Œ é™¤äº†æ•°æ®çš„è¯»å–ï¼Œ æ•°æ®çš„å˜æ›´å…¶å®ä¹Ÿæ˜¯ä¼˜å…ˆå‘ç”Ÿåœ¨è¿™ä¸ªä¸­é—´å±‚ï¼Œ è€Œä¸æ˜¯ç›´æ¥å†™å…¥åˆ°ç£ç›˜ï¼Œ åœ¨å†…å­˜ä¸­çš„ç¼“å­˜é¡µæ•°æ®è¢«ä¿®æ”¹çš„æ—¶å€™ï¼Œ è¿™ä¸ªæ—¶å€™è¿™ä¸ªé¡µé¢å°±ä¼šè¢«æ ‡è¯†è„é¡µ(dirty page), æ ‡è¯†å’Œç£ç›˜æ•°æ®ä¸åŒæ­¥ã€‚ å½“ç„¶dirty pageä¸­çš„æ•°æ®æœ€åä¸€å®šä¼šè¢«å†™å…¥åˆ°ç£ç›˜ï¼Œ ä¸ºäº†ä¿è¯è¿™ä¸ªè¿‡ç¨‹ä¸ä¼šå‡ºç°çº°æ¼ï¼ˆæ¯”å¦‚ç”±äºåœç”µç­‰åŸå› ï¼Œ æ”¹å˜çš„æ•°æ®æ²¡æœ‰è¢«åŒæ­¥åˆ°ç£ç›˜ï¼Œ è¿›è€Œå½±å“äº†æ•°æ®åº“çš„ACIDä¿è¯ï¼‰ï¼Œ é€šå¸¸ä¼šä½¿ç”¨ä¸€ç§å«åšWALï¼ˆwrite ahead log, é¢„å†™æ—¥å¿—ï¼‰çš„æœºåˆ¶æ¥ä¿è¯æ•°æ®çš„ä¸€è‡´æ€§\nWALå…¶å®å°±æ˜¯ä¸€ç³»åˆ—çš„æ•°æ®å˜æ›´è®°å½•ï¼Œ é€šå¸¸ä¼šåœ¨äº‹åŠ¡æˆåŠŸå‘ç”Ÿä¹‹åï¼ˆcommitï¼‰è¢«ä¿å­˜åœ¨ç£ç›˜ï¼Œ ç”±äºå¾ˆå¤šæ¡è®°å½•å…¶å®å¯ä»¥è¢«åˆå¹¶æˆä¸€æ¡ï¼Œ æ¯”å¦‚å¯¹ä¸€ä¸ªè´¦æˆ·Aå¢åŠ 1000ï¼Œ è®°å½•ä¸€æ¬¡ï¼Œ å‡å°‘1000å†è®°å½•ä¸€æ¬¡ï¼Œ é‚£è¿™ä¸¤æ¡è®°å½•å°±å¯ä»¥è¢«æŠµæ¶ˆæ‰ï¼Œ å¦å¤–WALè™½ç„¶æ˜¯åŸºäºç£ç›˜çš„ï¼Œ ä½†æ˜¯å®ƒæ˜¯é¡ºåºå†™å…¥è€Œä¸æ˜¯éšæœºå†™å…¥ ï¼Œæ‰€ä»¥å®ƒçš„å†™å…¥é€Ÿåº¦ä¹Ÿæ˜¯å¾ˆå¿«çš„\nç¼“å­˜é¡µæ·˜æ±°æœºåˆ¶ å¸¸è§çš„æœ‰LRUï¼ˆLeast Recently Usedï¼‰, LFU(Least Freaquntly Used)ï¼ŒCLOCKã€‚ LRUä¼šæ¯”è¾ƒä¾§é‡ä¸€ä¸ªæ—¶æ•ˆæ€§ï¼Œ è¶Šæ˜¯è¢«æœ€è¿‘è®¿é—®çš„PageåŸå®¹æ˜“è¢«ç¼“å­˜ï¼ˆæœ€æ–°è®¿é—®çš„pageä¼šè¢«æ”¾åˆ°é“¾è¡¨çš„å°¾éƒ¨ï¼Œ ç„¶åé“¾è¡¨å¤´éƒ¨çš„æ•°æ®ä¼šè¢«æ·˜æ±°æ‰ï¼‰ï¼Œ åœ¨å®è·µä¸­(ä¸åªæ˜¯æ•°æ®åº“é¢†åŸŸ)ï¼Œ LFUé€šå¸¸ä¼šæ›´å¸¸ç”¨ä¸€ç‚¹ï¼Œ LFUç›¸è¾ƒäºLRUä¼šæ›´ä¾§é‡Pageçš„è®¿é—®é¢‘ç‡ï¼Œ ä½é¢‘çš„é¡µä¼šè¢«æœ‰é™æ·˜æ±°\nClockæœºåˆ¶\nclcokæœºåˆ¶å°±æ˜¯ç”¨ä¸€ç§ç¯å½¢é“¾è¡¨å°†æ‰€æœ‰çš„Pageç»„ç»‡åœ¨ä¸€èµ·ï¼Œ å½“é¡µé¢è¢«è®¿é—®ï¼Œ å®ƒå°±ä¼šè¢«è®¾ç½®ä¸º1ï¼ˆä¸Šå›¾ç°è‰²æ‰€ç¤ºï¼‰ï¼Œ å½“åå°è¿è¡Œæ·˜æ±°ä»»åŠ¡çš„æ—¶å€™ï¼Œ \u0026lsquo;æŒ‡é’ˆ\u0026rsquo;éšæœºæŒ‡å‘ä¸€ä¸ªPage, å¦‚æœå®ƒæ˜¯0ï¼ˆæœ€è¿‘æ²¡æœ‰è¢«è®¿é—®ï¼‰å°±ä¼šè¢«æ·˜æ±°æ‰ï¼Œ ä¹Ÿå°±æ˜¯è¯´å®ƒå’ŒLRUç›¸æ¯”ï¼Œ å¢åŠ äº†ä¸€ä¸ªéšæœºæ€§ å¦‚æœå¯¹clockæœºåˆ¶è¿›è¡Œä¸€å®šçš„æ”¹é€ ï¼Œ æŠŠ1å’Œ0çš„bitæ ‡è¯†æ”¹æˆæ•°å€¼(è¢«å¼•ç”¨æ¬¡æ•°)ï¼Œ ç„¶åå½“ä¸€ä¸ªç¼“å­˜é¡µç ï¼Œæ¯æ¬¡è®¿é—®çš„æ—¶å€™ï¼Œ å®ƒå¯¹åº”çš„æ•°å€¼å°±ä¼š+1ï¼Œ æ·˜æ±°æŒ‡é’ˆè½¬åŠ¨çš„æ—¶å€™åˆ™-1, å¦‚æœæ˜¯0å°±è¯¥é¡µå°±ä¼šè¢«æ·˜æ±°ï¼Œ é‚£ä¹ˆå®ƒå°±è¢«æ”¹é€ æˆäº†ç±»ä¼¼LFUçš„æ¨¡å¼\næ•°æ®åº“æ—¥å¿— æˆ‘ä»¬åœ¨å‰é¢çš„Buffer managementçš„æ—¶å€™æåˆ°è¿‡æ·˜æ±°ç¼“å­˜é¡µæ—¶ï¼Œå°±éœ€è¦å°†æ•°æ®å†™å…¥ç£ç›˜ï¼Œ ä¸ºäº†ä¿è¯æ•°æ®çš„ä¸€è‡´æ€§ï¼Œ éœ€è¦ç”¨åˆ°WALã€‚WALæœ¬è´¨ä¸Šæ˜¯ä¸€ç§æ—¥å¿—ï¼Œ åœ¨æŸäº›æ•°æ®åº“è¿˜ä¼šæŒ‰ç…§åŠŸèƒ½åŒºåˆ†ä¸ºï¼š redoæ—¥å¿—ï¼Œ undoæ—¥å¿—ï¼Œ ç®€å•æ¥è®²redoæ˜¯ä¸ºäº†æ•°æ®æ¢å¤çš„ï¼Œ undoæ˜¯ä¸ºäº†å°†å·²ç»ä¿å­˜åˆ°äº†æ•°æ®åº“çš„æ•°æ®æ’¤å›çš„ã€‚ ç„¶åæ—¥å¿—çš„ç±»å‹ä¼šæœ‰ä¸¤ç§ï¼Œ ä¸€ç§æ˜¯ç‰©ç†æ—¥å¿—(pysical log)ï¼Œ æ—¥å¿—æ–‡ä»¶å°†ä¼šå°†æ•°æ®ç›´æ¥è®°å½•åœ¨æ—¥å¿—ä¸­ï¼› å¦ä¸€ç§æ˜¯é€»è¾‘æ—¥å¿—(logical log)ï¼Œ é€»è¾‘æ—¥å¿—åªè®°å½•äº†æ“ä½œè€Œæ²¡æœ‰æ•°æ®ã€‚å› ä¸ºç‰©ç†æ—¥å¿—æœ‰æ•°æ®ï¼Œ æ‰€ä»¥é€šå¸¸ä¼šè¢«ç”¨åœ¨redoé˜¶æ®µï¼Œ è¿™æ ·æ•°æ®æ¢å¤ä¼šæ›´å¿«ï¼Œ é€»è¾‘æ—¥å¿—åˆ™ä¼šè¢«ç”¨åœ¨undoé˜¶æ®µ è¿™é‡Œæˆ‘ä»¬è¯´ä¹‹æ‰€ä»¥ä¼šéœ€è¦undoæ•°æ®ï¼ˆå†™å…¥äº†ç£ç›˜çš„æ•°æ®å¹¶æ²¡æœ‰å®Œæˆcommitï¼‰ï¼Œ å†™å…¥ç£ç›˜çš„æ“ä½œå…è®¸è¢«å‘ç”Ÿåœ¨commitä¹‹åï¼Œ è¿™ç§æ•°æ®åº“ç­–ç•¥é€šå¸¸è¢«ç§°ä¸ºno-force/steal ç­–ç•¥ï¼Œç›¸å¯¹çš„force/no-stealåˆ™ä¼šè¦æ±‚æ•°æ®åœ¨commitä¹‹å‰å†™å…¥æ•°æ®ï¼Œ æ‰€ä»¥forceç­–ç•¥ä¸‹ï¼Œ æ•°æ®åº“åœ¨æ¢å¤çš„æ—¶å€™åªè¦å…³å¿ƒredoæ—¥å¿—å°±å¥½ï¼Œ å› ä¸ºæ ¹æ®ç­–ç•¥ï¼Œ ä½†å‡¡æ˜¯æ—¥å¿—ä¸­æ˜¾ç¤ºcommitæ˜¯å…ˆéœ€è¦å†™å…¥ç£ç›˜çš„ã€‚ ä½†æ˜¯ä¸ºå•¥æ•°æ®åº“è¿˜ä¼šå…è®¸no-forceçš„è¿™ç§å‘ç”Ÿå†™ç›˜æ“ä½œåœ¨commitä¹‹åçš„æ“ä½œå­˜åœ¨å‘¢ï¼Œ åŸå› ä¹Ÿå¾ˆç®€å•ï¼Œ æå‡tansactionçš„é€Ÿåº¦ã€‚ æœ€åï¼Œ å…³äºæ•°æ®åº“æ—¥å¿—è¿˜æœ‰ä¸€ä¸ªæ¦‚å¿µæ˜¯checkpointï¼Œ é¡¾åæ€ä¹‰å°±æ˜¯æ—¥å¿—çš„è®°å½•ç‚¹ï¼Œ æ¯ä¸ªcheckpointéƒ½æœ‰ä¸€ä¸ªå¯¹åº”çš„LSNï¼ˆlog sequence number, å•è°ƒå¢ï¼‰ï¼Œ ç›®çš„æ˜¯ä¸ºäº†æ›¿èº«redoå’Œundoæ•ˆç‡çš„ï¼Œ æœ‰äº†checkpontæˆ‘è‡ªè¦ä»ä¸Šä¸€ä¸ªLSNè¿›è¡Œæ•°æ®æ¢å¤æ“ä½œå°±å¥½äº†ï¼Œ è€Œä¸éœ€è¦æ¯æ¬¡æŠŠæ‰€æœ‰è„é¡µè¿›è¡Œå†™ç›˜\nå¹¶å‘æ§åˆ¶ æ•°æ®åº“ä¸­ç”±äºå¹¶å‘å¼•èµ·çš„è¯»å†™å¼‚å¸¸ï¼Œ å…¶å®å’Œéš”ç¦»çº§åˆ«ï¼ˆisolation levelï¼‰æœ‰å…³ï¼Œ å¸¸è§çš„éš”ç¦»çº§åˆ«æœ‰(ä»ä½åˆ°é«˜)ï¼š\nRead Uncomiited, å…è®¸äº‹åŠ¡å¹¶å‘è¯»å–åˆ«çš„æ²¡æœ‰æäº¤çš„äº‹åŠ¡ï¼Œ è¿™ç§éš”ç¦»çº§åˆ«ä¸‹ï¼Œ å¾ˆå®¹æ˜“å¯¼è‡´è„è¯» Read Commited, ä¸€ä¸ªäº‹åŠ¡åªèƒ½å»è¯»å·²ç»è¢«æäº¤äº†è®°å½•ã€‚ä½†æ˜¯è¿™ç§éš”ç¦»çº§åˆ«ä¾ç„¶æ— æ³•ä¿è¯å¯¹ç›¸åŒæ•°æ®åŒæ—¶è¯»å–ï¼ˆå·²ç»éƒ½æ˜¯æäº¤äº†çš„ï¼‰ï¼Œ èƒ½è§‚å¯Ÿåˆ°ç›¸åŒçš„æ•°æ®ï¼› å› ä¸ºæœ‰å¯èƒ½åœ¨æ•°æ®è¯»å–çš„è¿‡ç¨‹ä¸­ï¼Œ æ•°æ®å‘ç”Ÿäº†æ”¹å˜ï¼Œ å¯¼è‡´å¹¶éè¯»çœ‹åˆ°ä¸ä¸€æ ·ç»“æœ Reapetable Readï¼Œæ‰€ä»¥åœ¨ä¸Šä¸€ä¸ªéš”ç¦»çº§åˆ«çš„åŸºç¡€ä¸Šï¼Œ è¿™ä¸ªçº§åˆ«èƒ½ä¿è¯ å¯¹æ•°æ®çš„åŒæ—¶è®¿é—®ï¼Œ è·å–ç›¸åŒçš„ç»“æœ Serializableï¼Œ æœ€å¼ºçš„éš”ç¦»çº§åˆ«ï¼Œ æ„å‘³ç€æ‰€æœ‰çš„äº‹åŠ¡éƒ½æ˜¯æŒ‰ç…§æ—¶åºå±•å¼€ï¼Œ ä¼šæœ‰æœ€å¼ºçš„æ•°æ®ä¸€è‡´æ€§ä¿è¯ï¼Œä¹Ÿå°±æ„å‘³ç€æœ€ç³Ÿç³•çš„å¹¶å‘æ€§èƒ½ ä¸‹å›¾å±•ç¤ºäº†å„ç§éš”ç¦»çº§åˆ«å¯¹åº”çš„è¯»å†™å¼‚å¸¸çš„å¯èƒ½æ€§ï¼Œ å¯ä»¥çœ‹åˆ°SeriaizableåŸºæœ¬æ˜¯ç»ç¼˜æ‰€æœ‰å¹¶å‘å¼•èµ·çš„è¯»å†™å¼‚å¸¸ï¼Œ å½“ç„¶ä»£ä»·å°±æ˜¯ç‰ºç‰²å¹¶å‘.\n3ç§å¹¶å‘æ§åˆ¶æµæ´¾ æœ‰ä¸‰ç§å¸¸è§çš„å¹¶å‘æ§åˆ¶æµæ´¾ï¼š\nOCCï¼Œ Optimistic concurrency control MVCC, Multiversion concurency control PCC, Pessimistic concurency control OCC æŠŠäº‹åŠ¡åˆ†æˆä¸‰ä¸ªé˜¶æ®µï¼š\nRead phase Validation phase Write phase åœ¨ç¬¬ä¸€é˜¶æ®µï¼Œ ä¼šæŠŠæ‰€æœ‰å¹¶å‘çš„äº‹åŠ¡çš„dependencyå†™å…¥åˆ°read setï¼ˆä¸æ”¹å˜æ•°æ®åº“çŠ¶æ€çš„æ“ä½œï¼‰å’Œwrite setä¸­ï¼ˆä¼šæœ‰å‰¯ä½œç”¨ï¼Œ ä¼šæ”¹å˜æ•°æ®åº“æ“ä½œï¼‰ ç¬¬äºŒé˜¶æ®µï¼Œ å°±æ˜¯æ ¹æ®read setå’Œwrite setä¸­çš„æ“ä½œï¼Œ ç‰¹åˆ«æ˜¯æœ‰ç›¸äº¤ï¼ˆå†²çªï¼‰éƒ¨åˆ†çš„æ“ä½œï¼Œ å¯¹é‚£äº›å¯èƒ½ä¼šå—å½±å“çš„äº‹åŠ¡ï¼Œ æ¯”å¦‚ä¸€ä¸ªè¯»ç›¸å…³çš„äº‹åŠ¡ï¼Œ å®ƒçš„æ•°æ®æ­£åœ¨è¢«å¦ä¸€ä¸ªäº‹åŠ¡å†™ï¼Œ é‚£ä¹ˆè¿™ä¸ªè¯»çš„äº‹åŠ¡å°±ä¼šè¢«ç»ˆæ­¢ï¼Œ ä¸ç„¶ä¼šå¯¼è‡´è„è¯» ç¬¬ä¸‰é˜¶æ®µï¼Œ å½“ç„¶ï¼Œ å¦‚æœåœ¨ç¬¬äºŒé˜¶æ®µä¸­æ²¡æœ‰æ£€æŸ¥åˆ°å†²çªï¼Œå°±å¯ä»¥é¡ºåˆ©çš„æäº¤\nMVCC ç®€å•æ¥è®²å°±æ˜¯ç»™æ‰€æœ‰çš„äº‹åŠ¡ä¸€ä¸ªå•è°ƒå¢çš„äº‹åŠ¡IDï¼Œ MVCCé€šå¸¸ä¸ä¼šé˜»æ­¢ä½ å»å–æ—§çš„æ•°æ®ï¼Œ ä½†æ˜¯é€šå¸¸ä¼šç¡®ä¿åœ¨ç³»ç»Ÿé‡Œé¢åªå­˜åœ¨ä¸€ä¸ªæ²¡æœ‰æäº¤çš„äº‹åŠ¡ç‰ˆæœ¬ï¼ˆversionï¼‰\næ‰€ä»¥è¿™ç§æ–¹å¼åº”è¯¥ä¼šäº§ç”Ÿè„è¯»ï¼Œ ä½†æ˜¯å› ä¸ºåªå…è®¸è€½ææœªæäº¤äº‹åŠ¡ç‰ˆæœ¬ï¼Œ æ‰€ä»¥æœ€ç»ˆä¸€è‡´æ€§è¿˜æ˜¯å¯ä»¥ä¿è¯çš„\nPCC PCCé€šå¸¸ä¼šå’Œé”ä¸€èµ·å‡ºç°ï¼Œ å½“ç„¶ä¹Ÿæœ‰ä¸éœ€è¦è¦é”çš„å®ç°æ–¹å¼ï¼Œ å…¶ä¸­æœ€ç®€å•çš„PCCå®ç°æ–¹å¼å°±æ˜¯åŸºäºæ—¶é—´æˆ³ï¼Œ é€šå¸¸ä¼šæœ‰ä¸¤ä¸ªæ—¶é—´æˆ³ï¼š\nmax_read_timestamp max_write_timestamp é™¤äº†å†™æ“ä½œè¢«å…è®¸å¯ä»¥åœ¨max_write_timestampä¹‹å‰è¢«æ‰§è¡Œï¼Œ å…¶ä»–çš„æ“ä½œä¸èƒ½åœ¨å¦ä¸€ä¸ªè¯»å†™æ“ä½œçš„æœ€å¤§timestampæ‰§è¡Œ ç›¸å¯¹è€Œè¨€ï¼Œ åŸºäºé”çš„å®ç°æ–¹å¼ä¼šæ›´åŠ æµè¡Œ\né” æ­»é”Deadlock æ­»é”ä¼šå‘ç”Ÿåœ¨ä¸¤ä¸ªè¿›ç¨‹æˆ–è€…è¯´äº‹åŠ¡éƒ½åœ¨ç­‰å¾…å½¼æ­¤å»é‡Šæ”¾é”ï¼Œ æœ‰ç‚¹ç±»ä¼¼äºå¾ªç¯å¼•ç”¨çš„é—®é¢˜(Aæ¨¡å—è¦å¯¼å…¥bï¼Œ bæ¨¡å—ä¹Ÿè¦å¯¼å…¥A)\næ€ä¹ˆå»è§£å†³æ­»é”å‘¢ï¼Œ å½“ç„¶ä¸€ç§ç®€å•çš„æ–¹å¼å°±æ˜¯ç»™ç™»å°åŠ ä¸Šä¸€ä¸ªtimeoutæ—¶é—´ï¼Œ è¿™æ ·å°±å¯ä»¥é¿å…é™·å…¥æ— é™ç­‰å¾…ã€‚ è¿˜æœ‰æ–¹å¼å°±æ˜¯è®©ç³»ç»Ÿå»è¯†åˆ«è¿™ç§å¯èƒ½é€ æˆæ­»é”çš„çŠ¶æ€ï¼Œ ä¹Ÿå°±æ˜¯ä¸€ä¸ªåå°ç¨‹åºå»æ£€æŸ¥äº‹åŠ¡ç›´æ¥å­˜åœ¨ä¸å­˜åœ¨ä¸Šé¢çš„waits-for graphï¼Œ å¦‚æœå­˜åœ¨å°±åœæ‰å…¶ä¸­çš„ä¸€ä¸ªäº‹åŠ¡ã€‚\nLatches Latchä¹Ÿæ˜¯é”ï¼Œ ä½†æ˜¯å’Œlockä¸ä¸€æ ·çš„ç‚¹åœ¨äºï¼Œ lockæ›´å¤šçš„æ˜¯ä¸€ç§æ›´é«˜é«˜çº§çš„æŠ½è±¡æ¦‚å¿µï¼Œè¿œç¦»æ•°æ®åº“å†…æ ¸çš„å­˜å‚¨ç»“æ„ã€‚ è€Œlatchï¼Œ åˆ™æ˜¯æ›´æ¥è¿‘æ•°æ®å­˜å‚¨ç»“æ„çš„ï¼Œ å®ƒæ˜¯ç”¨æ¥è§£å†³Pageå±‚é¢ä¹Ÿå°±æ˜¯æ›´åº•å±‚çš„ç«äº‰é—®é¢˜çš„ã€‚ æˆ‘ä»¬å¯ä½ æ˜¯ä¸å¸Œæœ›ä¸€ä¸ªPageåœ¨è¢«æ›´é«˜æˆ–è€…è¯´è¦è¢«splitå’Œmergeçš„æ—¶å€™è¢«è®¿é—®ï¼Œ å› ä¸ºè¿™æ ·å¾ˆå¯èƒ½ä¼šå¯¼è‡´æˆ‘ä»¬å‰é¢æåˆ°çš„è¯»å¼‚å¸¸ï¼Œ æ‰€ä»¥éœ€è¦Latchåœ¨æ›´åº•å±‚å¸®æˆ‘ä»¬å»æ§åˆ¶ç«äº‰ã€‚ ä½†æ˜¯ç”±äºBæ ‘çš„ç‰¹æ®Šæ€§ï¼Œ æˆ‘ä»¬çŸ¥é“å­èŠ‚ç‚¹çš„mergeå’Œsplitå¾ˆæœ‰å¯èƒ½ä¼šå‘ä¸Šä¼ æ’­åˆ°rootï¼ˆå½“ç„¶åªæ˜¯å¯èƒ½ï¼Œ å¹¶ä¸æ˜¯ç»å¯¹ï¼‰ï¼Œ é‚£ä¹ˆä»…ä»…åœ¨æŸä¸ªé¡µé¢ä¸Šè¿›è¡Œç«äº‰æ§åˆ¶æ˜¯ä¸å¤Ÿçš„ã€‚ä¸€ç§ç›¸å¯¹æœ´ç´ çš„å®ç°æ–¹æ³•ï¼Œ å°±æ˜¯å¯¹æ•´ä¸ªè®¿é—®è·¯å¾„ä¸Šçš„æ‰€æœ‰PageåŠ ä¸ŠLatch, æ·¡ç„¶è¿™ç§è‚¯å®šèƒ¡ç‰ºç‰²æ€§èƒ½ã€‚ æ‰€ä»¥æ›´å¸¸ç”¨çš„æ–¹å¼ï¼Œ æ˜¯ä½¿ç”¨Latch crabbingçš„ä¸€ç§æ–¹å¼ï¼šè¿™ç§æ–¹å¼å®ƒä¸ä¼šä¸€ç›´ä¿ç•™æ•´ä¸ªè®¿é—®è·¯å¾„ä¸Šçš„pageä¸Šçš„é”ï¼Œ è€Œæ˜¯ä»æ ¹èŠ‚ç‚¹å¼€å§‹ï¼Œ ä¸æ–­å‘ä¸‹ï¼Œ åªè¦å½“å‰èŠ‚ç‚¹ä¸æ˜¯fullçš„çŠ¶æ€(æ„å‘³ç€å¤§æ¦‚ç‡ä¸ä¼šè¢«è‡³ä¸‹è€Œä¸Šçš„split mergeå½±å“ï¼‰ æˆ‘ä»¬å°±æ‰“å¼€è¿™ä¸ªé”ï¼Œ æ‰€ä»¥åœ¨ç‰¹ç‚¹çš„æ—¶é—´èŠ‚ç‚¹ï¼Œ Latch crabingåªä¼šç»™å¾ˆå°ä¸€éƒ¨åˆ†pageåŠ é”\nç¬¬å…­ç«  B-Tree Variants å¦‚ä½•æå‡åŸºäºB-Treeå­˜å‚¨ç»“æ„çš„æ•°æ®åº“è¯»å†™æ•ˆç‡å‘¢ï¼Œ ä¸»è¦çš„æ”¹è¿›æ–¹å‘å…¶å®å°±æ˜¯-\u0026gt;å‡å°‘è®¿é—®ç¡¬ç›˜çš„æ¬¡æ•°å’Œæ—¶é—´ï¼ˆç‰¹åˆ«æ˜¯å‡å°‘å°æ‰¹é‡çš„å†™å…¥ï¼‰, å†è¿™ç§æ‰€æåˆ°çš„æ‰€æœ‰æ”¹è¿›æ–¹æ³•éƒ½æ˜¯å›´ç»•è¿™ä¸ªæ ¸å¿ƒç‚¹æ¥çš„\nCopy-on-write B-Tree ä¼ ç»Ÿçš„B-æ ‘ï¼Œ ä¸€èˆ¬åº•å±‚ä½¿ç”¨latchæ¥è§£å†³å†å¹¶å‘æ—¶çš„é—®é¢˜ï¼Œ copy-on-writeç›´æ¥èˆå¼ƒäº†è¿™ç§æ–¹å¼ï¼Œç›´æ¥å¤åˆ¶ä¼šè¢«ä¿®æ”¹çš„page(ä¹Ÿå°±æ˜¯è„é¡µ)ï¼ŒåŒæ—¶ä¸ä¼šé˜»æ­¢ç”¨æˆ·è®¿é—®æ—§æ•°æ®ã€‚ å½“æ–°çš„Pageç»“æ„è¢«æ„å»ºå®Œæˆçš„æ—¶å€™ï¼Œ æ›´æ–°åŸæœ‰B-Treeçš„æŒ‡é’ˆï¼Œ æŒ‡å‘æ–°çš„Pageå³å¯:\nè¿™ç§æ–¹å¼æ— ç–‘æ˜¯å¢åŠ äº†ç£ç›˜ç©ºé—´çš„æ¶ˆè€—ï¼Œ å¥½å¤„æœ‰:\né¿å…äº†latchçš„ä½¿ç”¨ è¯»å†™äº’ä¸å½±å“ æ•°æ®åº“ç³»ç»Ÿä¹Ÿä¸ä¼šå¤„åœ¨ä¸€ç§è¢«æ±¡æŸ“çš„çŠ¶æ€(æ— éå°±æ˜¯æ–°çš„é¡µçš„pointeræ²¡æœ‰æ›¿æ¢æ‰è€çš„ï¼Œ ä½†æ˜¯åŸæ¥çš„æ ‘ç»“æ„å’Œæ•°æ®è¿˜æ˜¯å®Œæ•´çš„ï¼Œ åªæ˜¯è¿‡æ—¶äº†è€Œå·²) Lazy B-Trees lazy B-Treeä¸»è¦æ—¶é€šè¿‡ç»“åˆå†…å­˜æˆ–è€…è¯´ä¼˜åŒ–page cacheçš„æ–¹å¼ï¼Œ å‡å°‘ç£ç›˜è®¿é—®ã€‚ä»¥mongodbç§ä½¿ç”¨çš„é»˜è®¤å­˜å‚¨å¼•æ“WiredTigerä¸ºä¾‹ï¼ˆç®€ç§°WTï¼‰ WTé¦–å…ˆä¼šä¿ç•™ä¸€ä»½ç£ç›˜ç§çš„æ ‘ç»“æ„ï¼Œ å½“ç„¶åªæ˜¯Indexï¼Œ å¹¶æ²¡æœ‰å…·ä½“çš„æ•°æ®ã€‚å½“æŸä¸ªpageé¦–æ¬¡è¢«è¯»å–çš„æ—¶å€™ï¼Œè¿™ä¸ªpageçš„å†…å®¹ä¼šå¤åˆ¶åˆ°åˆ°å¯¹åº”çš„update buffersï¼Œ ç”¨æˆ·å¯ä»¥è¢«å…è®¸ç›´æ¥è®¿é—®update buffersä¸­çš„æ•°æ®ï¼ˆè¿˜æ²¡è¢«å†™å…¥ç£ç›˜ï¼‰ï¼Œ åå¤©ç¨‹åºä¼šå‘¨æœŸæ€§åœ°å°†update bufferæ•°æ®å†™å…¥åˆ°ç£ç›˜å–è¦†ç›–åŸæ¥çš„Pageï¼Œ å¦‚æœè¦†ç›–é¡µçš„sizeå¤§äºåŸæ¥çš„sizeï¼Œ å®ƒä¼šæ‹†åˆ†æˆå¤šä¸ªé¡µ FD-Tree FD-Treeç»“åˆäº†B+treeå’ŒLSMæ ‘çš„ç‰¹å¾ï¼ˆæ ¸å¿ƒç‰¹ç‚¹å°±æ˜¯ä»éšæœºç£ç›˜å†™å…¥-\u0026gt;é¡ºåºå†™å…¥ï¼‰ã€‚ å®ƒåœ¨æœ€é¡¶å±‚ï¼ˆä¹Ÿç§°ä¸ºL0ï¼‰ä¼šç»´æŠ¤ä¸€é¢—æ ‘ï¼Œ L0åœ¨æ— æ³•å­˜å‚¨æ›´å¤škeyçš„æ—¶å€™ï¼Œ ä¼šæŠŠkeyèåˆåˆ°ä¸‹ä¸€å±‚ï¼ˆä¸æ˜¯æ‰€æœ‰keyï¼Œ è€Œæ˜¯ç‰¹æ®Šçš„keyï¼Œ ä¹Ÿè¢«ç§°ä¸ºfence, è¿™äº›fenceä¼šæœ‰ä¸€ä¸ªæŒ‡å‘ä¸‹ä¸€å±‚çš„Pointer ä¸Šå›¾æ˜¯FD-Treeçš„ä¸€ä¸ªæ ·ä¾‹ï¼Œå¯ä»¥çœ‹åˆ°æœ€çš„é¡¶å±‚ï¼ˆL0ï¼‰æ˜¯ä¸€ä¸ªæ ‘ç»“æ„ï¼Œ ç„¶åç°è‰²çš„æ–¹æ¡†å°±æ˜¯ç‰¹æ®Šçš„Index entryï¼Œ æŒ‡å‘ä¸‹ä¸€levelçš„arrayçš„ç›¸åŒentry, ä½†æ˜¯fenceä¹Ÿæœ‰å¼€é‚£ä¸ªä¸­ç±»å‹ï¼Œ ä¸€ç§æ˜¯externalï¼Œ è¿™ç§ç±»å‹ä¼šè¢«mergeåˆ°ä¸‹ä¸€å±‚ï¼ˆä¹Ÿå°±æ˜¯ä¸‹ä¸€å±‚ä¼šæœ‰ä¸€ä¸ªç›¸åŒçš„entryï¼‰ï¼Œ å¦å¤–ä¸€ç§æ˜¯internalï¼ˆæ¯”å¦‚ä¸Šé¢çš„88ï¼‰ï¼Œ ä½ ä¼šå‘ç°å®ƒåªå‡ºç°åœ¨L1æ²¡æœ‰å‡ºç°åœ¨L2. FD-Treeçš„æŸ¥æ‰¾å¤æ‚åº¦ä¹Ÿæ˜¯Logæ•°é‡çº§\nç¬¬ä¸ƒç«  å‰é¢ä¸€ç« ï¼Œ å¯¹æ•°æ®åº“ä¼˜åŒ–æ–¹å‘ä¸»è¦å›´ç»•å‡å°‘ç£ç›˜å†™å…¥å¼€é”€çš„æ¥çš„ï¼Œ ä»¥WiredTigerä¸ºä¾‹çš„æ–¹æ³•ï¼Œ éƒ½æ˜¯é€šè¿‡æ•°æ®çš„ç¼“å­˜ç®¡ç†æ¥å®ç°ä¸Šé¢è¿™ç›®æ ‡ï¼Œ è¿˜æœ‰ä¸€ç§ä¼˜åŒ–çš„æ–¹å‘ï¼Œ å°±æ˜¯æŠŠè€—æ—¶çš„ç£ç›˜éšæœºå†™å…¥æ“ä½œè½¬åŒ–ä¸ºç£ç›˜çš„é¡ºåºå†™å…¥ï¼Œ LSM-Treeå°±æ˜¯è¿™ç§æ€æƒ³çš„é›†å¤§æˆè€…ã€‚ LSM-Treeï¼Œ å…¨ç§°log structed mergeï¼Œ è¿™ä¸ªåå­—æœ¬èº«å°±æ˜­ç¤ºäº†è¿™ç§å­˜å‚¨ç»“æ„çš„ç‰¹å¾ï¼š\nlog structureï¼š åƒæ—¥å¿—ä¸€æ ·åªä¼šåœ¨ç£ç›˜ä¸­è¿½åŠ å†™å…¥(append only) mergeï¼Œ ä¸åœ¨ç£ç›˜ä¸­åˆ æ”¹æ•°æ®ï¼Œ é€šè¿‡mergeæ¥åº”å¯¹ä¸åŒç‰ˆæœ¬æ•°æ®çš„é—®é¢˜ LSMæ ‘ç”±äºappend onlyçš„ç‰¹å¾ï¼Œ æ‰€ä»¥è¿™ç§ç»“æ„æ˜¯éå¸¸é€‚åˆå†™å¤šäºè¯»çš„åœºæ™¯ï¼ˆååé‡ingestionè¾ƒé«˜çš„åœºæ™¯ï¼‰ï¼Œ å¦å¤–ç”±äºè¯»å†™åœ¨ç»“æ„ä¸Šäº’ä¸å½±å“ï¼Œ æ‰€ä»¥ä¸ä¼šå—ç±»ä¼¼B-treeçš„é”æœºåˆ¶å½±å“å¹¶å‘æ€§èƒ½\nLSMçš„æ„æˆ Memtable(ä¸‹é¢ä¸¤ä¸ªéƒ½ç®—æ˜¯memetable, å‰è€…æ¥å—å†™ï¼Œ åè€…åªæ¥å—è¯»ï¼‰ï¼Œ åœ¨å†…å­˜ä¸­ Current memtable Fushing memtable On-disk flush target Flush tables Compacting tables Compated tabe ä¸Šå›¾æ˜¾ç¤ºäº†LSMçš„æ•´ä¸ªç”Ÿå‘½å‘¨æœŸï¼Œå…¶ä¸­é™¤äº†Current MemtableåŒæ—¶æ”¯æŒè¯»å†™ä»¥å¤–ï¼Œ å…¶ä»–çš„é˜¶æ®µåªæ”¯æŒè¯»æ•°æ®ï¼Œ ä¸æ”¯æŒæ•°æ®çš„å†™å…¥ å¦å¤–æœ‰ä¸¤ä¸ªè¦ç‚¹ï¼š\næ•°æ®åœ¨å†…å­˜ä¸­çš„æ—¶å€™ï¼Œ å®ƒæ˜¯æ’è¿‡åºçš„ æ•°æ®åœ¨è¢«å†™å…¥ç£ç›˜çš„æ—¶å€™ï¼Œ ä¹Ÿä¼šç”¨çš„WALï¼Œ é˜²æ­¢æ•°æ®ä¸¢å¤± å½“æ•°æ®è¢«å†™å…¥ç£ç›˜ä¹‹åï¼Œ å†…å­˜ä¸­çš„æ•°æ®å°±ä¼šæ¶ˆå¤±ï¼Œ é‚£ä¹ˆåç»­ç›¸å…³æ•°æ®çš„æŸ¥è¯¢ä¹‹æ¶èƒ½é€šè¿‡ç£ç›˜ä¸­çš„æ•°æ®è·å– LSMä¸­çš„æ›´æ–°å’Œåˆ é™¤ æ›´æ–°çš„è¯å¾ˆç®€å•ï¼Œ åªè¦å†™å…¥æ–°çš„æ•°æ®å°±å¥½ï¼Œ æ–°çš„æ•°æ®ä¼šåœ¨åä¹°ä½ è¦†ç›–æ—§æ•°æ®ï¼Œé—®é¢˜åœ¨äºå¦‚ä½•åˆ é™¤æ•°æ®ã€‚ç”±äºæˆ‘ä»¬ä¸ä¼šç›´æ¥åˆ é™¤LSMå­˜å‚¨åœ¨ç£ç›˜çš„æ•°æ®ï¼Œ å¦‚æœä¸€ä¸ªæ•°æ®åŒæ—¶å­˜å‚¨åœ¨Memtableå’ŒDisk tableçš„æƒ…å†µä¸‹ï¼Œ æˆ‘å¦‚ä½•åœ¨ä¸ç›´æ¥åˆ é™¤Disk tableçš„æ•°æ®æ¥å®ç°åˆ é™¤å‘¢ã€‚ å¸¸ç”¨çš„æ–¹æ³•å°±æ˜¯ä¸ºè¿™ä¸ªéœ€è¦è¢«åˆ é™¤çš„keyè®¾ç½®ä¸€ä¸ªtomestoneï¼ˆå¢“ç¢‘ï¼‰ï¼Œ è¿™æ ·åœ¨mergeçš„æ—¶å€™ï¼Œè€çš„æ•°æ®ä¼šè¢«tomestoneè¦†ç›–æ‰ï¼Œ å°±è¾¾åˆ°äº†åˆ é™¤çš„æ•ˆæœ\nLSMä¸­çš„mergeæ“ä½œ å› ä¸ºæ•°æ®ä¼šè¢«å­˜å‚¨åœ¨å¤šä¸ªç£ç›˜åŒºåŸŸï¼Œ å¾ˆæœ‰å¯èƒ½å¤šä¸ªdisk tableè¿™é—´ä¼šæœ‰æ•°æ®å†²çªçš„é—®é¢˜ï¼Œ å³å®ƒä»¬éƒ½ä¿æœ‰ç›¸åŒkeyçš„æ•°æ®ï¼Œ æ‰€ä»¥éœ€è¦é€šè¿‡mergeæ¥è§£å†³å†²çª æ•´ä¸ªæµç¨‹åˆ’åˆ†ä¸ºä¸€ä¸‹ä¸‰ä¸ªæ­¥éª¤ï¼š\nä»ä¸åŒçš„è¿­ä»£å™¨(å°±æ˜¯å­˜å‚¨åœ¨ä¸åŒåŒºåŸŸçš„ç£ç›˜æ•°æ®ï¼Œ ä»–ä»¬æœ¬èº«æ˜¯sortedçš„ï¼Œ æ‰€ä»¥å¯ä»¥æ”¯æŒiteration)ä¾æ¬¡è·å–æ•°æ® æŠŠè¿™äº›å€™é€‰å€¼å…¥é˜Ÿï¼ˆä¼˜å…ˆé˜Ÿåˆ—ï¼Œå¯ä»¥é€šè¿‡min heapå°é¡¶å †æ¥å®ç°)ï¼Œ æœ€å°çš„é‚£ä¸ªå€¼æ”¾å…¥ç»“æœé›† ç»§ç»­ä»è¢«é€‰æ‹©çš„è¿­ä»£å™¨ä¸­è¡¥å……æ•°æ®åŠ å…¥é˜Ÿåˆ— é‡å¤ä¸Šé¢çš„æµç¨‹ï¼Œ å¦‚æœç¬¬äºŒä¸ªæµç¨‹é‡åˆ°keyç›¸åŒçš„æƒ…å†µï¼Œ å¯ä»¥é€‰æ‹©é€šè¿‡è®°å½•æœ¬èº«æºå¸¦çš„timestampeæ¥è§£å†³å†²çª\nLSMä¸­çš„å‹ç¼©(compact) å¸¸ç”¨çš„æ–¹æ³•æœ‰Leveled compactionå’ŒSize-tiered è¿™é‡Œä»¥Leveled ä¸ºä¾‹ï¼Œ ä½äºé¡¶å±‚(æ¥è¿‘0)çš„tableä¼šå°†æ•°æ®ä¸æ–­â€œä¸‹æ²‰â€ åˆ°ä¸‹ä¸€ä¸ªlevelï¼ˆå‰ææ˜¯å½“å‰çš„levelæ”¾ä¸ä¸‹æ›´å¤štableäº†ï¼‰ï¼Œ è¿™ä¸ªè¿‡ç¨‹ä¼šå¯¹keyçš„èŒƒå›´é‡åˆçš„tableè¿›è¡Œèåˆ\næ¯”å¦‚level 1 å’Œ Level 2ä¸­çš„é˜´å½±éƒ¨åˆ†ï¼Œ å®ƒä»¬key range é‡åˆäº†ï¼Œ æ‰€ä»¥éœ€è¦èåˆã€‚ èåˆçš„ç»“æœå°±æ˜¯ï¼Œ ä¸Šé¢çš„æ•°æ®ï¼Œ ä¹Ÿå°±æ˜¯æ–°çš„æ•°æ®åœ¨è§‚æ„Ÿä¸Šä¼šä¸€ç‚¹ç‚¹åœ°â€œä¸‹æ²‰â€åˆ°ä¸‹ä¸€ä¸ªlevelã€‚ å¦å¤–ï¼Œ é€šå¸¸æ¥è¯´ä¸‹ä¸€å±‚çš„Levelä¼šä¿ç•™ä¸Šä¸€å±‚2å€å·¦å³çš„å¤§å°\nLSMçš„è¯»/å†™/ç©ºé—´æ”¾å¤§ æˆ‘ä»¬ä¼˜åŒ–æ•°æ®çš„ç›®æ ‡å…¶å®å°±æ˜¯è§£å†³å†™æ”¾å¤§ï¼Œ è¯»æ”¾å¤§ä»¥åŠç©ºé—´æ”¾å¤§çš„é—®é¢˜ï¼š\nè¯»æ”¾å¤§ï¼šéœ€è¦è¯»å–å¤šä¸ªåœ°å€æ¥è·å–æ•°æ®, LSMä¼šæœ‰è¿™ä¸ªé—®é¢˜ å†™æ”¾å¤§ï¼š éœ€è¦å¤§é‡çš„é‡å†™æ“ä½œï¼Œ Bæ ‘æœ‰è¿™ä¸ªé—®é¢˜ï¼Œ åœ¨æ¶‰åŠåˆ°pageå±‚é¢çš„æ•°æ®å¢åˆ çš„æ—¶å€™ï¼Œ LSMçš„compacté˜¶æ®µå…¶å®ä¹Ÿæœ‰ ç©ºé—´æ”¾å¤§ï¼š LSMä¼šæœ‰å†—ä½™æ•°æ®ï¼Œ æ‰€ä»¥è¿™ä¸ªå¾ˆæ˜æ˜¾æ˜¯æœ‰çš„ æœ‰ä¸€ç§æŒ‡æ ‡RUM conjectionï¼ˆRUMåˆ†åˆ«ä»£è¡¨readï¼Œupdateä»¥åŠmemeoryï¼‰å¯ä»¥è¢«ç”¨æ¥æ¯”è¾ƒåŠè¡¡é‡ä¸€ä¸ªæ•°æ®åº“å¼•æ“çš„ç»¼åˆæ€§èƒ½ã€‚æˆ‘ä»¬éœ€è¦äº†è§£çš„æ˜¯ï¼Œ é€šå¸¸æ¥è¯´ï¼Œ è§£å†³ä¸Šé¢ä¸­çš„ä»»ä¸€ä¸€ä¸ªé—®é¢˜ï¼Œ éƒ½éœ€è¦ä»˜å‡ºå…¶ä»–ä¸¤ä¸ªç‚¹ä¸­çš„1ä¸ªæˆ–2ä¸ªä½œä¸ºä»£ä»·ï¼Œ æœ‰ç‚¹ç±»ä¼¼äºåˆ†å¸ƒå¼ç†è®ºä¸­çš„CAPç†è®ºï¼Œ ä½ ä»¬å¾ˆéš¾åŒæ—¶æ‹¥æœ‰æ‰€æœ‰å¥½å¤„\nLSM å®ç°ç»†èŠ‚ SSTable(sorted string table) LSMæ ‘ä¸­çš„tableæ˜¯åŸºäºSSTableå®ç°çš„\nSSTä¹Ÿä¼šç”¨åˆ°hashè¡¨ï¼Œ ä½†æ˜¯æ˜¯ä¸€ä¸ªç¨€ç–çš„hashè¡¨ï¼Œ åªè®°å½•äº†éƒ¨åˆ†keyå’Œå®ƒä»¬çš„ä½ç½®ï¼ˆoffsetï¼‰ï¼Œ æ•°æ®æœ¬èº«æ˜¯ä»¥keyå’Œvalueè¿ç»­å­˜å‚¨åœ¨ç£ç›˜ä¸Šçš„\nBloom filter LSMå­˜åœ¨çš„ä¸€ä¸ªæ€§èƒ½ç“¶é¢ˆå°±æ˜¯è¯»æ”¾å¤§ï¼Œ å°±æ˜¯å®ƒçš„æ•°æ®å­˜å‚¨åœ¨å¤šä¸ªtableï¼Œ å¦‚æœå­˜åœ¨ä¸€ä¸ªkeyï¼Œ åœ¨æ‰€æœ‰çš„æ•°æ®æ–‡ä»¶ä¸­å¹¶ä¸å­˜åœ¨ï¼Œ å®ƒä¾ç„¶éœ€è¦å–è¯»æ‰€æœ‰çš„æ–‡ä»¶ï¼Œ ä»è€Œæˆä¸ºæ€§èƒ½ç“¶é¢ˆï¼Œ æ‰€ä»¥å¯ä»¥ä½¿ç”¨Bloom filteræ¥è¿‡æ»¤æ‰ä¸å­˜åœ¨çš„keyï¼Œ ä»Šå„¿å‡å°‘è¯»æ”¾å¤§å¼•èµ·çš„æ€§èƒ½é—®é¢˜\nSkiplist å°†æ–‡ä»¶é¡ºåºåœ°å­˜å‚¨åœ¨å†…å­˜çš„ä¸€ç§æ–¹å¼å°±æ˜¯ä½¿ç”¨skiplist\nUnordered LSM Storage ä¸€ä¸€èˆ¬æ¥è¯´lsmçš„æ•°æ®éƒ½æ˜¯ä»¥æœ‰åºåœ°å½¢å¼è¢«å­˜å‚¨çš„ï¼Œ å½“ç„¶ä¹Ÿæœ‰å¹¶ä¸æ˜¯æœ‰åºå½¢å¼å­˜å‚¨çš„ç»“æ„\nBitcask bitcaskä¼šåœ¨å†…å­˜ä¸­ä¿ç•™ä¸€ä»½keyçš„æœ€æ–°è·¯å¾„çš„hashè¡¨(Keydir), keydirä¼šåœ¨æ•°æ®åº“åˆå§‹è¯çš„æ—¶å€™è¢«åŠ è½½åˆ°å†…å­˜ï¼Œ æ‰€ä»¥å¾ˆè‡ªç„¶åœ°ä¼šå¯¼è‡´åˆå§‹åŒ–æ—¶é—´è¿‡é•¿çš„é—®é¢˜ï¼Œ åŒæ—¶ç”±äºæ•°æ®æ˜¯ç›´æ¥è¢«è¿½åŠ åˆ°ç£ç›˜çš„ï¼Œ å¹¶ä¸æ˜¯æœ‰åºï¼ˆä¹Ÿæ²¡æœ‰ä»€ä¹ˆmemtableï¼‰ï¼Œ æ‰€ä»¥bitcaskä¹Ÿä¸æ”¯æŒèŒƒå›´æŸ¥è¯¢ï¼ˆrange query)ã€‚ ä½†æ˜¯å®ƒçš„ä¼˜åŠ¿ä¹Ÿå¾ˆæ˜æ˜¾ï¼Œ é¦–å…ˆç‚¹æŸ¥è¯¢éå¸¸å¿«ï¼Œ åŒæ—¶å†™å…¥æ•°æ®æ˜¯ç›´æ¥è¿½åŠ çš„æ‰€ä»¥å†™å…¥æ€§èƒ½ä¹Ÿå¾ˆå¥½\nWisckey wisckeyä¼šå°†indexå’Œæ•°æ®è®°å½•åˆ†å¼€è®°å½•ï¼ˆSSTï¼Œ keyå’Œvalueæ˜¯å­˜å‚¨åœ¨ä¸€èµ·çš„ï¼‰ï¼Œ åˆ†åˆ«å­˜å‚¨åœ¨index lsm treeå’Œvlog filesã€‚ vlogs filesç±»ä¼¼bitcaskï¼Œ æ˜¯æ— åºåœ°ï¼Œ é¡ºåºå¢åŠ çš„æ—¥å¿—æ–‡ä»¶index lsm treeä¿ç•™äº†æŒ‡å‘vLogçš„æŒ‡é’ˆï¼Œ æ‰€ä»¥å®ƒå¯ä»¥ä¿ç•™äº†èŒƒå›´æŸ¥è¯¢çš„ä¼˜ç‚¹ å®ƒçš„ç¼ºç‚¹æ˜¯ï¼Œ æœ‰åºvlogæ²¡æœ‰å…³äºæ•°æ®çš„lç”Ÿå‘½å‘¨æœŸçš„ä¿¡æ¯(liveness, ä¹Ÿå°±æ˜¯æ•°æ®æ˜¯ä¸æ˜¯ä»ç„¶æ˜¯æœ‰æ•ˆçš„)ï¼Œ æ‰€ä»¥åœ¨åƒåœ¾å›æ”¶çš„æ—¶å€™ï¼Œ å¿…é¡»è¦éå†å·¦ä¾§çš„index treeï¼Œ å¢åŠ äº†å¤æ‚åº¦ã€‚ ä¼ ç»Ÿçš„lsmï¼Œ å“ªæ€•æ˜¯è¢«åˆ é™¤çš„æ•°æ®ï¼Œ ä¹Ÿå¯ä»¥åœ¨æ•°æ®å‹ç¼©é˜¶æ®µè¢«ç›´æ¥è¦†ç›–(å‰é¢æåˆ°çš„ç±»ä¼¼å¢“ç¢‘çš„æ ‡è®°)\n","date":"2023-12-29T00:00:00Z","permalink":"https://superjcd.github.io/p/database-internal%E9%98%85%E8%AF%BB%E7%AC%94%E8%AE%B0%E4%B8%8A/","title":"Database Internalé˜…è¯»ç¬”è®°(ä¸Š)"}]